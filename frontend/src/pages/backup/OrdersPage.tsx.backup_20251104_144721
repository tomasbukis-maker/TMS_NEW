import React, { useState, useEffect, useCallback, useMemo, useRef } from 'react';
import { useLocation, useNavigate } from 'react-router-dom';
import { api } from '../services/api';
import { useAuth } from '../context/AuthContext';
import AutocompleteTextarea from '../components/AutocompleteTextarea';
import AutocompleteField from '../components/AutocompleteField';
import './OrdersPage.css';

interface Contact {
  id: number;
  first_name: string;
  last_name: string;
  email: string;
  phone: string;
  position?: string;
  notes?: string;
}

interface Client {
  id: number;
  name: string;
  code: string;
  vat_code?: string;
  address?: string;
  is_client?: boolean;
  is_supplier?: boolean;
  status?: string;
  status_display?: string;
  contact_person?: Contact | null;
  contacts?: Contact[];
  payment_term_days?: number;
  notes?: string;
}

interface User {
  id: number;
  username: string;
}

interface OtherCost {
  description: string;
  amount: number;
}

interface PVMRate {
  id: number;
  rate: string;
  article: string;
  is_active: boolean;
  sequence_order: number;
}

interface Order {
  id: number;
  order_number?: string | null;
  client: Client;
  client_id: number;
  carrier: Client | null;
  carrier_id: number | null;
  order_type: string;
  order_type_display: string;
  manager: User | null;
  manager_id: number | null;
  status: string;
  status_display: string;
  price_net: string;
  client_price_net: string | null;
  my_price_net?: string | number | null;
  other_costs?: OtherCost[];
  transport_warehouse_cost?: string | number;
  other_costs_total?: string | number;
  calculated_client_price_net?: string | number;
  vat_rate: string;
  vat_rate_article?: string;
  price_with_vat: string;
  vat_amount: string;
  client_price_with_vat: string | null;
  client_vat_amount: string | null;
  carrier_price_with_vat: string | null;
  carrier_vat_amount: string | null;
  client_invoice_issued: boolean;
  client_invoice_received: boolean;
  route_from: string;
  route_to: string;
  route_from_country: string;
  route_from_postal_code: string;
  route_from_city: string;
  route_from_address: string;
  route_to_country: string;
  route_to_postal_code: string;
  route_to_city: string;
  route_to_address: string;
  order_date: string | null;
  loading_date: string | null;
  unloading_date: string | null;
  is_partial?: boolean;
  weight_kg?: string | number | null;
  ldm?: string | number | null;
  length_m?: string | number | null;
  width_m?: string | number | null;
  height_m?: string | number | null;
  is_palletized?: boolean;
  is_stackable?: boolean;
  vehicle_type?: string | null;
  vehicle_type_display?: string | null;
  requires_forklift?: boolean;
  requires_crane?: boolean;
  requires_special_equipment?: boolean;
  fragile?: boolean;
  hazardous?: boolean;
  temperature_controlled?: boolean;
  requires_permit?: boolean;
  notes: string;
  created_at: string;
  client_payment_status: 'not_paid' | 'partially_paid' | 'paid';
  client_payment_status_display: string;
  carriers?: OrderCarrier[];
  cargo_items?: CargoItem[];
  first_sales_invoice?: {
    id: number;
    invoice_number: string;
    invoice_type: string;
    amount_total: string;
    issue_date: string | null;
  } | null;
  sales_invoices_count?: number;
  has_overdue_invoices?: boolean;
  payment_status_info?: {
    status: 'not_paid' | 'partially_paid' | 'paid' | 'overdue';
    message: string;
    has_invoices: boolean;
    invoice_issued?: boolean;
    payment_date?: string;
    overdue_days?: number;
  };
}

interface CargoItem {
  id?: number;
  order?: number;
  sequence_order: number;
  description?: string;
  weight_kg?: string | number | null;
  ldm?: string | number | null;
  length_m?: string | number | null;
  width_m?: string | number | null;
  height_m?: string | number | null;
  is_palletized?: boolean;
  is_stackable?: boolean;
  vehicle_type?: string | null;
  requires_forklift?: boolean;
  requires_crane?: boolean;
  requires_special_equipment?: boolean;
  fragile?: boolean;
  hazardous?: boolean;
  temperature_controlled?: boolean;
  requires_permit?: boolean;
  created_at?: string;
  updated_at?: string;
}

interface OrderCarrier {
  id?: number;
  order?: number;
  partner: Client;
  partner_id: number;
  carrier_type: 'carrier' | 'warehouse';
  carrier_type_display: string;
  sequence_order: number;
  price_net: string | null;
  price_with_vat: string | null;
  vat_amount: string | null;
  route_from: string;
  route_to: string;
  loading_date: string | null;
  unloading_date: string | null;
  status: 'new' | 'in_progress' | 'completed' | 'cancelled';
  status_display: string;
  invoice_issued: boolean;
  invoice_received: boolean;
  invoice_received_date?: string | null;
  payment_days?: number | null;
  due_date?: string | null;
  payment_status: 'not_paid' | 'partially_paid' | 'paid';
  payment_status_display: string;
  payment_date?: string | null;
  documents_status: 'not_received' | 'waiting' | 'received';
  documents_status_display: string;
  payment_status_info?: {
    status: 'not_paid' | 'partially_paid' | 'paid';
    message: string;
    payment_date?: string;
  };
  notes: string;
}

interface OrderStatusHistory {
  id: number;
  old_status: string;
  old_status_display?: string;
  new_status: string;
  new_status_display?: string;
  changed_by: User;
  notes: string;
  created_at: string;
}

interface PurchaseInvoice {
  id: number;
  invoice_number: string | null;
  received_invoice_number: string;
  partner: Client;
  partner_id: number;
  related_order: Order | null;
  related_order_id: number | null;
  expense_category: { id: number; name: string } | null;
  expense_category_id: number | null;
  payment_status: 'unpaid' | 'paid' | 'overdue' | 'partially_paid';
  payment_status_display: string;
  amount_net: string;
  vat_rate: string;
  amount_total: string;
  issue_date: string;
  received_date: string | null;
  due_date: string;
  payment_date: string | null;
  invoice_file: string | null;
  invoice_file_url?: string | null;
  overdue_days: number;
  notes: string;
  created_at: string;
  updated_at: string;
}

const OrdersPage: React.FC = () => {
  const { user } = useAuth();
  const location = useLocation();
  const navigate = useNavigate();
  const [orders, setOrders] = useState<Order[]>([]);
  const [totalOrdersCount, setTotalOrdersCount] = useState<number | null>(null);
  const [loading, setLoading] = useState(true);
  const [showCreateForm, setShowCreateForm] = useState(false);
  const [showEditForm, setShowEditForm] = useState(false);
  const [showOrderDetails, setShowOrderDetails] = useState(false);
  const [selectedOrder, setSelectedOrder] = useState<Order | null>(null);
  const [showRouteMap, setShowRouteMap] = useState(false);
  const [editingOrder, setEditingOrder] = useState<Order | null>(null);
  const [showStatusHistory, setShowStatusHistory] = useState<number | null>(null);
  const [statusHistory, setStatusHistory] = useState<OrderStatusHistory[]>([]);
  const [selectedOrderInvoices, setSelectedOrderInvoices] = useState<Array<{ id: number; invoice_number: string; issue_date: string | null; amount_total: string }>>([]);
  const [carrierPurchaseInvoices, setCarrierPurchaseInvoices] = useState<{ [carrierId: number]: Array<{ id: number; invoice_number: string | null; received_invoice_number: string; issue_date: string | null; amount_total: string }> }>({});
  const [showPurchaseInvoiceDetails, setShowPurchaseInvoiceDetails] = useState(false);
  const [selectedPurchaseInvoice, setSelectedPurchaseInvoice] = useState<PurchaseInvoice | null>(null);
  const [clientSearch, setClientSearch] = useState('');
  const [clients, setClients] = useState<Client[]>([]);
  const [selectedClientName, setSelectedClientName] = useState<string>('');
  const [selectedClient, setSelectedClient] = useState<Client | null>(null);
  const [filterStatus, setFilterStatus] = useState<string>('all');
  const [showFilters, setShowFilters] = useState<boolean>(false);
  // Išsaugoti pageSize localStorage, kad išliktų po perkrovimo
  // Pirmiausia bandyti localStorage, tada UserSettings
  const [pageSize, setPageSize] = useState<number>(() => {
    const saved = localStorage.getItem('ordersPageSize');
    if (saved) return parseInt(saved, 10);
    // Jei nėra localStorage, naudoti default 100
    return 100;
  });
  const [userSettingsLoaded, setUserSettingsLoaded] = useState(false);
  const [currentPage, setCurrentPage] = useState(1);
  const [totalPages, setTotalPages] = useState(1);
  const [filters, setFilters] = useState({
    status: [] as string[],
    client_id: '',
    carrier_id: '',
    order_type: '',
    route_from: '',
    route_to: '',
    order_date_from: '',
    order_date_to: '',
    loading_date_from: '',
    loading_date_to: '',
    unloading_date_from: '',
    unloading_date_to: '',
    manager_id: '',
  });
  const [allClients, setAllClients] = useState<Client[]>([]);
  const [allCarriers, setAllCarriers] = useState<Client[]>([]);
  const [allManagers, setAllManagers] = useState<User[]>([]);
  const [toast, setToast] = useState<{ type: 'success' | 'error' | 'info'; message: string; visible: boolean }>({ type: 'info', message: '', visible: false });
  const toastTimeoutRef = useRef<number | null>(null);
  const prevFiltersRef = useRef(filters);
  const prevFilterStatusRef = useRef(filterStatus);
  const prevPageSizeRef = useRef(pageSize);
  const showToast = useCallback((type: 'success' | 'error' | 'info', message: string, timeoutMs = 3500) => {
    setToast({ type, message, visible: true });
    if (toastTimeoutRef.current !== null) {
      window.clearTimeout(toastTimeoutRef.current);
    }
    toastTimeoutRef.current = window.setTimeout(() => setToast((t) => ({ ...t, visible: false })), timeoutMs);
  }, []);
  
  // Cleanup toast timeout on unmount
  useEffect(() => {
    return () => {
      if (toastTimeoutRef.current) {
        window.clearTimeout(toastTimeoutRef.current);
      }
    };
  }, []);
  const [confirmState, setConfirmState] = useState<{ 
    open: boolean; 
    title?: string; 
    message?: string; 
    onConfirm?: () => void;
    showDeleteOptions?: boolean;
    salesCount?: number;
    purchaseCount?: number;
    onDeleteWithInvoices?: () => void;
    onDeleteWithoutInvoices?: () => void;
  }>({ open: false });
  const [filterClientSearch, setFilterClientSearch] = useState('');
  const [filterCarrierSearch, setFilterCarrierSearch] = useState('');
  const [filterClients, setFilterClients] = useState<Client[]>([]);
  const [filterCarriers, setFilterCarriers] = useState<Client[]>([]);
  const [showFilterClientDropdown, setShowFilterClientDropdown] = useState(false);
  const [showFilterCarrierDropdown, setShowFilterCarrierDropdown] = useState(false);
  const [orderCarriers, setOrderCarriers] = useState<OrderCarrier[]>([]);
  const [editingCarrier, setEditingCarrier] = useState<OrderCarrier | null>(null);
  const [editingCarrierIndex, setEditingCarrierIndex] = useState<number | null>(null);
  const [showCarrierForm, setShowCarrierForm] = useState(false);
  const [carrierFormType, setCarrierFormType] = useState<'carrier' | 'warehouse'>('carrier');
  const [carrierPartnerSearch, setCarrierPartnerSearch] = useState('');
  const [carrierPartners, setCarrierPartners] = useState<Client[]>([]);
  const [selectedCarrierPartnerName, setSelectedCarrierPartnerName] = useState<string>('');
  const [routeFromSuggestions, setRouteFromSuggestions] = useState<string[]>([]);
  const [routeToSuggestions, setRouteToSuggestions] = useState<string[]>([]);
  const [showCarrierRouteFromSuggestions, setShowCarrierRouteFromSuggestions] = useState(false);
  const [showCarrierRouteToSuggestions, setShowCarrierRouteToSuggestions] = useState(false);
  const [vehicleTypeSuggestions, setVehicleTypeSuggestions] = useState<string[]>([]);
  const [cargoItems, setCargoItems] = useState<CargoItem[]>([]);
  const [editingCargoItem, setEditingCargoItem] = useState<CargoItem | null>(null);
  const [editingCargoItemIndex, setEditingCargoItemIndex] = useState<number | null>(null);
  const [showCargoItemForm, setShowCargoItemForm] = useState(false);
  const [pvmRates, setPvmRates] = useState<PVMRate[]>([]);

  // Form fields
  const [formData, setFormData] = useState({
    client_id: '',
    carrier_id: '',
    order_type: 'transport',
    manager_id: '',
    status: 'new',
    price_net: '',
    client_price_net: '',
    my_price_net: '',
    other_costs: [] as OtherCost[],
    vat_rate: '21',
    vat_rate_article: '',
    client_invoice_issued: false,
    client_invoice_received: false,
    client_payment_status: 'not_paid' as 'not_paid' | 'partially_paid' | 'paid',
    route_from: '',
    route_to: '',
    route_from_country: '',
    route_from_postal_code: '',
    route_from_city: '',
    route_from_address: '',
    route_to_country: '',
    route_to_postal_code: '',
    route_to_city: '',
    route_to_address: '',
    order_date: '',
    loading_date: '',
    unloading_date: '',
    is_partial: false,
    weight_kg: '',
    ldm: '',
    length_m: '',
    width_m: '',
    height_m: '',
    is_palletized: false,
    is_stackable: false,
    vehicle_type: '',
    requires_forklift: false,
    requires_crane: false,
    requires_special_equipment: false,
    fragile: false,
    hazardous: false,
    temperature_controlled: false,
    requires_permit: false,
    notes: '',
  });
  
  const [editingOtherCost, setEditingOtherCost] = useState<{ description: string; amount: string } | null>(null);
  const [editingOtherCostIndex, setEditingOtherCostIndex] = useState<number | null>(null);

  // eslint-disable-next-line @typescript-eslint/no-unused-vars
  const fetchPvmRates = useCallback(async () => {
    try {
      const response = await api.get('/settings/pvm-rates/?is_active=true');
      setPvmRates(response.data.results || response.data || []);
    } catch (error) {
    }
  }, []);

  // Funkcija, kuri automatiškai sukuria miestą, jei jo nėra
  const ensureCityExists = async (cityName: string): Promise<void> => {
    if (!cityName || !cityName.trim()) return;
    
    try {
      // Bandyti rasti esamą miestą
      const searchResponse = await api.get('/orders/cities/', {
        params: { search: cityName.trim() }
      });
      const existingCities = searchResponse.data.results || searchResponse.data || [];
      const exists = existingCities.some((city: any) => city.name.toLowerCase() === cityName.trim().toLowerCase());
      
      if (!exists) {
        // Sukurti naują miestą
        await api.post('/orders/cities/', { name: cityName.trim() });
      }
    } catch (error: any) {
      // Jei klaida, tikriausiai miestas jau egzistuoja (unique constraint)
        // Miestas jau egzistuoja arba klaida
    }
  };


  // eslint-disable-next-line @typescript-eslint/no-unused-vars
  const fetchAllClients = useCallback(async () => {
    try {
      const response = await api.get('/partners/partners/', {
        params: { is_client: true, page_size: 200 }
      });
      const clientsData = response.data.results || response.data || [];
      setAllClients(Array.isArray(clientsData) ? clientsData : []);
    } catch (error) {
      setAllClients([]);
    }
  }, []);

  // eslint-disable-next-line @typescript-eslint/no-unused-vars
  const fetchAllCarriers = useCallback(async () => {
    try {
      const response = await api.get('/partners/partners/', {
        params: { page_size: 200 }
      });
      const carriersData = response.data.results || response.data || [];
      setAllCarriers(Array.isArray(carriersData) ? carriersData : []);
    } catch (error) {
      setAllCarriers([]);
    }
  }, []);

  const searchFilterClients = useCallback(async (query: string) => {
    if (query.length < 1) {
      setFilterClients([]);
      return;
    }
    try {
      const response = await api.get('/partners/partners/', {
        params: { 
          search: query, 
          is_client: true, 
          page_size: 10 
        }
      });
      const clients = response.data.results || response.data || [];
      setFilterClients(Array.isArray(clients) ? clients : []);
    } catch (error) {
      setFilterClients([]);
    }
  }, []);

  const searchFilterCarriers = useCallback(async (query: string) => {
    if (query.length < 1) {
      setFilterCarriers([]);
      return;
    }
    try {
      const response = await api.get('/partners/partners/', {
        params: { 
          search: query, 
          page_size: 10 
        }
      });
      const carriers = response.data.results || response.data || [];
      setFilterCarriers(Array.isArray(carriers) ? carriers : []);
    } catch (error) {
      setFilterCarriers([]);
    }
  }, []);

  useEffect(() => {
    if (filterClientSearch) {
      const timeout = setTimeout(() => searchFilterClients(filterClientSearch), 300);
      return () => clearTimeout(timeout);
    } else {
      setFilterClients([]);
    }
  }, [filterClientSearch, searchFilterClients]);

  useEffect(() => {
    if (filterCarrierSearch) {
      const timeout = setTimeout(() => searchFilterCarriers(filterCarrierSearch), 300);
      return () => clearTimeout(timeout);
    } else {
      setFilterCarriers([]);
    }
  }, [filterCarrierSearch, searchFilterCarriers]);

  useEffect(() => {
    // Nustatyti kliento pavadinimą, kai pasirenkamas klientas
    if (filters.client_id) {
      const client = allClients.find(c => c.id.toString() === filters.client_id);
      if (client) {
        setFilterClientSearch(client.name);
      }
    }
  }, [filters.client_id, allClients]);

  useEffect(() => {
    // Nustatyti vežėjo pavadinimą, kai pasirenkamas vežėjas
    if (filters.carrier_id) {
      const carrier = allCarriers.find(c => c.id.toString() === filters.carrier_id);
      if (carrier) {
        setFilterCarrierSearch(carrier.name);
      }
    }
  }, [filters.carrier_id, allCarriers]);

  // eslint-disable-next-line @typescript-eslint/no-unused-vars
  const fetchAllManagers = useCallback(async () => {
    try {
      const response = await api.get('/auth/users/', {
        params: { page_size: 200 }
      });
      const managersData = response.data.results || response.data || [];
      setAllManagers(Array.isArray(managersData) ? managersData : []);
    } catch (error) {
      setAllManagers([]);
    }
  }, []);

  const fetchRouteSuggestions = async () => {
    try {
      // Gauti visus miestus/lokacijas iš API
      const citiesResponse = await api.get('/orders/cities/', {
        params: { page_size: 500 }
      });
      const cities = citiesResponse.data.results || citiesResponse.data || [];
      const cityNames = cities.map((city: any) => city.name).sort();
      
      setRouteFromSuggestions(cityNames);
      setRouteToSuggestions(cityNames);
      
      // Gauti visus mašinos tipus iš API
      const vehicleTypesResponse = await api.get('/orders/vehicle-types/', {
        params: { page_size: 500 }
      });
      const vehicleTypes = vehicleTypesResponse.data.results || vehicleTypesResponse.data || [];
      const vehicleTypeNames = vehicleTypes.map((type: any) => type.name).sort();
      
      setVehicleTypeSuggestions(vehicleTypeNames);
    } catch (error) {
    }
  };

  const fetchOrders = useCallback(async () => {
    setLoading(true);
    try {
      const params: any = { page_size: pageSize, page: currentPage };
      
      // Jei naudojami nauji filtrai
      if (filters.status.length > 0) {
        params.status__in = filters.status.join(',');
      } else if (filterStatus !== 'all') {
        params.status = filterStatus;
      }
      
      if (filters.client_id) {
        params.client = filters.client_id;
      }
      if (filters.carrier_id) {
        params.carrier = filters.carrier_id;
      }
      if (filters.order_type) {
        params.order_type = filters.order_type;
      }
      if (filters.route_from) {
        params.route_from = filters.route_from;
      }
      if (filters.route_to) {
        params.route_to = filters.route_to;
      }
      if (filters.order_date_from) {
        params.order_date__gte = filters.order_date_from;
      }
      if (filters.order_date_to) {
        params.order_date__lte = filters.order_date_to;
      }
      if (filters.loading_date_from) {
        params.loading_date__gte = filters.loading_date_from;
      }
      if (filters.loading_date_to) {
        params.loading_date__lte = filters.loading_date_to;
      }
      if (filters.unloading_date_from) {
        params.unloading_date__gte = filters.unloading_date_from;
      }
      if (filters.unloading_date_to) {
        params.unloading_date__lte = filters.unloading_date_to;
      }
      if (filters.manager_id) {
        params.manager = filters.manager_id;
      }
      
      const response = await api.get('/orders/orders/', { params });
      
      // Properly handle paginated and non-paginated responses
      let ordersList: Order[] = [];
      if (Array.isArray(response.data)) {
        ordersList = response.data;
        setTotalOrdersCount(ordersList.length);
        setTotalPages(1);
      } else if (response.data.results && Array.isArray(response.data.results)) {
        ordersList = response.data.results;
        // Išsaugoti total count ir apskaičiuoti puslapių skaičių
        if (response.data.count !== undefined) {
          setTotalOrdersCount(response.data.count);
          const calculatedTotalPages = Math.ceil(response.data.count / pageSize);
          setTotalPages(calculatedTotalPages);
        }
      } else if (response.data.data && Array.isArray(response.data.data)) {
        ordersList = response.data.data;
        setTotalOrdersCount(ordersList.length);
        setTotalPages(1);
      }
      
      setOrders(ordersList);
    } catch (error: any) {
      if (error.response?.status === 401) {
        showToast('info', 'Reikia prisijungti');
      } else {
        showToast('error', 'Klaida užkraunant užsakymus: ' + (error.response?.data?.detail || error.message || 'Nežinoma klaida'));
      }
      setOrders([]);
      setTotalOrdersCount(null);
    } finally {
      setLoading(false);
    }
  }, [filters, filterStatus, pageSize, currentPage, showToast]);

  // Automatinis persikrovimas pašalintas - vartotojas gali pats persikrauti, jei reikia

  // Gauti UserSettings ir nustatyti pageSize (jei nėra localStorage)
  useEffect(() => {
    const fetchUserSettings = async () => {
      try {
        const response = await api.get('/settings/user/my_settings/');
        if (response.data && response.data.items_per_page) {
          const savedPageSize = localStorage.getItem('ordersPageSize');
          // Jei nėra localStorage, naudoti UserSettings
          if (!savedPageSize) {
            const userPageSize = response.data.items_per_page;
            setPageSize(userPageSize);
            localStorage.setItem('ordersPageSize', userPageSize.toString());
          }
        }
        setUserSettingsLoaded(true);
      } catch (error) {
        // Ignoruoti klaidas
        setUserSettingsLoaded(true);
      }
    };
    fetchUserSettings();
  }, []);

  // Optimizuotas: sujungti mount ir filter changes į vieną useEffect
  const isFirstMount = useRef(true);
  useEffect(() => {
    if (isFirstMount.current && userSettingsLoaded) {
      // Pirmą kartą užkrovus puslapį - užkrauti visus duomenis (tik kai UserSettings užkrauti)
      isFirstMount.current = false;
      fetchOrders();
      fetchPvmRates();
      fetchRouteSuggestions();
      fetchAllClients();
      fetchAllCarriers();
      fetchAllManagers();
    } else if (!isFirstMount.current) {
      // Kai keičiasi filtrai - užkrauti tik užsakymus
      fetchOrders();
    }
  // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [filterStatus, filters, pageSize, userSettingsLoaded, currentPage]);
  
  // Reset currentPage į 1, kai keičiasi filtrai arba pageSize (bet ne currentPage)
  useEffect(() => {
    const filtersChanged = JSON.stringify(prevFiltersRef.current) !== JSON.stringify(filters);
    const filterStatusChanged = prevFilterStatusRef.current !== filterStatus;
    const pageSizeChanged = prevPageSizeRef.current !== pageSize;
    
    if ((filtersChanged || filterStatusChanged || pageSizeChanged) && currentPage !== 1) {
      setCurrentPage(1);
    }
    
    prevFiltersRef.current = filters;
    prevFilterStatusRef.current = filterStatus;
    prevPageSizeRef.current = pageSize;
  }, [filters, filterStatus, pageSize, currentPage]);

  // Handle URL parameter to open order details
  useEffect(() => {
    const params = new URLSearchParams(location.search);
    const orderId = params.get('order_id');
    
    if (orderId && orders.length > 0) {
      const order = orders.find(o => o.id === parseInt(orderId));
      if (order) {
        handleViewOrder(order);
        // Išvalyti URL
        navigate('/orders', { replace: true });
      }
    }
  // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [location.search, orders, navigate]);

  const searchClients = useCallback(async (query: string) => {
    if (query.length < 2) {
      setClients([]);
      return;
    }
    try {
      const response = await api.get('/partners/partners/', {
        params: { 
          search: query, 
          is_client: true, 
          page_size: 10 
        }
      });
      const clients = response.data.results || response.data || [];
      setClients(Array.isArray(clients) ? clients : []);
    } catch (error) {
      setClients([]);
    }
  }, []);

  useEffect(() => {
    // Nevykdyti paieškos, jei įvestas tekstas sutampa su pasirinkto kliento vardu
    if (clientSearch && clientSearch !== selectedClientName) {
      const timeout = setTimeout(() => searchClients(clientSearch), 300);
      return () => clearTimeout(timeout);
    } else if (!clientSearch) {
      setClients([]);
    }
  }, [clientSearch, selectedClientName, searchClients]);


  const handleClientSelect = async (client: Client) => {
    setFormData({ ...formData, client_id: client.id.toString() });
    setClientSearch(client.name);
    setSelectedClientName(client.name);
    setClients([]);
    
    // Gauti pilną kliento informaciją
    try {
      const response = await api.get(`/partners/partners/${client.id}/`);
      setSelectedClient(response.data);
    } catch (error) {
      // Jei nepavyko gauti pilnos informacijos, naudoti tai kas jau yra
      setSelectedClient(client);
    }
  };

  // Funkcija, kuri tikrina ir atnaujina kliento duomenis internete pagal PVM kodą
  const handleCheckClientOnline = async () => {
    if (!selectedClient) {
      showToast('info', 'Pasirinkite klientą');
      return;
    }

    const vatCode = selectedClient.vat_code?.trim();
    if (!vatCode) {
      showToast('info', 'Klientas neturi PVM kodo');
      return;
    }

    try {
      // Tikrinti internete pagal PVM kodą
      const res = await api.get('/partners/partners/resolve_name/', { params: { vat_code: vatCode } });
      const data = res.data;
      
      if (data.valid && data.name) {
        // Atnaujinti kliento duomenis duomenų bazėje
        await api.put(`/partners/partners/${selectedClient.id}/`, {
          name: data.name,
          address: data.address || selectedClient.address || '',
          code: selectedClient.code,
          vat_code: selectedClient.vat_code,
          payment_term_days: selectedClient.payment_term_days || 0,
          is_client: selectedClient.is_client || false,
          is_supplier: selectedClient.is_supplier || false,
          status: selectedClient.status || 'active',
          notes: selectedClient.notes || '',
        });
        
        // Atnaujinti selectedClient state su naujais duomenimis
        const refreshedResponse = await api.get(`/partners/partners/${selectedClient.id}/`);
        setSelectedClient(refreshedResponse.data);
        
        // Atnaujinti ir clientSearch, jei reikia
        setClientSearch(refreshedResponse.data.name);
        setSelectedClientName(refreshedResponse.data.name);
        
        showToast('success', 'Kliento duomenys sėkmingai patikslinti ir atnaujinti');
      } else {
        showToast('info', 'VIES nerado duomenų pagal šį PVM kodą');
      }
    } catch (error: any) {
      showToast('error', 'Nepavyko patikrinti internete: ' + (error.response?.data?.error || error.message));
    }
  };


  const handleCreateOrder = async (e: React.FormEvent) => {
    e.preventDefault();
    
    // Validacija
    if (!formData.client_id) {
      showToast('info', 'Pasirinkite klientą');
      return;
    }
    
    if (!formData.route_from_country || !formData.route_to_country) {
      showToast('info', 'Užpildykite šalų laukus (privalomi)');
      return;
    }
    
    try {
      const orderDataToSend = {
        client_id: parseInt(formData.client_id),
        order_type: formData.order_type,
        manager_id: formData.manager_id ? parseInt(formData.manager_id) : null,
        status: formData.status,
        price_net: (() => {
          // Bazinė kaina = Pervežimo/sandėliavimo + Mano kaina + Kitos išlaidos
          const transportCost = orderCarriers.reduce((sum, c) => sum + (c.price_net ? parseFloat(String(c.price_net)) : 0), 0);
          const myPrice = formData.my_price_net ? parseFloat(formData.my_price_net) : 0;
          const otherCosts = formData.other_costs.reduce((sum, c) => sum + (typeof c.amount === 'number' ? c.amount : parseFloat(String(c.amount)) || 0), 0);
          return (transportCost + myPrice + otherCosts) || 0;
        })(),
        client_price_net: formData.client_price_net ? parseFloat(formData.client_price_net) : null,
        my_price_net: formData.my_price_net && formData.my_price_net.trim() !== '' ? parseFloat(formData.my_price_net) : null,
        other_costs: formData.other_costs.length > 0 ? formData.other_costs.map(cost => ({
          description: cost.description,
          amount: parseFloat(String(cost.amount))
        })) : [],
        vat_rate: parseFloat(formData.vat_rate),
        vat_rate_article: formData.vat_rate_article || '',
        client_invoice_issued: formData.client_invoice_issued,
        client_invoice_received: formData.client_invoice_received,
        client_payment_status: formData.client_payment_status,
        route_from: formData.route_from || '',
        route_to: formData.route_to || '',
        route_from_country: formData.route_from_country || '',
        route_from_postal_code: formData.route_from_postal_code || '',
        route_from_city: formData.route_from_city || '',
        route_from_address: formData.route_from_address || '',
        route_to_country: formData.route_to_country || '',
        route_to_postal_code: formData.route_to_postal_code || '',
        route_to_city: formData.route_to_city || '',
        route_to_address: formData.route_to_address || '',
        order_date: formData.order_date || null,
        loading_date: formData.loading_date || null,
        unloading_date: formData.unloading_date || null,
        is_partial: formData.is_partial,
        weight_kg: formData.weight_kg ? parseFloat(formData.weight_kg) : null,
        ldm: formData.ldm ? parseFloat(formData.ldm) : null,
        length_m: formData.length_m ? parseFloat(formData.length_m) : null,
        width_m: formData.width_m ? parseFloat(formData.width_m) : null,
        height_m: formData.height_m ? parseFloat(formData.height_m) : null,
        is_palletized: formData.is_palletized,
        is_stackable: formData.is_stackable,
        vehicle_type: formData.vehicle_type || null,
        requires_forklift: formData.requires_forklift,
        requires_crane: formData.requires_crane,
        requires_special_equipment: formData.requires_special_equipment,
        fragile: formData.fragile,
        hazardous: formData.hazardous,
        temperature_controlled: formData.temperature_controlled,
        requires_permit: formData.requires_permit,
        notes: formData.notes || ''
      };
      
      const response = await api.post('/orders/orders/', orderDataToSend);
      const newOrderId = response.data.id;

      // AutocompleteField automatiškai išsaugo duomenis, nereikia rankiniu
      
      // Sukurti vežėjus/sandėlius
      if (orderCarriers.length > 0) {
        for (const carrier of orderCarriers) {
          try {
            // Užtikrinti, kad partner_id būtų nustatytas
            const partnerId = carrier.partner_id || carrier.partner?.id;
            if (!partnerId) {
              showToast('info', 'Klaida: vežėjas/sandėlys neturi partnerio ID. Praleidžiamas.');
              continue;
            }
            
            const carrierData = {
              order: newOrderId,
              partner_id: partnerId,
              carrier_type: carrier.carrier_type || 'carrier',
              sequence_order: carrier.sequence_order || 0,
              price_net: carrier.price_net ? parseFloat(String(carrier.price_net)) : null,
              route_from: carrier.route_from || '',
              route_to: carrier.route_to || '',
              loading_date: carrier.loading_date || null,
              unloading_date: carrier.unloading_date || null,
              status: carrier.status || 'new',
              invoice_issued: carrier.invoice_issued || false,
              invoice_received: carrier.invoice_received || false,
              payment_status: carrier.payment_status || 'not_paid',
              notes: carrier.notes || ''
            };
            await api.post('/orders/carriers/', carrierData);
          } catch (error: any) {
            const errorMsg = error.response?.data?.detail || 
                           (typeof error.response?.data === 'object' ? JSON.stringify(error.response?.data) : error.response?.data) ||
                           error.message;
            showToast('error', `Klaida kuriant vežėją/sandėlį: ${errorMsg}`);
            throw error;
          }
        }
      }

      // Sukurti krovinių aprašymus
      if (cargoItems.length > 0) {
        for (const cargoItem of cargoItems) {
          try {
            const cargoData = {
              order: newOrderId,
              sequence_order: cargoItem.sequence_order || 0,
              description: cargoItem.description || '',
              weight_kg: cargoItem.weight_kg ? parseFloat(String(cargoItem.weight_kg)) : null,
              ldm: cargoItem.ldm ? parseFloat(String(cargoItem.ldm)) : null,
              length_m: cargoItem.length_m ? parseFloat(String(cargoItem.length_m)) : null,
              width_m: cargoItem.width_m ? parseFloat(String(cargoItem.width_m)) : null,
              height_m: cargoItem.height_m ? parseFloat(String(cargoItem.height_m)) : null,
              is_palletized: cargoItem.is_palletized || false,
              is_stackable: cargoItem.is_stackable || false,
              vehicle_type: cargoItem.vehicle_type || null,
              requires_forklift: cargoItem.requires_forklift || false,
              requires_crane: cargoItem.requires_crane || false,
              requires_special_equipment: cargoItem.requires_special_equipment || false,
              fragile: cargoItem.fragile || false,
              hazardous: cargoItem.hazardous || false,
              temperature_controlled: cargoItem.temperature_controlled || false,
              requires_permit: cargoItem.requires_permit || false,
            };
            await api.post('/orders/cargo-items/', cargoData);
          } catch (error: any) {
            const errorMsg = error.response?.data?.detail || 
                           (typeof error.response?.data === 'object' ? JSON.stringify(error.response?.data) : error.response?.data) ||
                           error.message;
            showToast('error', `Klaida kuriant krovinių aprašymą: ${errorMsg}`);
            throw error;
          }
        }
      }
      
      setShowCreateForm(false);
      resetForm();
      fetchOrders();
      fetchRouteSuggestions(); // Atnaujinti maršrutų pasiūlymus
      showToast('success', 'Užsakymas sėkmingai sukurtas');
    } catch (error: any) {
      
      let errorMessage = 'Klaida kuriant užsakymą';
      if (error.response?.data) {
        if (typeof error.response.data === 'string') {
          errorMessage = error.response.data;
        } else if (error.response.data.error) {
          errorMessage = error.response.data.error;
        } else if (error.response.data.detail) {
          errorMessage = error.response.data.detail;
        } else if (typeof error.response.data === 'object') {
          // Format validation errors
          const validationErrors = Object.entries(error.response.data)
            .map(([key, value]: [string, any]) => {
              if (Array.isArray(value)) {
                return `${key}: ${value.join(', ')}`;
              }
              return `${key}: ${value}`;
            })
            .join('\n');
          errorMessage = `Validacijos klaidos:\n${validationErrors}`;
        }
      } else if (error.message) {
        errorMessage = error.message;
      }
      
      showToast('error', errorMessage);
    }
  };

  const handleEditOrder = async (order: Order) => {
    setEditingOrder(order);
    setShowEditForm(true);
    setShowCreateForm(false);
    
    // Užkrauti pasiūlymus, jei dar nėra užkrauti
    if (vehicleTypeSuggestions.length === 0) {
      await fetchRouteSuggestions();
    }
    
    setFormData({
      client_id: (order.client_id || order.client.id).toString(),
      carrier_id: order.carrier_id ? order.carrier_id.toString() : (order.carrier?.id ? order.carrier.id.toString() : ''),
      order_type: order.order_type,
      manager_id: (order.manager_id || order.manager?.id)?.toString() || '',
      status: order.status,
      price_net: order.price_net,
      client_price_net: order.client_price_net || '',
      my_price_net: order.my_price_net ? String(order.my_price_net) : '',
      other_costs: order.other_costs || [],
      vat_rate: order.vat_rate,
      vat_rate_article: order.vat_rate_article || '',
      client_invoice_issued: order.client_invoice_issued,
      client_invoice_received: order.client_invoice_received,
      client_payment_status: order.client_payment_status || 'not_paid',
      route_from: order.route_from || '',
      route_to: order.route_to || '',
      route_from_country: order.route_from_country || '',
      route_from_postal_code: order.route_from_postal_code || '',
      route_from_city: order.route_from_city || '',
      route_from_address: order.route_from_address || '',
      route_to_country: order.route_to_country || '',
      route_to_postal_code: order.route_to_postal_code || '',
      route_to_city: order.route_to_city || '',
      route_to_address: order.route_to_address || '',
      order_date: order.order_date ? (order.order_date.includes('T') ? order.order_date.split('T')[0] + 'T00:00' : order.order_date) : '',
      loading_date: order.loading_date ? (order.loading_date.includes('T') ? order.loading_date.split('T')[0] + 'T00:00' : order.loading_date) : '',
      unloading_date: order.unloading_date ? (order.unloading_date.includes('T') ? order.unloading_date.split('T')[0] + 'T00:00' : order.unloading_date) : '',
      is_partial: order.is_partial || false,
      weight_kg: order.weight_kg ? String(order.weight_kg) : '',
      ldm: order.ldm ? String(order.ldm) : '',
      length_m: order.length_m ? String(order.length_m) : '',
      width_m: order.width_m ? String(order.width_m) : '',
      height_m: order.height_m ? String(order.height_m) : '',
      is_palletized: order.is_palletized || false,
      is_stackable: order.is_stackable || false,
      vehicle_type: order.vehicle_type || '',
      requires_forklift: order.requires_forklift || false,
      requires_crane: order.requires_crane || false,
      requires_special_equipment: order.requires_special_equipment || false,
      fragile: order.fragile || false,
      hazardous: order.hazardous || false,
      temperature_controlled: order.temperature_controlled || false,
      requires_permit: order.requires_permit || false,
      notes: order.notes || '',
    });
    
    // Nustatyti kliento paieškos laukelį
    const clientName = order.client?.name || '';
    setClientSearch(clientName);
    setSelectedClientName(clientName);
    setClients([]); // Tuščias sąrašas, kad dropdown neatsidarytų
    
    // Užkrauti pilną kliento informaciją (darome asinchroniškai, kad neblokuotų formos užkrovimo)
    if (order.client_id) {
      api.get(`/partners/partners/${order.client_id}/`)
        .then(response => {
          setSelectedClient(response.data);
        })
        .catch(error => {
          // Jei nepavyko gauti, naudoti tai kas jau yra order.client objekte
          if (order.client) {
            setSelectedClient(order.client as Client);
          }
        });
    } else if (order.client) {
      // Jei nėra client_id, bet yra client objektas, naudoti jį
      setSelectedClient(order.client as Client);
    }
    
    // Užkrauti vežėjus/sandėlius
    if (order.carriers && order.carriers.length > 0) {
      setOrderCarriers(order.carriers.map(c => ({
        ...c,
        id: c.id, // Užtikrinti, kad id yra
        partner_id: c.partner_id || c.partner?.id, // Užtikrinti partner_id
        price_net: c.price_net ? (typeof c.price_net === 'string' ? c.price_net : String(c.price_net)) : null,
        route_from: c.route_from || '',
        route_to: c.route_to || '',
        loading_date: c.loading_date ? (c.loading_date.includes('T') ? c.loading_date.split('T')[0] + 'T00:00' : c.loading_date) : null,
        unloading_date: c.unloading_date ? (c.unloading_date.includes('T') ? c.unloading_date.split('T')[0] + 'T00:00' : c.unloading_date) : null,
        status: c.status || 'new',
        status_display: c.status_display || 'Naujas',
        payment_status: c.payment_status || 'not_paid',
        invoice_received_date: c.invoice_received_date || null,
        payment_days: c.payment_days || null,
        due_date: c.due_date || null,
        payment_status_display: c.payment_status_display || 'Neapmokėta',
        payment_date: c.payment_date || null,
        documents_status: c.documents_status || 'not_received',
        documents_status_display: c.documents_status_display || 'Negauta',
        payment_status_info: c.payment_status_info,
        invoice_issued: c.invoice_issued || false,
        invoice_received: c.invoice_received || false,
        notes: c.notes || ''
      })));
    } else {
      // Bandyti užkrauti iš API, jei nėra duomenų
      fetchOrderCarriers(order.id).then(carriers => {
        if (carriers.length > 0) {
          setOrderCarriers(carriers.map(c => ({
            ...c,
            id: c.id, // Užtikrinti, kad id yra
            partner_id: c.partner_id || c.partner?.id, // Užtikrinti partner_id
            price_net: c.price_net ? (typeof c.price_net === 'string' ? c.price_net : String(c.price_net)) : null,
            route_from: c.route_from || '',
            route_to: c.route_to || '',
            loading_date: c.loading_date || null,
            unloading_date: c.unloading_date || null,
            status: c.status || 'new',
            status_display: c.status_display || 'Naujas',
            payment_status: c.payment_status || 'not_paid',
            payment_status_display: c.payment_status_display || 'Neapmokėta',
            invoice_issued: c.invoice_issued || false,
            invoice_received: c.invoice_received || false,
            invoice_received_date: c.invoice_received_date || null,
            payment_days: c.payment_days || null,
            due_date: c.due_date || null,
            notes: c.notes || ''
          })));
        }
      });
    }
    
    // Užkrauti krovinių aprašymus
    if (order.cargo_items && order.cargo_items.length > 0) {
      setCargoItems(order.cargo_items.map((item: CargoItem) => ({
        ...item,
        sequence_order: item.sequence_order || 0
      })));
    } else {
      // Bandyti užkrauti iš API, jei nėra duomenų
      try {
        const cargoResponse = await api.get(`/orders/cargo-items/?order=${order.id}`);
        const cargoList = cargoResponse.data.results || cargoResponse.data || [];
        if (cargoList.length > 0) {
          setCargoItems(cargoList.map((item: CargoItem) => ({
            ...item,
            sequence_order: item.sequence_order || 0
          })));
        } else {
          setCargoItems([]);
        }
      } catch (error) {
        setCargoItems([]);
      }
    }
    
    setShowEditForm(true);
    
    // Užkrauti pasiūlymus, jei dar nėra užkrauti
    if (vehicleTypeSuggestions.length === 0) {
      fetchRouteSuggestions();
    }
  };

  const fetchOrderCarriers = async (orderId: number): Promise<OrderCarrier[]> => {
    try {
      const response = await api.get(`/orders/carriers/?order=${orderId}`);
      return response.data.results || response.data || [];
    } catch (error) {
      return [];
    }
  };

  const handleEditFromDetails = () => {
    if (selectedOrder) {
      handleEditOrder(selectedOrder);
      setShowOrderDetails(false);
    }
  };

  const searchCarrierPartners = useCallback(async (query: string) => {
    if (query.length < 2) {
      setCarrierPartners([]);
      return;
    }
    try {
      const response = await api.get('/partners/partners/', {
        params: { 
          search: query,
          page_size: 10 
        }
      });
      const partners = response.data.results || response.data || [];
      setCarrierPartners(Array.isArray(partners) ? partners : []);
    } catch (error) {
      setCarrierPartners([]);
    }
  }, []);

  useEffect(() => {
    // Nevykdyti paieškos, jei įvestas tekstas sutampa su pasirinkto partnerio vardu
    if (carrierPartnerSearch && carrierPartnerSearch !== selectedCarrierPartnerName) {
      const timeout = setTimeout(() => searchCarrierPartners(carrierPartnerSearch), 300);
      return () => clearTimeout(timeout);
    } else if (!carrierPartnerSearch) {
      setCarrierPartners([]);
    }
  }, [carrierPartnerSearch, selectedCarrierPartnerName, searchCarrierPartners]);

  const handleAddCarrier = (type: 'carrier' | 'warehouse') => {
    setCarrierFormType(type);
    setEditingCarrier(null);
    setEditingCarrierIndex(null);
    setCarrierPartnerSearch('');
    setSelectedCarrierPartnerName('');
    setCarrierPartners([]);
    setShowCarrierForm(true);
  };

  const handleCarrierPartnerSelect = (partner: Client) => {
    if (editingCarrier) {
      setEditingCarrier({
        ...editingCarrier,
        partner,
        partner_id: partner.id
      });
    } else {
      setEditingCarrier({
        partner,
        partner_id: partner.id,
        carrier_type: carrierFormType,
        carrier_type_display: carrierFormType === 'carrier' ? 'Vežėjas' : 'Sandėlys',
        sequence_order: orderCarriers.length,
        price_net: null,
        price_with_vat: null,
        vat_amount: null,
        route_from: '',
        route_to: '',
        loading_date: null,
        unloading_date: null,
        status: 'new',
        status_display: 'Naujas',
        invoice_issued: false,
        invoice_received: false,
        payment_status: 'not_paid',
        payment_status_display: 'Neapmokėta',
        payment_date: null,
        documents_status: 'not_received',
        documents_status_display: 'Negauta',
        notes: ''
      });
    }
    setCarrierPartnerSearch(partner.name);
    setSelectedCarrierPartnerName(partner.name);
    setCarrierPartners([]);
  };

  const handleSaveCarrier = async () => {
    if (!editingCarrier) {
      showToast('error', 'Pasirinkite partnerį');
      return;
    }
    
    // Užtikrinti, kad partner_id būtų nustatytas
    const partnerId = editingCarrier.partner_id || editingCarrier.partner?.id;
    if (!partnerId) {
      showToast('error', 'Pasirinkite partnerį');
      return;
    }
    
    try {
      // Sukurti atnaujintą carrier objektą su partner_id
      const updatedCarrier: OrderCarrier = {
        ...editingCarrier,
        partner_id: partnerId,
        sequence_order: editingCarrierIndex !== null && editingCarrierIndex >= 0 ? editingCarrierIndex : orderCarriers.length
      };
      
      // Jei vežėjas jau turi id (jau egzistuoja serveryje), atnaujinti tiesiogiai
      const orderId = editingOrder?.id || selectedOrder?.id;
      
      if (updatedCarrier.id && orderId) {
        try {
          const carrierData = {
            order: orderId,
            partner_id: partnerId,
            carrier_type: updatedCarrier.carrier_type || 'carrier',
            sequence_order: updatedCarrier.sequence_order || 0,
            price_net: updatedCarrier.price_net ? parseFloat(String(updatedCarrier.price_net)) : null,
            route_from: updatedCarrier.route_from || '',
            route_to: updatedCarrier.route_to || '',
            loading_date: updatedCarrier.loading_date || null,
            unloading_date: updatedCarrier.unloading_date || null,
            status: updatedCarrier.status || 'new',
            invoice_issued: updatedCarrier.invoice_issued || false,
            invoice_received: updatedCarrier.invoice_received || false,
            invoice_received_date: updatedCarrier.invoice_received_date || null,
            payment_days: updatedCarrier.payment_days || null,
            due_date: updatedCarrier.due_date || null,
            payment_status: updatedCarrier.payment_status || 'not_paid',
            payment_date: updatedCarrier.payment_date || null,
            documents_status: updatedCarrier.documents_status || 'not_received',
            notes: updatedCarrier.notes || ''
          };
          
          const response = await api.patch(`/orders/carriers/${updatedCarrier.id}/`, carrierData);
          showToast('success', 'Vežėjas sėkmingai atnaujintas');
          
          // Atnaujinti lokalų state
          let newCarriers: OrderCarrier[];
          if (editingCarrierIndex !== null && editingCarrierIndex >= 0 && editingCarrierIndex < orderCarriers.length) {
            newCarriers = [...orderCarriers];
            newCarriers[editingCarrierIndex] = { 
              ...updatedCarrier, 
              ...carrierData,
              price_net: carrierData.price_net !== null ? String(carrierData.price_net) : null
            };
          } else {
            newCarriers = [...orderCarriers];
          }
          setOrderCarriers(newCarriers);
          
          // Jei yra selectedOrder modalo, atnaujinti ir jį
          if (selectedOrder && selectedOrder.id === orderId) {
            const orderResponse = await api.get(`/orders/orders/${selectedOrder.id}/`);
            setSelectedOrder(orderResponse.data);
          }
          
          // Taip pat atnaujinti orderCarriers, jei yra selectedOrder.carriers
          if (selectedOrder && selectedOrder.carriers) {
            const updatedCarriers = selectedOrder.carriers.map((c: OrderCarrier) => 
              c.id === updatedCarrier.id ? { ...c, ...updatedCarrier } : c
            );
            setSelectedOrder({ ...selectedOrder, carriers: updatedCarriers });
          }
        } catch (error: any) {
          showToast('error', error.response?.data?.detail || error.response?.data?.error || 'Klaida atnaujinant vežėją');
          return;
        }
      } else {
        // Naujas vežėjas - tik lokalus state
        let newCarriers: OrderCarrier[];
        if (editingCarrierIndex !== null && editingCarrierIndex >= 0 && editingCarrierIndex < orderCarriers.length) {
          // Atnaujinti esamą pagal indeksą
          newCarriers = [...orderCarriers];
          newCarriers[editingCarrierIndex] = updatedCarrier;
        } else {
          // Pridėti naują
          newCarriers = [...orderCarriers, updatedCarrier];
        }
        
        setOrderCarriers(newCarriers);
        showToast('success', editingCarrierIndex !== null ? 'Vežėjas sėkmingai atnaujintas' : 'Vežėjas sėkmingai pridėtas');
      }
      
      setShowCarrierForm(false);
      setEditingCarrier(null);
      setEditingCarrierIndex(null);
      setCarrierPartnerSearch('');
      setSelectedCarrierPartnerName('');
      
      // Reset manual edit flag when carriers change, so my_price recalculates
      myPriceManuallyEdited.current = false;
      
      // Perskaičiuoti mano kainą naudojant naują carriers array
      const finalCarriers = updatedCarrier.id ? (editingCarrierIndex !== null && editingCarrierIndex >= 0 && editingCarrierIndex < orderCarriers.length ? 
        orderCarriers.map((c, i) => i === editingCarrierIndex ? updatedCarrier : c) : 
        [...orderCarriers, updatedCarrier]) : 
        (editingCarrierIndex !== null && editingCarrierIndex >= 0 && editingCarrierIndex < orderCarriers.length ? 
          orderCarriers.map((c, i) => i === editingCarrierIndex ? updatedCarrier : c) : 
          [...orderCarriers, updatedCarrier]);
      
      const clientPrice = formData.client_price_net ? parseFloat(formData.client_price_net) : 0;
      if (clientPrice > 0) {
        const transportCost = finalCarriers.reduce((sum, c) => sum + (c.price_net ? parseFloat(String(c.price_net)) : 0), 0);
        const otherCosts = formData.other_costs.reduce((sum, c) => sum + (typeof c.amount === 'number' ? c.amount : parseFloat(String(c.amount)) || 0), 0);
        const calculatedMyPrice = clientPrice - transportCost - otherCosts;
        setFormData(prev => ({ ...prev, my_price_net: calculatedMyPrice.toFixed(2) }));
      }
      
      // Taip pat iškviesti calculateMyPrice po timeout, kad būtų užtikrintas teisingas skaičiavimas
      setTimeout(() => calculateMyPrice(true), 100);
    } catch (error: any) {
      showToast('error', error.response?.data?.detail || 'Klaida išsaugant vežėją');
    }
  };

  // Automatiškai apskaičiuoti "mano kainą": client_price_net - (visų vežėjų kainų suma) - (kitų išlaidų suma)
  // Naudojame ref, kad sektume ar vartotojas rankiniu būdu redagavo
  const myPriceManuallyEdited = React.useRef(false);

  // Apskaičiuoti "mano kainą" - skaičiuojama: client_price_net - carrier_costs - other_costs
  const calculateMyPrice = React.useCallback((forceRecalculate = false) => {
    if (!showCreateForm && !showEditForm) return;
    
    // Jei vartotojas rankiniu būdu redagavo mano kainą, neperrašyti (nebent priversti perskaičiuoti)
    if (myPriceManuallyEdited.current && !forceRecalculate) return;
    
    // Gauti kliento kainą
    const clientPrice = formData.client_price_net ? parseFloat(formData.client_price_net) : 0;
    
    // Įtraukti ir redaguojamo vežėjo kainą, jei jis yra modalyje
    let transportCost = orderCarriers.reduce((sum, c) => sum + (c.price_net ? parseFloat(String(c.price_net)) : 0), 0);
    if (editingCarrier && editingCarrierIndex !== null && editingCarrier.price_net) {
      // Jei redaguojamas vežėjas, pakeisti jo kainą modalyje
      const carrierPrice = parseFloat(String(editingCarrier.price_net));
      // Atimti seną kainą ir pridėti naują (jei index teisingas)
      if (editingCarrierIndex >= 0 && editingCarrierIndex < orderCarriers.length) {
        const oldPrice = orderCarriers[editingCarrierIndex].price_net ? parseFloat(String(orderCarriers[editingCarrierIndex].price_net)) : 0;
        transportCost = transportCost - oldPrice + carrierPrice;
      } else {
        // Jei naujas vežėjas (dar nepridėtas), pridėti jo kainą
        transportCost = transportCost + carrierPrice;
      }
    }
    
    // Kitos išlaidos
    const otherCosts = formData.other_costs.reduce((sum, c) => sum + (typeof c.amount === 'number' ? c.amount : parseFloat(String(c.amount)) || 0), 0);
    
    // Skaičiuoti mano kainą: client_price - carrier_costs - other_costs
    const calculatedMyPrice = clientPrice - transportCost - otherCosts;
    
    setFormData(prev => {
      // Atnaujinti tik jei vertė pasikeitė
      const currentMyPrice = prev.my_price_net ? parseFloat(prev.my_price_net) : 0;
      if (Math.abs(currentMyPrice - calculatedMyPrice) > 0.01) {
        return { ...prev, my_price_net: calculatedMyPrice.toFixed(2) };
      }
      return prev;
    });
  }, [orderCarriers, formData.client_price_net, formData.other_costs, showCreateForm, showEditForm, editingCarrier, editingCarrierIndex]);

  useEffect(() => {
    calculateMyPrice();
  }, [calculateMyPrice]);

  // Track manual editing of my_price_net
  const handleMyPriceChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value;
    setFormData(prev => ({ ...prev, my_price_net: value }));
    // Pažymėti, kad vartotojas rankiniu būdu redagavo
    if (value) {
      myPriceManuallyEdited.current = true;
    } else {
      myPriceManuallyEdited.current = false;
    }
  };

  // Handle client price change - trigger automatic calculation of my_price
  const handleClientPriceChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value;
    setFormData(prev => ({ ...prev, client_price_net: value }));
    // Reset manual edit flag when client price changes, so my_price recalculates
    myPriceManuallyEdited.current = false;
    // Calculate my_price after a short delay to ensure state is updated
    setTimeout(() => calculateMyPrice(), 50);
  };

  const handleEditCarrier = (carrier: OrderCarrier, index: number) => {
    // Užtikrinti, kad visi laukai būtų teisingai suformatuoti
    setEditingCarrier({
      ...carrier,
      id: carrier.id, // UŽTIKRINTI kad ID būtų išlaikytas!
      partner_id: carrier.partner_id || carrier.partner?.id, // UŽTIKRINTI partner_id
      price_net: carrier.price_net ? (typeof carrier.price_net === 'string' ? carrier.price_net : String(carrier.price_net)) : null,
      route_from: carrier.route_from || '',
      route_to: carrier.route_to || '',
      loading_date: carrier.loading_date || null,
      unloading_date: carrier.unloading_date || null,
      status: carrier.status || 'new',
      status_display: carrier.status_display || 'Naujas',
      payment_status: carrier.payment_status || 'not_paid',
      payment_status_display: carrier.payment_status_display || 'Neapmokėta',
      payment_date: carrier.payment_date || null,
      documents_status: carrier.documents_status || 'not_received',
      documents_status_display: carrier.documents_status_display || 'Negauta',
      payment_status_info: carrier.payment_status_info,
      invoice_issued: carrier.invoice_issued || false,
      invoice_received: carrier.invoice_received || false,
      invoice_received_date: carrier.invoice_received_date || null,
      payment_days: carrier.payment_days || null,
      due_date: carrier.due_date || null,
      notes: carrier.notes || ''
    });
    setEditingCarrierIndex(index);
    setCarrierFormType(carrier.carrier_type);
    setCarrierPartnerSearch(carrier.partner.name);
    setSelectedCarrierPartnerName(carrier.partner.name);
    setCarrierPartners([]);
    setShowCarrierForm(true);
  };

  // CargoItems valdymo funkcijos
  const handleAddCargoItem = () => {
    setEditingCargoItem({
      sequence_order: cargoItems.length,
      description: '',
      weight_kg: null,
      ldm: null,
      length_m: null,
      width_m: null,
      height_m: null,
      is_palletized: false,
      is_stackable: false,
      vehicle_type: null,
      requires_forklift: false,
      requires_crane: false,
      requires_special_equipment: false,
      fragile: false,
      hazardous: false,
      temperature_controlled: false,
      requires_permit: false,
    });
    setEditingCargoItemIndex(null);
    setShowCargoItemForm(true);
  };

  const handleEditCargoItem = (item: CargoItem, index: number) => {
    setEditingCargoItem({ ...item });
    setEditingCargoItemIndex(index);
    setShowCargoItemForm(true);
  };

  const handleDeleteCargoItem = (index: number) => {
    const updated = cargoItems.filter((_, i) => i !== index).map((item, i) => ({
      ...item,
      sequence_order: i
    }));
    setCargoItems(updated);
  };

  const handleSaveCargoItem = () => {
    if (!editingCargoItem) return;
    
    if (editingCargoItemIndex !== null && editingCargoItemIndex >= 0 && editingCargoItemIndex < cargoItems.length) {
      // Atnaujinti esamą
      const updated = [...cargoItems];
      updated[editingCargoItemIndex] = {
        ...editingCargoItem,
        sequence_order: editingCargoItemIndex
      };
      setCargoItems(updated);
    } else {
      // Pridėti naują
      setCargoItems([...cargoItems, {
        ...editingCargoItem,
        sequence_order: cargoItems.length
      }]);
    }
    
    setShowCargoItemForm(false);
    setEditingCargoItem(null);
    setEditingCargoItemIndex(null);
  };

  const handleDeleteCarrier = (index: number) => {
    setConfirmState({
      open: true,
      title: 'Patvirtinkite',
      message: 'Ar tikrai norite pašalinti šį vežėją/sandėlį?',
      onConfirm: () => {
        setOrderCarriers(orderCarriers.filter((_, i) => i !== index));
        setConfirmState({ open:false });
        // Reset manual edit flag when carriers change, so my_price recalculates
        myPriceManuallyEdited.current = false;
        // Iškarto apskaičiuoti "mano kainą" po vežėjo ištrynimo
        setTimeout(() => calculateMyPrice(true), 100);
      }
    });
  };

  const handleUpdateOrder = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!editingOrder) return;

    try {
      const orderData = {
        client_id: parseInt(formData.client_id),
        order_type: formData.order_type,
        manager_id: formData.manager_id ? parseInt(formData.manager_id) : null,
        status: formData.status,
        price_net: (() => {
          // Bazinė kaina = Pervežimo/sandėliavimo + Mano kaina + Kitos išlaidos
          const transportCost = orderCarriers.reduce((sum, c) => sum + (c.price_net ? parseFloat(String(c.price_net)) : 0), 0);
          const myPrice = formData.my_price_net ? parseFloat(formData.my_price_net) : 0;
          const otherCosts = formData.other_costs.reduce((sum, c) => sum + (typeof c.amount === 'number' ? c.amount : parseFloat(String(c.amount)) || 0), 0);
          return (transportCost + myPrice + otherCosts) || 0;
        })(),
        client_price_net: formData.client_price_net ? parseFloat(formData.client_price_net) : null,
        my_price_net: formData.my_price_net && formData.my_price_net.trim() !== '' ? parseFloat(formData.my_price_net) : null,
        other_costs: formData.other_costs.length > 0 ? formData.other_costs.map(cost => ({
          description: cost.description,
          amount: parseFloat(String(cost.amount))
        })) : [],
        vat_rate: parseFloat(formData.vat_rate),
        vat_rate_article: formData.vat_rate_article || '',
        client_invoice_issued: formData.client_invoice_issued,
        client_invoice_received: formData.client_invoice_received,
        client_payment_status: formData.client_payment_status,
        route_from: formData.route_from || '',
        route_to: formData.route_to || '',
        route_from_country: formData.route_from_country || '',
        route_from_postal_code: formData.route_from_postal_code || '',
        route_from_city: formData.route_from_city || '',
        route_from_address: formData.route_from_address || '',
        route_to_country: formData.route_to_country || '',
        route_to_postal_code: formData.route_to_postal_code || '',
        route_to_city: formData.route_to_city || '',
        route_to_address: formData.route_to_address || '',
        order_date: formData.order_date || null,
        loading_date: formData.loading_date || null,
        unloading_date: formData.unloading_date || null,
        is_partial: formData.is_partial,
        weight_kg: formData.weight_kg ? parseFloat(formData.weight_kg) : null,
        ldm: formData.ldm ? parseFloat(formData.ldm) : null,
        length_m: formData.length_m ? parseFloat(formData.length_m) : null,
        width_m: formData.width_m ? parseFloat(formData.width_m) : null,
        height_m: formData.height_m ? parseFloat(formData.height_m) : null,
        is_palletized: formData.is_palletized,
        is_stackable: formData.is_stackable,
        vehicle_type: formData.vehicle_type || null,
        requires_forklift: formData.requires_forklift,
        requires_crane: formData.requires_crane,
        requires_special_equipment: formData.requires_special_equipment,
        fragile: formData.fragile,
        hazardous: formData.hazardous,
        temperature_controlled: formData.temperature_controlled,
        requires_permit: formData.requires_permit,
        notes: formData.notes || ''
      };
      
      await api.put(`/orders/orders/${editingOrder.id}/`, orderData);

      // AutocompleteField automatiškai išsaugo duomenis, nereikia rankiniu
      
      // Gauname esamus vežėjus/sandėlius
      const existingCarriersResponse = await api.get(`/orders/carriers/?order=${editingOrder.id}`);
      const existingCarriers = existingCarriersResponse.data.results || existingCarriersResponse.data || [];
      
      // Ištriname visus esamus vežėjus/sandėlius
      for (const carrier of existingCarriers) {
        await api.delete(`/orders/carriers/${carrier.id}/`);
      }
      
      // Sukuriame naujus vežėjus/sandėlius
      if (orderCarriers.length > 0) {
        for (const carrier of orderCarriers) {
          try {
            // Užtikrinti, kad partner_id būtų nustatytas
            const partnerId = carrier.partner_id || carrier.partner?.id;
            if (!partnerId) {
              showToast('info', 'Klaida: vežėjas/sandėlys neturi partnerio ID. Praleidžiamas.');
              continue;
            }
            
            const carrierData = {
              order: editingOrder.id,
              partner_id: partnerId,
              carrier_type: carrier.carrier_type || 'carrier',
              sequence_order: carrier.sequence_order || 0,
              price_net: carrier.price_net ? parseFloat(String(carrier.price_net)) : null,
              route_from: carrier.route_from || '',
              route_to: carrier.route_to || '',
              loading_date: carrier.loading_date || null,
              unloading_date: carrier.unloading_date || null,
              status: carrier.status || 'new',
              invoice_issued: carrier.invoice_issued || false,
              invoice_received: carrier.invoice_received || false,
              invoice_received_date: carrier.invoice_received_date || null,
              payment_days: carrier.payment_days || null,
              due_date: carrier.due_date || null,
              payment_status: carrier.payment_status || 'not_paid',
              payment_date: carrier.payment_date || null,
              documents_status: carrier.documents_status || 'not_received',
              notes: carrier.notes || ''
            };
            await api.post('/orders/carriers/', carrierData);
          } catch (error: any) {
            const errorMsg = error.response?.data?.detail || 
                           (typeof error.response?.data === 'object' ? JSON.stringify(error.response?.data) : error.response?.data) ||
                           error.message;
            showToast('error', `Klaida kuriant vežėją/sandėlį: ${errorMsg}`);
            throw error;
          }
        }
      }

      // Gauname esamus krovinių aprašymus
      const existingCargoResponse = await api.get(`/orders/cargo-items/?order=${editingOrder.id}`);
      const existingCargoItems = existingCargoResponse.data.results || existingCargoResponse.data || [];
      
      // Ištriname visus esamus krovinių aprašymus
      for (const cargoItem of existingCargoItems) {
        try {
          await api.delete(`/orders/cargo-items/${cargoItem.id}/`);
        } catch (error: any) {
        }
      }
      
      // Sukuriame naujus krovinių aprašymus
      if (cargoItems.length > 0) {
        for (const cargoItem of cargoItems) {
          try {
            const cargoData = {
              order: editingOrder.id,
              sequence_order: cargoItem.sequence_order || 0,
              description: cargoItem.description || '',
              weight_kg: cargoItem.weight_kg ? parseFloat(String(cargoItem.weight_kg)) : null,
              ldm: cargoItem.ldm ? parseFloat(String(cargoItem.ldm)) : null,
              length_m: cargoItem.length_m ? parseFloat(String(cargoItem.length_m)) : null,
              width_m: cargoItem.width_m ? parseFloat(String(cargoItem.width_m)) : null,
              height_m: cargoItem.height_m ? parseFloat(String(cargoItem.height_m)) : null,
              is_palletized: cargoItem.is_palletized || false,
              is_stackable: cargoItem.is_stackable || false,
              vehicle_type: cargoItem.vehicle_type || null,
              requires_forklift: cargoItem.requires_forklift || false,
              requires_crane: cargoItem.requires_crane || false,
              requires_special_equipment: cargoItem.requires_special_equipment || false,
              fragile: cargoItem.fragile || false,
              hazardous: cargoItem.hazardous || false,
              temperature_controlled: cargoItem.temperature_controlled || false,
              requires_permit: cargoItem.requires_permit || false,
            };
            await api.post('/orders/cargo-items/', cargoData);
          } catch (error: any) {
            const errorMsg = error.response?.data?.detail || 
                           (typeof error.response?.data === 'object' ? JSON.stringify(error.response?.data) : error.response?.data) ||
                           error.message;
            showToast('error', `Klaida kuriant krovinių aprašymą: ${errorMsg}`);
            throw error;
          }
        }
      }
      
      setShowEditForm(false);
      setEditingOrder(null);
      resetForm();
      fetchOrders();
      fetchRouteSuggestions(); // Atnaujinti maršrutų pasiūlymus
      showToast('success', 'Užsakymas sėkmingai atnaujintas');
    } catch (error: any) {
      showToast('error', error.response?.data?.error || 'Klaida atnaujinant užsakymą');
    }
  };

  const handleDeleteOrder = async (id: number) => {
    try {
      // Pirmiau patikrinti ar yra susijusių sąskaitų
      let invoicesInfo;
      let hasInvoices = false;
      let salesCount = 0;
      let purchaseCount = 0;
      
      try {
        invoicesInfo = await api.get(`/orders/orders/${id}/related-invoices-info/`);
        hasInvoices = invoicesInfo.data.has_related_invoices;
        salesCount = invoicesInfo.data.sales_invoices_count || 0;
        purchaseCount = invoicesInfo.data.purchase_invoices_count || 0;
      } catch (statError: any) {
        // Jei nepavyko užkrauti statistikos, tęsiame be jos
        // Vartotojui parodysime paprastą patvirtinimą
        showToast('info', 'Nepavyko užkrauti statistikos. Tęsiame trinimą.');
      }
      
      if (hasInvoices) {
        // Rodyti dialogą su pasirinkimais
        setConfirmState({
          open: true,
          title: 'Patvirtinkite trinimą',
          message: `Šis užsakymas turi susijusių sąskaitų:\n- Pardavimo sąskaitos: ${salesCount}\n- Pirkimo sąskaitos: ${purchaseCount}\n\nKą norite daryti?`,
          showDeleteOptions: true,
          salesCount,
          purchaseCount,
          onDeleteWithInvoices: async () => {
            try {
              await api.delete(`/orders/orders/${id}/`, {
                data: { delete_invoices: 'true' }
              });
              if (editingOrder && editingOrder.id === id) {
                setShowEditForm(false);
                setEditingOrder(null);
              }
              await fetchOrders();
              showToast('success', 'Užsakymas ir visos susijusios sąskaitos sėkmingai ištrintos');
              setConfirmState({ open: false });
            } catch (error: any) {
              const errorMsg = error.response?.data?.detail || 
                             error.response?.data?.error || 
                             (typeof error.response?.data === 'string' ? error.response?.data : null) ||
                             error.message || 
                             'Klaida trinant užsakymą';
              showToast('error', errorMsg);
              setConfirmState({ open: false });
            }
          },
          onDeleteWithoutInvoices: async () => {
            try {
              await api.delete(`/orders/orders/${id}/`, {
                data: { delete_invoices: 'false' }
              });
              if (editingOrder && editingOrder.id === id) {
                setShowEditForm(false);
                setEditingOrder(null);
              }
              await fetchOrders();
              showToast('success', 'Užsakymas sėkmingai ištrintas. Sąskaitos paliktos.');
              setConfirmState({ open: false });
            } catch (error: any) {
              const errorMsg = error.response?.data?.detail || 
                             error.response?.data?.error || 
                             (typeof error.response?.data === 'string' ? error.response?.data : null) ||
                             error.message || 
                             'Klaida trinant užsakymą';
              showToast('error', errorMsg);
              setConfirmState({ open: false });
            }
          }
        });
      } else {
        // Nėra susijusių sąskaitų - rodyti paprastą patvirtinimą
        setConfirmState({
          open: true,
          title: 'Patvirtinkite',
          message: 'Ar tikrai norite ištrinti užsakymą?',
          showDeleteOptions: false,
          onConfirm: async () => {
            try {
              await api.delete(`/orders/orders/${id}/`);
              if (editingOrder && editingOrder.id === id) {
                setShowEditForm(false);
                setEditingOrder(null);
              }
              await fetchOrders();
              showToast('success', 'Užsakymas sėkmingai ištrintas');
              setConfirmState({ open: false });
            } catch (error: any) {
              const errorMsg = error.response?.data?.detail || 
                             error.response?.data?.error || 
                             (typeof error.response?.data === 'string' ? error.response?.data : null) ||
                             error.message || 
                             'Klaida trinant užsakymą';
              showToast('error', errorMsg);
              setConfirmState({ open: false });
            }
          }
        });
      }
    } catch (error: any) {
      // Jei nepavyko gauti informacijos apie sąskaitas, rodyti paprastą dialogą
      setConfirmState({
        open: true,
        title: 'Patvirtinkite',
        message: 'Ar tikrai norite ištrinti užsakymą?',
        showDeleteOptions: false,
        onConfirm: async () => {
          try {
            await api.delete(`/orders/orders/${id}/`);
            if (editingOrder && editingOrder.id === id) {
              setShowEditForm(false);
              setEditingOrder(null);
            }
            await fetchOrders();
            showToast('success', 'Užsakymas sėkmingai ištrintas');
            setConfirmState({ open: false });
          } catch (error: any) {
            const errorMsg = error.response?.data?.detail || 
                           error.response?.data?.error || 
                           (typeof error.response?.data === 'string' ? error.response?.data : null) ||
                           error.message || 
                           'Klaida trinant užsakymą';
            showToast('error', errorMsg);
            setConfirmState({ open: false });
          }
        }
      });
    }
  };

  const handleChangeStatus = async (orderId: number, newStatus: string) => {
    try {
      await api.post(`/orders/orders/${orderId}/change_status/`, {
        new_status: newStatus,
        notes: '',
      });
      fetchOrders();
      showToast('success', 'Statusas sėkmingai pakeistas');
    } catch (error: any) {
      showToast('error', error.response?.data?.error || 'Klaida keičiant statusą');
    }
  };

  const fetchStatusHistory = async (orderId: number) => {
    try {
      const response = await api.get(`/orders/orders/${orderId}/status_history/`);
      setStatusHistory(response.data || []);
      // Neatidarome modalo automatiškai - tik užkrauname duomenis
    } catch (error) {
    }
  };

  const resetForm = () => {
    // Reset refs when resetting form
    myPriceManuallyEdited.current = false;
    setSelectedClient(null);
    setClientSearch('');
    setSelectedClientName('');
    setClients([]);
    setFormData({
      client_id: '',
      carrier_id: '',
      order_type: 'transport',
      manager_id: user?.id ? user.id.toString() : '',
      status: 'new',
      price_net: '',
      client_price_net: '',
      my_price_net: '',
      other_costs: [],
      vat_rate: '21',
      vat_rate_article: '',
      client_invoice_issued: false,
      client_invoice_received: false,
      client_payment_status: 'not_paid' as 'not_paid' | 'partially_paid' | 'paid',
      route_from: '',
      route_to: '',
      route_from_country: '',
      route_from_postal_code: '',
      route_from_city: '',
      route_from_address: '',
      route_to_country: '',
      route_to_postal_code: '',
      route_to_city: '',
      route_to_address: '',
      order_date: '',
      loading_date: '',
      unloading_date: '',
      is_partial: false,
      weight_kg: '',
      ldm: '',
      length_m: '',
      width_m: '',
      height_m: '',
      is_palletized: false,
      is_stackable: false,
      vehicle_type: '',
      requires_forklift: false,
      requires_crane: false,
      requires_special_equipment: false,
      fragile: false,
      hazardous: false,
      temperature_controlled: false,
      requires_permit: false,
      notes: '',
    });
    setEditingOtherCost(null);
    setEditingOtherCostIndex(null);
    setClientSearch('');
    setSelectedClientName('');
    setClients([]);
    setOrderCarriers([]);
    setEditingCarrier(null);
    setEditingCarrierIndex(null);
    setShowCarrierForm(false);
    setCarrierPartnerSearch('');
    setCarrierPartners([]);
    setCargoItems([]);
    setEditingCargoItem(null);
    setEditingCargoItemIndex(null);
    setShowCargoItemForm(false);
  };

  const handleViewOrder = async (order: Order) => {
    // Užkrauti pilnus vežėjų/sandėlių duomenis
    const carriers = await fetchOrderCarriers(order.id);
    
    // Užkrauti cargo items
    let cargoItems: CargoItem[] = [];
    try {
      const cargoResponse = await api.get(`/orders/cargo-items/?order=${order.id}`);
      const cargoResults = cargoResponse.data.results || cargoResponse.data || [];
      cargoItems = cargoResults;
    } catch (e) {
      // Jei cargo_items jau yra order objekte, naudoti juos
      if (order.cargo_items && Array.isArray(order.cargo_items)) {
        cargoItems = order.cargo_items;
      }
    }
    
    // Užkrauti pilnus užsakymo duomenis iš API (kad gautume visus laukus)
    let fullOrderData = order;
    try {
      const orderResponse = await api.get(`/orders/orders/${order.id}/`);
      fullOrderData = orderResponse.data;
    } catch (e) {
    }
    
    setSelectedOrder({
      ...fullOrderData,
      carriers: carriers.length > 0 ? carriers : (fullOrderData.carriers || order.carriers || []),
      cargo_items: cargoItems.length > 0 ? cargoItems : (fullOrderData.cargo_items || order.cargo_items || [])
    });
    setShowOrderDetails(true);
    
    // Užkrauti statuso istoriją
    fetchStatusHistory(order.id);
    try {
      // Gauti sales invoices
      const response = await api.get('/invoices/sales/', { params: { related_order: order.id, page_size: 100 } });
      const results = response.data.results || response.data;
      const filtered = (results || []).filter((inv: any) => inv.related_order && (inv.related_order.id === order.id || inv.related_order === order.id));
      setSelectedOrderInvoices(filtered.map((inv: any) => ({ id: inv.id, invoice_number: inv.invoice_number, issue_date: inv.issue_date, amount_total: String(inv.amount_total) })));
      
      // Gauti purchase invoices kiekvienam vežėjui
      const finalCarriers = carriers.length > 0 ? carriers : order.carriers || [];
      const invoicesMap: { [carrierId: number]: Array<{ id: number; invoice_number: string | null; received_invoice_number: string; issue_date: string | null; amount_total: string }> } = {};
      for (const carrier of finalCarriers) {
        if (carrier.id && carrier.partner) {
          try {
            const purchaseResponse = await api.get('/invoices/purchase/', {
              params: {
                related_order: order.id,
                partner: carrier.partner.id,
                page_size: 100
              }
            });
            const purchaseResults = purchaseResponse.data.results || purchaseResponse.data || [];
            const purchaseFiltered = (purchaseResults || []).filter((inv: any) => 
              inv.related_order && 
              (inv.related_order.id === order.id || inv.related_order === order.id) &&
              inv.partner &&
              (inv.partner.id === carrier.partner.id || inv.partner === carrier.partner.id)
            );
            invoicesMap[carrier.id] = purchaseFiltered.map((inv: any) => ({ 
              id: inv.id, 
              invoice_number: inv.invoice_number,
              received_invoice_number: inv.received_invoice_number,
              issue_date: inv.issue_date, 
              amount_total: String(inv.amount_total) 
            }));
          } catch (e) {
            invoicesMap[carrier.id] = [];
          }
        }
      }
      setCarrierPurchaseInvoices(invoicesMap);
    } catch (e) {
      setSelectedOrderInvoices([]);
      setCarrierPurchaseInvoices({});
    }
  };

  // Optimizuotas: const objektas už limitu - nepersikuria kiekvieną render
  const STATUS_COLORS: { [key: string]: string } = {
    new: 'badge-info',
    assigned: 'badge-warning',
    executing: 'badge-primary',
    waiting_for_docs: 'badge-warning',
    finished: 'badge-success',
    canceled: 'badge-danger',
  };
  
  const getStatusColor = (status: string) => {
    return STATUS_COLORS[status] || 'badge-secondary';
  };

  // Helper funkcijos maršrutams
  const getRouteFromAddress = useCallback((order: Order | null): string => {
    if (!order) return '';
    if (order.route_from_country) {
      return [order.route_from_country, order.route_from_postal_code, order.route_from_city, order.route_from_address].filter(Boolean).join(', ');
    }
    return order.route_from || '';
  }, []);

  const getRouteToAddress = useCallback((order: Order | null): string => {
    if (!order) return '';
    if (order.route_to_country) {
      return [order.route_to_country, order.route_to_postal_code, order.route_to_city, order.route_to_address].filter(Boolean).join(', ');
    }
    return order.route_to || '';
  }, []);

  // Apskaičiuoti maršruto adresus žemėlapiui
  const getMapRouteData = () => {
    if (!showRouteMap || !selectedOrder) return null;
    
    const routeFrom = getRouteFromAddress(selectedOrder);
    const routeTo = getRouteToAddress(selectedOrder);
    
    if (!routeFrom && !routeTo) return null;
    
    return {
      from: routeFrom,
      to: routeTo,
      fromDisplay: routeFrom || 'Nenurodytas',
      toDisplay: routeTo || 'Nenurodytas'
    };
  };
  
  const mapRouteData = getMapRouteData();



  return (
    <div className="page">
      <div className="container">
        {toast.visible && (
          <div style={{
            position: 'fixed', top: '20%', left: '50%', transform: 'translateX(-50%)', zIndex: 2000,
            backgroundColor: toast.type === 'success' ? '#28a745' : toast.type === 'error' ? '#dc3545' : '#17a2b8',
            color: 'white', padding: '12px 18px', borderRadius: 8, boxShadow: '0 6px 20px rgba(0,0,0,0.25)',
            maxWidth: '90%', textAlign: 'center'
          }}>
            {toast.message}
          </div>
        )}
        {confirmState.open && (
          <div style={{ position: 'fixed', top:0, left:0, right:0, bottom:0, background:'rgba(0,0,0,0.5)', display:'flex', alignItems:'center', justifyContent:'center', zIndex: 2000 }}>
            <div className="card" style={{ width: 500 }}>
              <h3 style={{ marginTop: 0 }}>{confirmState.title || 'Patvirtinkite veiksmą'}</h3>
              <p style={{ margin: '10px 0 20px', whiteSpace: 'pre-line' }}>{confirmState.message || 'Ar tikrai?'}</p>
              
              {confirmState.showDeleteOptions ? (
                <div style={{ display:'flex', flexDirection:'column', gap:10 }}>
                  <button 
                    className="button" 
                    style={{ backgroundColor: '#dc3545', color: 'white', width: '100%' }}
                    onClick={() => confirmState.onDeleteWithInvoices && confirmState.onDeleteWithInvoices()}
                  >
                    Ištrinti užsakymą ir visas sąskaitas ({confirmState.salesCount || 0} pardavimo + {confirmState.purchaseCount || 0} pirkimo)
                  </button>
                  <button 
                    className="button" 
                    style={{ backgroundColor: '#6c757d', color: 'white', width: '100%' }}
                    onClick={() => confirmState.onDeleteWithoutInvoices && confirmState.onDeleteWithoutInvoices()}
                  >
                    Ištrinti tik užsakymą (sąskaitos paliekamos)
                  </button>
                  <button 
                    className="button button-secondary" 
                    style={{ width: '100%' }}
                    onClick={() => setConfirmState({ open:false })}
                  >
                    Atšaukti
                  </button>
                </div>
              ) : (
                <div style={{ display:'flex', gap:10, justifyContent:'flex-end' }}>
                  <button className="button button-secondary" onClick={() => setConfirmState({ open:false })}>Atšaukti</button>
                  <button className="button" onClick={() => confirmState.onConfirm && confirmState.onConfirm()}>Patvirtinti</button>
                </div>
              )}
            </div>
          </div>
        )}
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px', flexWrap: 'wrap', gap: '15px' }}>
          <div>
            <h1 style={{ margin: 0, marginBottom: '5px' }}>Užsakymai</h1>
            {totalOrdersCount !== null && (
              <div style={{ fontSize: '14px', color: '#666', marginTop: '4px' }}>
                Rodyti {orders.length} {totalOrdersCount !== orders.length ? `iš ${totalOrdersCount}` : ''} užsakymų
              </div>
            )}
          </div>
          <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
              <label style={{ fontSize: '14px', color: '#666', whiteSpace: 'nowrap' }}>
                Rezultatų puslapyje:
              </label>
              <input
                type="number"
                min="10"
                max="1000"
                step="10"
                value={pageSize}
                onChange={(e) => {
                  const value = parseInt(e.target.value) || 100;
                  const clampedValue = Math.min(Math.max(value, 10), 1000);
                  setPageSize(clampedValue);
                  // Išsaugoti localStorage
                  localStorage.setItem('ordersPageSize', clampedValue.toString());
                }}
                style={{
                  width: '80px',
                  padding: '6px 8px',
                  fontSize: '14px',
                  border: '1px solid #ccc',
                  borderRadius: '4px',
                  textAlign: 'center'
                }}
              />
              <button
                onClick={() => fetchOrders()}
                disabled={loading}
                style={{
                  padding: '6px 12px',
                  fontSize: '14px',
                  border: '1px solid #ccc',
                  borderRadius: '4px',
                  backgroundColor: '#f8f9fa',
                  color: '#333',
                  cursor: loading ? 'not-allowed' : 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '5px',
                  opacity: loading ? 0.6 : 1
                }}
                title="Atnaujinti sąrašą"
              >
                🔄 {loading ? 'Kraunama...' : 'Atnaujinti'}
              </button>
            </div>
            <button className="button" onClick={() => { setShowCreateForm(true); resetForm(); }}>
              + Naujas užsakymas
            </button>
          </div>
        </div>

        {/* Filters */}
        <div className="filters-container" style={{ marginBottom: '25px' }}>
          {/* Header with toggle and clear buttons */}
          <div className="filters-header">
            <button
              className="filters-toggle-btn"
              onClick={() => setShowFilters(!showFilters)}
            >
              <span className="filters-toggle-icon">{showFilters ? '▲' : '▼'}</span>
              <span className="filters-toggle-text">Detalus filtravimas</span>
              {(filters.status.length > 0 || filters.client_id || filters.carrier_id || filters.order_type || 
                filters.route_from || filters.route_to || filters.order_date_from || filters.order_date_to ||
                filters.loading_date_from || filters.loading_date_to || filters.unloading_date_from || 
                filters.unloading_date_to || filters.manager_id) && (
                <span className="filters-active-badge">Aktyvūs filtrai</span>
              )}
            </button>
            {(filters.status.length > 0 || filters.client_id || filters.carrier_id || filters.order_type || 
              filters.route_from || filters.route_to || filters.order_date_from || filters.order_date_to ||
              filters.loading_date_from || filters.loading_date_to || filters.unloading_date_from || 
              filters.unloading_date_to || filters.manager_id) && (
              <button
                className="filters-clear-btn"
                onClick={() => {
                setFilters({
                  status: [],
                  client_id: '',
                  carrier_id: '',
                  order_type: '',
                  route_from: '',
                  route_to: '',
                  order_date_from: '',
                  order_date_to: '',
                  loading_date_from: '',
                  loading_date_to: '',
                  unloading_date_from: '',
                  unloading_date_to: '',
                  manager_id: '',
                });
                setFilterStatus('all');
                setFilterClientSearch('');
                setFilterCarrierSearch('');
                }}
              >
                🗑️ Išvalyti visus
              </button>
            )}
          </div>
          
          {/* Advanced Filters Panel */}
          {showFilters && (
            <div className="filters-panel">
              {/* Pagrindinė informacija */}
              <div className="filters-section">
                <h3 className="filters-section-title">📋 Pagrindinė informacija</h3>
                <div className="filters-grid">
                  <div className="filter-field">
                    <label className="filter-label">🔵 Būsena</label>
                    <select
                      multiple
                      className="filter-select filter-select-multiple"
                      value={filters.status}
                      onChange={(e) => {
                        const selected = Array.from(e.target.selectedOptions, option => option.value);
                        setFilters({ ...filters, status: selected });
                      }}
                    >
                      <option value="new">🆕 Naujas</option>
                      <option value="assigned">👤 Priskirtas</option>
                      <option value="executing">⚙️ Vykdomas</option>
                      <option value="waiting_for_docs">📄 Laukiama Dokumentų</option>
                      <option value="finished">✅ Baigtas</option>
                      <option value="canceled">❌ Atšauktas</option>
                    </select>
                    {filters.status.length > 0 && (
                      <div className="filter-selected-count">Pasirinkta: {filters.status.length}</div>
                    )}
                  </div>

                  <div className="filter-field">
                    <label className="filter-label">👥 Klientas</label>
                    <div style={{ position: 'relative' }}>
                      <input
                        type="text"
                        className="filter-input"
                        value={filterClientSearch}
                        onChange={(e) => {
                          setFilterClientSearch(e.target.value);
                          setShowFilterClientDropdown(e.target.value.length > 0);
                          if (!e.target.value) {
                            setFilters({ ...filters, client_id: '' });
                          }
                        }}
                        onFocus={() => {
                          if (filterClientSearch) {
                            searchFilterClients(filterClientSearch);
                            setShowFilterClientDropdown(true);
                          }
                        }}
                        onBlur={() => setTimeout(() => setShowFilterClientDropdown(false), 200)}
                        placeholder="Ieškoti kliento..."
                      />
                      {showFilterClientDropdown && filterClients.length > 0 && (
                        <div className="client-dropdown" style={{ zIndex: 3000 }}>
                          {filterClients.map((client) => (
                            <div
                              key={client.id}
                              className="client-dropdown-item"
                              onClick={() => {
                                setFilters({ ...filters, client_id: client.id.toString() });
                                setFilterClientSearch(client.name);
                                setShowFilterClientDropdown(false);
                              }}
                            >
                              {client.name} {client.code ? `(${client.code})` : ''}
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  </div>

                  <div className="filter-field">
                    <label className="filter-label">🚚 Vežėjas</label>
                    <div style={{ position: 'relative' }}>
                      <input
                        type="text"
                        className="filter-input"
                        value={filterCarrierSearch}
                        onChange={(e) => {
                          setFilterCarrierSearch(e.target.value);
                          setShowFilterCarrierDropdown(e.target.value.length > 0);
                          if (!e.target.value) {
                            setFilters({ ...filters, carrier_id: '' });
                          }
                        }}
                        onFocus={() => {
                          if (filterCarrierSearch) {
                            searchFilterCarriers(filterCarrierSearch);
                            setShowFilterCarrierDropdown(true);
                          }
                        }}
                        onBlur={() => setTimeout(() => setShowFilterCarrierDropdown(false), 200)}
                        placeholder="Ieškoti vežėjo..."
                      />
                      {showFilterCarrierDropdown && filterCarriers.length > 0 && (
                        <div className="client-dropdown" style={{ zIndex: 3000 }}>
                          {filterCarriers.map((carrier) => (
                            <div
                              key={carrier.id}
                              className="client-dropdown-item"
                              onClick={() => {
                                setFilters({ ...filters, carrier_id: carrier.id.toString() });
                                setFilterCarrierSearch(carrier.name);
                                setShowFilterCarrierDropdown(false);
                              }}
                            >
                              {carrier.name} {carrier.code ? `(${carrier.code})` : ''}
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  </div>

                  <div className="filter-field">
                    <label className="filter-label">📦 Užsakymo tipas</label>
                    <select
                      className="filter-select"
                      value={filters.order_type}
                      onChange={(e) => setFilters({ ...filters, order_type: e.target.value })}
                    >
                      <option value="">-- Visi tipai --</option>
                      <option value="transport">🚛 Transportas</option>
                      <option value="logistics">📋 Logistika</option>
                      <option value="other">📌 Kita</option>
                    </select>
                  </div>

                  <div className="filter-field">
                    <label className="filter-label">👨‍💼 Vadybininkas</label>
                    <select
                      className="filter-select"
                      value={filters.manager_id}
                      onChange={(e) => setFilters({ ...filters, manager_id: e.target.value })}
                    >
                      <option value="">-- Visi vadybininkai --</option>
                      {allManagers.map(manager => (
                        <option key={manager.id} value={manager.id}>{manager.username}</option>
                      ))}
                    </select>
                  </div>
                </div>
              </div>

              {/* Maršrutai */}
              <div className="filters-section">
                <h3 className="filters-section-title">🗺️ Maršrutai</h3>
                <div className="filters-grid">
                  <div className="filter-field">
                    <label className="filter-label">📍 Maršrutas iš</label>
                    <input
                      type="text"
                      className="filter-input"
                      value={filters.route_from}
                      onChange={(e) => setFilters({ ...filters, route_from: e.target.value })}
                      placeholder="Įveskite miestą arba pasirinkite..."
                      list="route-from-suggestions"
                    />
                    <datalist id="route-from-suggestions">
                      {routeFromSuggestions.map((route, idx) => (
                        <option key={idx} value={route} />
                      ))}
                    </datalist>
                  </div>

                  <div className="filter-field">
                    <label className="filter-label">📍 Maršrutas į</label>
                    <input
                      type="text"
                      className="filter-input"
                      value={filters.route_to}
                      onChange={(e) => setFilters({ ...filters, route_to: e.target.value })}
                      placeholder="Įveskite miestą arba pasirinkite..."
                      list="route-to-suggestions"
                    />
                    <datalist id="route-to-suggestions">
                      {routeToSuggestions.map((route, idx) => (
                        <option key={idx} value={route} />
                      ))}
                    </datalist>
                  </div>
                </div>
              </div>

              {/* Datos */}
              <div className="filters-section">
                <h3 className="filters-section-title">📅 Datos</h3>
                <div className="filters-grid">
                  <div className="filter-field">
                    <label className="filter-label">📅 Užsakymo data nuo</label>
                    <input
                      type="date"
                      className="filter-input"
                      value={filters.order_date_from}
                      onChange={(e) => setFilters({ ...filters, order_date_from: e.target.value })}
                    />
                  </div>

                  <div className="filter-field">
                    <label className="filter-label">📅 Užsakymo data iki</label>
                    <input
                      type="date"
                      className="filter-input"
                      value={filters.order_date_to}
                      onChange={(e) => setFilters({ ...filters, order_date_to: e.target.value })}
                    />
                  </div>

                  <div className="filter-field">
                    <label className="filter-label">📦 Pakrovimo data nuo</label>
                    <input
                      type="date"
                      className="filter-input"
                      value={filters.loading_date_from}
                      onChange={(e) => setFilters({ ...filters, loading_date_from: e.target.value })}
                    />
                  </div>

                  <div className="filter-field">
                    <label className="filter-label">📦 Pakrovimo data iki</label>
                    <input
                      type="date"
                      className="filter-input"
                      value={filters.loading_date_to}
                      onChange={(e) => setFilters({ ...filters, loading_date_to: e.target.value })}
                    />
                  </div>

                  <div className="filter-field">
                    <label className="filter-label">📤 Iškrovimo data nuo</label>
                    <input
                      type="date"
                      className="filter-input"
                      value={filters.unloading_date_from}
                      onChange={(e) => setFilters({ ...filters, unloading_date_from: e.target.value })}
                    />
                  </div>

                  <div className="filter-field">
                    <label className="filter-label">📤 Iškrovimo data iki</label>
                    <input
                      type="date"
                      className="filter-input"
                      value={filters.unloading_date_to}
                      onChange={(e) => setFilters({ ...filters, unloading_date_to: e.target.value })}
                    />
                  </div>
                </div>
              </div>
            </div>
          )}
          
          {/* Greitieji filtrai */}
          <div className="quick-filters">
            <button
              className={`quick-filter-btn ${filterStatus === 'all' && filters.status.length === 0 ? 'active' : ''}`}
              onClick={() => {
                setFilterStatus('all');
                setFilters({ ...filters, status: [] });
              }}
            >
              🌐 Visi
            </button>
            <button
              className={`quick-filter-btn ${filterStatus === 'new' ? 'active' : ''}`}
              onClick={() => {
                setFilterStatus('new');
                setFilters({ ...filters, status: ['new'] });
              }}
            >
              🆕 Nauji
            </button>
            <button
              className={`quick-filter-btn ${filterStatus === 'executing' ? 'active' : ''}`}
              onClick={() => {
                setFilterStatus('executing');
                setFilters({ ...filters, status: ['executing'] });
              }}
            >
              ⚙️ Vykdomi
            </button>
            <button
              className={`quick-filter-btn ${filterStatus === 'finished' ? 'active' : ''}`}
              onClick={() => {
                setFilterStatus('finished');
                setFilters({ ...filters, status: ['finished'] });
              }}
            >
              ✅ Baigti
            </button>
          </div>
        </div>

        {/* Create/Edit Form Modal */}
        {(showCreateForm || showEditForm) && (
          <div className="modal-overlay" onClick={() => { setShowCreateForm(false); setShowEditForm(false); resetForm(); }}>
            <div className="modal-content modal-large" onClick={(e) => e.stopPropagation()} style={{ maxWidth: '1200px', maxHeight: '95vh', display: 'flex', flexDirection: 'column' }}>
              <div className="modal-header" style={{ padding: '12px 20px', borderBottom: '1px solid #dee2e6', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600' }}>
                  {showEditForm ? 'Redaguoti užsakymą' : 'Naujas užsakymas'}
                </h2>
                <button
                  onClick={() => { setShowCreateForm(false); setShowEditForm(false); resetForm(); }}
                  className="button button-secondary"
                  style={{ padding: '6px 12px', fontSize: '13px' }}
                >
                  ✕ Uždaryti
                </button>
              </div>
              
              <div style={{ padding: '15px 20px', overflowY: 'auto', flex: 1 }}>
              <form onSubmit={showEditForm ? handleUpdateOrder : handleCreateOrder}>
                {/* Kompaktiškas grid layout - Klientas ir pagrindinė info */}
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', marginBottom: '12px' }}>
                  {/* Kairė pusė - Klientas */}
                  <div style={{ 
                    border: '1px solid #dee2e6', 
                    borderRadius: '4px', 
                    padding: '10px', 
                    backgroundColor: '#f8f9fa',
                    display: 'flex',
                    flexDirection: 'column',
                    minHeight: selectedClient ? 'auto' : '80px'
                  }}>
                    <h4 style={{ margin: '0 0 8px 0', fontSize: '14px', fontWeight: 'bold', color: '#495057' }}>👤 Klientas *</h4>
                    <div style={{ position: 'relative', marginBottom: selectedClient ? '10px' : '0' }}>
                      <input
                        type="text"
                        placeholder="Ieškoti kliento (įveskite bent 2 simbolius)..."
                        value={clientSearch}
                        onChange={(e) => setClientSearch(e.target.value)}
                        required
                        style={{ paddingRight: '35px', width: '100%' }}
                      />
                      {clients.length > 0 && (
                        <div className="client-dropdown">
                          {clients.map((client) => (
                            <div
                              key={client.id}
                              className="client-dropdown-item"
                              onClick={() => handleClientSelect(client)}
                            >
                              {client.name} ({client.code})
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                    {/* Kliento informacijos rodymas po pasirinkimo */}
                    {selectedClient && (
                      <div style={{ 
                        marginTop: '8px', 
                        padding: '10px', 
                        backgroundColor: '#fff', 
                        borderRadius: '4px',
                        border: '1px solid #ced4da',
                        fontSize: '11px',
                        lineHeight: '1.5'
                      }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
                          <h5 style={{ margin: '0', fontSize: '12px', fontWeight: 'bold' }}>Kliento informacija</h5>
                          {selectedClient.vat_code && (
                            <button
                              type="button"
                              onClick={handleCheckClientOnline}
                              className="button button-secondary"
                              style={{ 
                                fontSize: '10px', 
                                padding: '4px 8px',
                                whiteSpace: 'nowrap'
                              }}
                              title="Tikrinti internete pagal PVM kodą (VIES)"
                            >
                              🔍 Patikslinti
                            </button>
                          )}
                        </div>
                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px', marginBottom: '6px' }}>
                          {selectedClient.code && <div><strong>Kodas:</strong> {selectedClient.code}</div>}
                          {selectedClient.vat_code && <div><strong>PVM kodas:</strong> {selectedClient.vat_code}</div>}
                          {selectedClient.payment_term_days && <div><strong>Mokėjimo terminas:</strong> {selectedClient.payment_term_days} d.</div>}
                        </div>
                        {selectedClient.address && (
                          <div style={{ marginBottom: '6px', paddingBottom: '6px', borderBottom: '1px solid #e9ecef' }}>
                            <strong>Adresas:</strong> {selectedClient.address}
                          </div>
                        )}
                        {selectedClient.contact_person && (
                          <div style={{ marginBottom: '6px', paddingBottom: '6px', borderBottom: '1px solid #e9ecef' }}>
                            <strong>Kontaktinis asmuo:</strong>
                            <div style={{ marginLeft: '8px', marginTop: '2px', fontSize: '10px' }}>
                              {selectedClient.contact_person.first_name} {selectedClient.contact_person.last_name}
                              {selectedClient.contact_person.position && <div style={{ color: '#6c757d' }}>{selectedClient.contact_person.position}</div>}
                              <div style={{ display: 'flex', gap: '12px', marginTop: '2px' }}>
                                {selectedClient.contact_person.email && <span>📧 {selectedClient.contact_person.email}</span>}
                                {selectedClient.contact_person.phone && <span>📞 {selectedClient.contact_person.phone}</span>}
                              </div>
                            </div>
                          </div>
                        )}
                        {selectedClient.contacts && selectedClient.contacts.length > 0 && (
                          <div style={{ marginBottom: '6px', paddingBottom: '6px', borderBottom: '1px solid #e9ecef' }}>
                            <strong>Kiti kontaktai ({selectedClient.contacts.length}):</strong>
                            {selectedClient.contacts.slice(0, 2).map((contact: Contact, idx: number) => (
                              <div key={contact.id || idx} style={{ marginLeft: '8px', marginTop: '3px', fontSize: '10px' }}>
                                {contact.first_name} {contact.last_name}
                                {(contact.email || contact.phone) && (
                                  <div style={{ display: 'flex', gap: '12px', marginTop: '1px' }}>
                                    {contact.email && <span>📧 {contact.email}</span>}
                                    {contact.phone && <span>📞 {contact.phone}</span>}
                                  </div>
                                )}
                              </div>
                            ))}
                            {selectedClient.contacts.length > 2 && (
                              <div style={{ marginLeft: '8px', marginTop: '2px', fontSize: '10px', color: '#6c757d' }}>
                                + dar {selectedClient.contacts.length - 2} kontaktų
                              </div>
                            )}
                          </div>
                        )}
                        {selectedClient.notes && (
                          <div style={{ fontSize: '10px', color: '#6c757d', marginTop: '4px' }}>
                            <strong>Pastabos:</strong> {selectedClient.notes}
                          </div>
                        )}
                      </div>
                    )}
                    
                    {/* Kliento sąskaitų statusas - rodomas tik redaguojant užsakymą */}
                    {showEditForm && (
                      <div style={{ 
                        marginTop: '12px', 
                        padding: '10px', 
                        backgroundColor: '#f8f9fa', 
                        borderRadius: '4px',
                        border: '1px solid #007bff'
                      }}>
                        <h5 style={{ margin: '0 0 8px 0', fontSize: '13px', fontWeight: 'bold', color: '#007bff' }}>
                          📄 Kliento sąskaitų statusas
                        </h5>
                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px', marginBottom: '8px' }}>
                          <div className="form-group" style={{ marginBottom: '0' }}>
                            <label style={{ display: 'flex', alignItems: 'center', gap: '8px', cursor: 'pointer', fontSize: '12px' }}>
                              <input
                                type="checkbox"
                                checked={formData.client_invoice_issued}
                                onChange={(e) => setFormData({ ...formData, client_invoice_issued: e.target.checked })}
                              />
                              <span>Išrašyta sąskaita</span>
                            </label>
                          </div>
                          <div className="form-group" style={{ marginBottom: '0' }}>
                            <label style={{ display: 'flex', alignItems: 'center', gap: '8px', cursor: 'pointer', fontSize: '12px' }}>
                              <input
                                type="checkbox"
                                checked={formData.client_invoice_received}
                                onChange={(e) => setFormData({ ...formData, client_invoice_received: e.target.checked })}
                              />
                              <span>Gauta sąskaita</span>
                            </label>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>

                  {/* Dešinė pusė - Pagrindinė info */}
                  <div style={{ 
                    border: '1px solid #dee2e6', 
                    borderRadius: '4px', 
                    padding: '10px', 
                    backgroundColor: '#fff'
                  }}>
                    <h4 style={{ margin: '0 0 8px 0', fontSize: '14px', fontWeight: 'bold', color: '#495057' }}>ℹ️ Informacija</h4>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                      <div className="form-group" style={{ marginBottom: '0' }}>
                        <label style={{ fontSize: '12px', marginBottom: '4px' }}>Užsakymo tipas *</label>
                        <select
                          value={formData.order_type}
                          onChange={(e) => setFormData({ ...formData, order_type: e.target.value })}
                          required
                          style={{ width: '100%' }}
                        >
                          <option value="transport">Transportas</option>
                          <option value="logistics">Logistika</option>
                          <option value="other">Kita</option>
                        </select>
                      </div>
                      {showEditForm && (
                        <div className="form-group" style={{ marginBottom: '0' }}>
                          <label style={{ fontSize: '12px', marginBottom: '4px' }}>Mokėjimo būklė</label>
                          <select
                            value={formData.client_payment_status}
                            onChange={(e) => setFormData({ ...formData, client_payment_status: e.target.value as 'not_paid' | 'partially_paid' | 'paid' })}
                            style={{ width: '100%' }}
                          >
                            <option value="not_paid">Neapmokėta</option>
                            <option value="partially_paid">Dalinai apmokėta</option>
                            <option value="paid">Apmokėta</option>
                          </select>
                        </div>
                      )}
                      {showEditForm && (
                        <div className="form-group" style={{ marginBottom: '0' }}>
                          <label style={{ fontSize: '12px', marginBottom: '4px' }}>Būsena</label>
                          <select
                            value={formData.status}
                            onChange={(e) => setFormData({ ...formData, status: e.target.value })}
                            style={{ width: '100%' }}
                          >
                            <option value="new">Naujas</option>
                            <option value="assigned">Priskirtas</option>
                            <option value="executing">Vykdomas</option>
                            <option value="waiting_for_docs">Laukiama Dokumentų</option>
                            <option value="finished">Baigtas</option>
                            <option value="canceled">Atšauktas</option>
                          </select>
                        </div>
                      )}
                      <div className="form-group" style={{ marginBottom: '0' }}>
                        <label style={{ fontSize: '12px', marginBottom: '4px' }}>Užsakymo data</label>
                        <input
                          type="date"
                          value={formData.order_date ? formData.order_date.split('T')[0] : ''}
                          onChange={(e) => setFormData({ ...formData, order_date: e.target.value ? `${e.target.value}T00:00` : '' })}
                          style={{ width: '100%' }}
                        />
                      </div>
                      <div className="form-group" style={{ marginBottom: '0' }}>
                        <label style={{ fontSize: '12px', marginBottom: '4px' }}>Vadybininkas</label>
                        <select
                          value={formData.manager_id}
                          onChange={(e) => setFormData({ ...formData, manager_id: e.target.value })}
                          style={{ width: '100%' }}
                        >
                          <option value="">Nepasirinkta</option>
                          {allManagers.map((manager) => {
                            const managerWithNames = manager as User & { first_name?: string; last_name?: string; email?: string };
                            return (
                              <option key={manager.id} value={manager.id.toString()}>
                                {managerWithNames.first_name && managerWithNames.last_name 
                                  ? `${managerWithNames.first_name} ${managerWithNames.last_name}`
                                  : manager.username}
                              </option>
                            );
                          })}
                        </select>
                      </div>
                    </div>
                  </div>
                </div>

                {/* Maršrutas */}
                <div style={{ marginBottom: '12px' }}>
                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                    {/* Maršrutas iš */}
                    <div style={{ border: '1px solid #dee2e6', borderRadius: '4px', padding: '10px', backgroundColor: '#f8f9fa' }}>
                      <h4 style={{ margin: '0 0 8px 0', fontSize: '13px', fontWeight: 'bold', color: '#495057' }}>📍 Maršrutas iš *</h4>
                      <div style={{ display: 'flex', flexDirection: 'column', gap: '6px' }}>
                        <div className="form-group" style={{ marginBottom: '0' }}>
                          <AutocompleteField
                            fieldType="route_from_country"
                            value={formData.route_from_country}
                            onChange={(value) => setFormData({ ...formData, route_from_country: value })}
                            label="Šalis"
                            required
                            style={{ padding: '5px 6px', fontSize: '12px' }}
                          />
                        </div>
                        <div className="form-group" style={{ marginBottom: '0' }}>
                          <AutocompleteField
                            fieldType="route_from_postal_code"
                            value={formData.route_from_postal_code}
                            onChange={(value) => setFormData({ ...formData, route_from_postal_code: value })}
                            label="Pašto kodas"
                            style={{ padding: '5px 6px', fontSize: '12px' }}
                          />
                        </div>
                        <div className="form-group" style={{ marginBottom: '0' }}>
                          <AutocompleteField
                            fieldType="route_from_city"
                            value={formData.route_from_city}
                            onChange={(value) => setFormData({ ...formData, route_from_city: value })}
                            label="Miestas"
                            style={{ padding: '5px 6px', fontSize: '12px' }}
                          />
                        </div>
                        <div className="form-group" style={{ marginBottom: '0' }}>
                          <AutocompleteField
                            fieldType="route_from_address"
                            value={formData.route_from_address}
                            onChange={(value) => setFormData({ ...formData, route_from_address: value })}
                            label="Adresas"
                            style={{ padding: '5px 6px', fontSize: '12px' }}
                          />
                        </div>
                      </div>
                    </div>
                    
                    {/* Maršrutas į */}
                    <div style={{ border: '1px solid #dee2e6', borderRadius: '4px', padding: '10px', backgroundColor: '#f8f9fa' }}>
                      <h4 style={{ margin: '0 0 8px 0', fontSize: '13px', fontWeight: 'bold', color: '#495057' }}>📍 Maršrutas į *</h4>
                      <div style={{ display: 'flex', flexDirection: 'column', gap: '6px' }}>
                        <div className="form-group" style={{ marginBottom: '0' }}>
                          <AutocompleteField
                            fieldType="route_to_country"
                            value={formData.route_to_country}
                            onChange={(value) => setFormData({ ...formData, route_to_country: value })}
                            label="Šalis"
                            required
                            style={{ padding: '5px 6px', fontSize: '12px' }}
                          />
                        </div>
                        <div className="form-group" style={{ marginBottom: '0' }}>
                          <AutocompleteField
                            fieldType="route_to_postal_code"
                            value={formData.route_to_postal_code}
                            onChange={(value) => setFormData({ ...formData, route_to_postal_code: value })}
                            label="Pašto kodas"
                            style={{ padding: '5px 6px', fontSize: '12px' }}
                          />
                        </div>
                        <div className="form-group" style={{ marginBottom: '0' }}>
                          <AutocompleteField
                            fieldType="route_to_city"
                            value={formData.route_to_city}
                            onChange={(value) => setFormData({ ...formData, route_to_city: value })}
                            label="Miestas"
                            style={{ padding: '5px 6px', fontSize: '12px' }}
                          />
                        </div>
                        <div className="form-group" style={{ marginBottom: '0' }}>
                          <AutocompleteField
                            fieldType="route_to_address"
                            value={formData.route_to_address}
                            onChange={(value) => setFormData({ ...formData, route_to_address: value })}
                            label="Adresas"
                            style={{ padding: '5px 6px', fontSize: '12px' }}
                          />
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                {/* Pakrovimo/iškrovimo datos */}
                <div style={{ marginBottom: '12px', display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                  <div className="form-group" style={{ marginBottom: '0' }}>
                    <label style={{ fontSize: '12px', marginBottom: '4px' }}>Pakrovimo data</label>
                    <input
                      type="date"
                      value={formData.loading_date ? formData.loading_date.split('T')[0] : ''}
                      onChange={(e) => setFormData({ ...formData, loading_date: e.target.value ? `${e.target.value}T00:00` : '' })}
                      style={{ width: '100%' }}
                    />
                  </div>
                  <div className="form-group" style={{ marginBottom: '0' }}>
                    <label style={{ fontSize: '12px', marginBottom: '4px' }}>Iškrovimo data</label>
                    <input
                      type="date"
                      value={formData.unloading_date ? formData.unloading_date.split('T')[0] : ''}
                      onChange={(e) => setFormData({ ...formData, unloading_date: e.target.value ? `${e.target.value}T00:00` : '' })}
                      style={{ width: '100%' }}
                    />
                  </div>
                </div>

                {/* Krovinių informacija ir Vežėjai/Sandėliai - dviejuose stulpeliuose */}
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', marginBottom: '12px' }}>
                  {/* Kairė pusė - Krovinių informacija */}
                  <div style={{ border: '1px solid #dee2e6', borderRadius: '4px', padding: '10px', backgroundColor: '#fff' }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
                    <h4 style={{ margin: '0 0 0 0', fontSize: '14px', fontWeight: 'bold', color: '#495057' }}>
                      📦 Krovinių informacija
                    </h4>
                    <button
                      type="button"
                      className="button button-secondary"
                      onClick={handleAddCargoItem}
                      style={{ padding: '3px 6px', fontSize: '10px', marginLeft: '6px' }}
                    >
                      + Pridėti krovinį
                    </button>
                  </div>
                  
                  {cargoItems.length > 0 ? (
                    <div style={{ border: '1px solid #ddd', borderRadius: '4px', padding: '4px', backgroundColor: 'white', maxHeight: '180px', overflowY: 'auto' }}>
                      {cargoItems.map((item, index) => (
                        <div
                          key={index}
                          style={{
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'flex-start',
                            padding: '6px',
                            marginBottom: index < cargoItems.length - 1 ? '4px' : '0',
                            borderBottom: index < cargoItems.length - 1 ? '1px solid #eee' : 'none',
                            backgroundColor: '#fafafa',
                            borderRadius: '4px'
                          }}
                        >
                          <div style={{ flex: 1 }}>
                            <div style={{ fontWeight: '600', marginBottom: '4px', fontSize: '13px' }}>
                              Krovinys #{index + 1}
                              {item.description && (
                                <span style={{ marginLeft: '8px', color: '#666', fontWeight: 'normal' }}>
                                  - {item.description}
                                </span>
                              )}
                            </div>
                            <div style={{ fontSize: '12px', color: '#666', display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '8px', marginTop: '6px' }}>
                              {item.weight_kg && (
                                <div><strong>Svoris:</strong> {item.weight_kg} kg</div>
                              )}
                              {item.ldm && (
                                <div><strong>LDM:</strong> {item.ldm}</div>
                              )}
                              {item.length_m && item.width_m && item.height_m && (
                                <div><strong>Matmenys:</strong> {item.length_m}×{item.width_m}×{item.height_m} m</div>
                              )}
                              {item.vehicle_type && (
                                <div><strong>Mašinos tipas:</strong> {item.vehicle_type}</div>
                              )}
                              {(item.is_palletized || item.is_stackable) && (
                                <div>
                                  <strong>Savybės:</strong>{' '}
                                  {item.is_palletized && 'Paletemis'}
                                  {item.is_palletized && item.is_stackable && ', '}
                                  {item.is_stackable && 'Stabeliuojamas'}
                                </div>
                              )}
                              {(item.requires_forklift || item.requires_crane || item.fragile || item.hazardous) && (
                                <div>
                                  <strong>Papildoma:</strong>{' '}
                                  {[
                                    item.requires_forklift && 'Keltuvas',
                                    item.requires_crane && 'Kranas',
                                    item.fragile && 'Trapus',
                                    item.hazardous && 'Pavojingas'
                                  ].filter(Boolean).join(', ')}
                                </div>
                              )}
                            </div>
                          </div>
                          <div style={{ display: 'flex', gap: '6px' }}>
                            <button
                              type="button"
                              className="button button-secondary"
                              onClick={() => handleEditCargoItem(item, index)}
                              style={{ padding: '5px 10px', fontSize: '11px' }}
                            >
                              Redaguoti
                            </button>
                            <button
                              type="button"
                              className="button button-secondary"
                              onClick={() => {
                                setConfirmState({
                                  open: true,
                                  title: 'Patvirtinkite',
                                  message: 'Ar tikrai norite pašalinti šį krovinių aprašymą?',
                                  onConfirm: () => {
                                    handleDeleteCargoItem(index);
                                    setConfirmState({ open: false });
                                  }
                                });
                              }}
                              style={{ padding: '5px 10px', fontSize: '11px', backgroundColor: '#dc3545', color: 'white', border: 'none' }}
                            >
                              Trinti
                            </button>
                          </div>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <div style={{ padding: '12px', textAlign: 'center', color: '#999', border: '1px dashed #ddd', borderRadius: '8px', backgroundColor: '#fafafa' }}>
                      Nėra pridėtų krovinių aprašymų
                    </div>
                  )}
                </div>


                  {/* Dešinė pusė - Vežėjai ir sandėliai */}
                  <div style={{ border: '1px solid #dee2e6', borderRadius: '4px', padding: '10px', backgroundColor: '#fff' }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
                    <h4 style={{ margin: '0 0 0 0', fontSize: '14px', fontWeight: 'bold', color: '#495057' }}>🚚 Vežėjai ir sandėliai</h4>
                    <div style={{ display: 'flex', gap: '4px' }}>
                      <button
                        type="button"
                        className="button button-secondary"
                        onClick={() => handleAddCarrier('carrier')}
                        style={{ padding: '3px 6px', fontSize: '10px' }}
                      >
                        + Vežėjas
                      </button>
                      <button
                        type="button"
                        className="button button-secondary"
                        onClick={() => handleAddCarrier('warehouse')}
                        style={{ padding: '3px 6px', fontSize: '10px' }}
                      >
                        + Sandėlys
                      </button>
                    </div>
                  </div>
                  
                  {orderCarriers.length > 0 ? (
                    <div style={{ border: '1px solid #ddd', borderRadius: '4px', padding: '4px', backgroundColor: '#f9f9f9', maxHeight: '180px', overflowY: 'auto' }}>
                      {orderCarriers.map((carrier, index) => (
                        <div 
                          key={index}
                          style={{ 
                            display: 'flex', 
                            justifyContent: 'space-between', 
                            alignItems: 'center',
                            padding: '6px',
                            marginBottom: index < orderCarriers.length - 1 ? '4px' : '0',
                            borderBottom: index < orderCarriers.length - 1 ? '1px solid #eee' : 'none',
                            backgroundColor: 'white',
                            borderRadius: '4px'
                          }}
                        >
                          <div style={{ flex: 1 }}>
                            <div style={{ fontWeight: '600', marginBottom: '3px', fontSize: '13px' }}>
                              {carrier.sequence_order + 1}. {carrier.carrier_type_display}: {carrier.partner.name}
                            </div>
                            <div style={{ fontSize: '12px', color: '#666' }}>
                              Kaina: {carrier.price_net ? `${parseFloat(carrier.price_net).toFixed(2)} EUR` : 'Nenustatyta'}
                              {carrier.route_from && carrier.route_to && (
                                <span style={{ marginLeft: '8px' }}>
                                  | {carrier.route_from} → {carrier.route_to}
                                </span>
                              )}
                            </div>
                            {carrier.status_display && (
                              <div style={{ fontSize: '11px', color: '#999', marginTop: '2px' }}>
                                Būklė: {carrier.status_display}
                              </div>
                            )}
                          </div>
                          <div style={{ display: 'flex', gap: '6px' }}>
                            <button
                              type="button"
                              className="button button-secondary"
                              onClick={() => handleEditCarrier(carrier, index)}
                              style={{ padding: '5px 10px', fontSize: '11px' }}
                            >
                              Redaguoti
                            </button>
                            <button
                              type="button"
                              className="button button-secondary"
                              onClick={() => handleDeleteCarrier(index)}
                              style={{ padding: '5px 10px', fontSize: '11px', backgroundColor: '#dc3545', color: 'white', border: 'none' }}
                            >
                              Trinti
                            </button>
                          </div>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <div style={{ padding: '12px', textAlign: 'center', color: '#999', border: '1px dashed #ddd', borderRadius: '8px', backgroundColor: '#fafafa' }}>
                      Nėra pridėtų vežėjų arba sandėlių
                    </div>
                  )}
                  </div>
                </div>

                {/* Kainos ir Kitos išlaidos - dvi stulpeliai */}
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', marginBottom: '12px' }}>
                  {/* Kairė pusė - Kainos */}
                  <div style={{ border: '1px solid #dee2e6', borderRadius: '4px', padding: '10px', backgroundColor: '#fff' }}>
                    <h4 style={{ margin: '0 0 8px 0', fontSize: '14px', fontWeight: 'bold', color: '#495057' }}>💰 Kainos</h4>
                    
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                      {/* 1. Kaina klientui (be PVM) */}
                      <div className="form-group" style={{ marginBottom: '0' }}>
                        <label style={{ fontSize: '12px', marginBottom: '4px' }}>Kaina klientui (be PVM) *</label>
                        <input
                          type="number"
                          step="0.01"
                          value={formData.client_price_net}
                          onChange={handleClientPriceChange}
                          placeholder="0.00"
                          required
                          style={{ width: '100%' }}
                        />
                      </div>

                      {/* 2. PVM tarifas */}
                      <div className="form-group" style={{ marginBottom: '0' }}>
                        <label style={{ fontSize: '12px', marginBottom: '4px' }}>PVM tarifas *</label>
                        <select
                          value={pvmRates.find(r => r.rate === formData.vat_rate && r.article === formData.vat_rate_article)?.id || ''}
                          onChange={(e) => {
                            const selectedRate = pvmRates.find(r => r.id === parseInt(e.target.value));
                            if (selectedRate) {
                              setFormData({
                                ...formData,
                                vat_rate: selectedRate.rate,
                                vat_rate_article: selectedRate.article || ''
                              });
                            }
                          }}
                          required
                          style={{ width: '100%', padding: '6px 8px', fontSize: '12px', border: '1px solid #ccc', borderRadius: '4px' }}
                        >
                          <option value="">-- Pasirinkite PVM tarifą --</option>
                          {pvmRates.map((rate) => (
                            <option key={rate.id} value={rate.id}>
                              {rate.rate}%{rate.article ? ` - ${rate.article}` : ''}
                            </option>
                          ))}
                        </select>
                        {formData.vat_rate_article && (
                          <small style={{ color: '#666', fontSize: '11px', display: 'block', marginTop: '3px' }}>
                            Straipsnis: {formData.vat_rate_article}
                          </small>
                        )}
                        {pvmRates.length === 0 && (
                          <small style={{ color: '#dc3545', fontSize: '11px', display: 'block', marginTop: '3px' }}>
                            PVM tarifų nėra. Prašome pridėti nustatymuose.
                          </small>
                        )}
                      </div>

                      {/* 3. Pervežimo/sandėliavimo išlaidos (be PVM) */}
                      <div className="form-group" style={{ marginBottom: '0' }}>
                        <label style={{ fontSize: '12px', marginBottom: '4px' }}>Pervežimo/sandėliavimo išlaidos (be PVM):</label>
                        <input
                          type="text"
                          value={(() => {
                            const total = orderCarriers.reduce((sum, c) => sum + (c.price_net ? parseFloat(String(c.price_net)) : 0), 0);
                            return `${total.toFixed(2)} EUR`;
                          })()}
                          disabled
                          style={{ width: '100%', backgroundColor: '#f9f9f9', cursor: 'not-allowed' }}
                        />
                      </div>

                      {/* 4. Kitos išlaidos */}
                      <div className="form-group" style={{ marginBottom: '0' }}>
                        <label style={{ fontSize: '12px', marginBottom: '4px' }}>Kitos išlaidos:</label>
                        <input
                          type="text"
                          value={(() => {
                            const total = formData.other_costs.reduce((sum, c) => sum + (typeof c.amount === 'number' ? c.amount : parseFloat(String(c.amount)) || 0), 0);
                            return `${total.toFixed(2)} EUR`;
                          })()}
                          disabled
                          style={{ width: '100%', backgroundColor: '#f9f9f9', cursor: 'not-allowed' }}
                        />
                      </div>

                      {/* 5. Pelnas (be PVM) - buvo "Mano kaina" */}
                      <div className="form-group" style={{ marginBottom: '0' }}>
                        <label style={{ fontSize: '12px', marginBottom: '4px' }}>
                          Pelnas (be PVM):
                          <span style={{ fontSize: '10px', color: '#666', fontWeight: 'normal', marginLeft: '6px' }}>
                            (auto)
                          </span>
                        </label>
                        <input
                          type="number"
                          step="0.01"
                          value={formData.my_price_net}
                          onChange={handleMyPriceChange}
                          placeholder="0.00"
                          readOnly={!myPriceManuallyEdited.current}
                          style={{ 
                            width: '100%',
                            ...(myPriceManuallyEdited.current ? {} : { backgroundColor: '#f9f9f9', cursor: 'not-allowed' })
                          }}
                        />
                        <small style={{ color: '#666', fontSize: '10px', display: 'block', marginTop: '3px' }}>
                          Automatiškai: Kaina klientui - Visos išlaidos (vežėjų kainos + kitos išlaidos)
                        </small>
                      </div>
                    </div>
                  </div>

                  {/* Dešinė pusė - Kitos išlaidos */}
                  <div style={{ border: '1px solid #dee2e6', borderRadius: '4px', padding: '10px', backgroundColor: '#fff' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
                      <h4 style={{ margin: '0 0 0 0', fontSize: '14px', fontWeight: 'bold', color: '#495057' }}>💸 Kitos išlaidos</h4>
                      <button
                        type="button"
                        className="button button-secondary"
                        onClick={() => {
                          setEditingOtherCost({ description: '', amount: '' });
                          setEditingOtherCostIndex(null);
                        }}
                        style={{ padding: '4px 8px', fontSize: '12px' }}
                      >
                        + Pridėti išlaidą
                      </button>
                    </div>
                      
                      {formData.other_costs.length > 0 && (
                        <div style={{ border: '1px solid #ddd', borderRadius: '4px', padding: '4px', backgroundColor: 'white', marginBottom: '4px', maxHeight: '120px', overflowY: 'auto' }}>
                          {formData.other_costs.map((cost, index) => (
                            <div 
                              key={index}
                              style={{ 
                                display: 'flex', 
                                justifyContent: 'space-between', 
                                alignItems: 'center',
                                padding: '6px',
                                marginBottom: index < formData.other_costs.length - 1 ? '4px' : '0',
                                borderBottom: index < formData.other_costs.length - 1 ? '1px solid #eee' : 'none',
                                backgroundColor: '#fafafa',
                                borderRadius: '4px'
                              }}
                            >
                              <div style={{ flex: 1 }}>
                                <div style={{ fontWeight: '500', marginBottom: '3px' }}>{cost.description}</div>
                                <div style={{ fontSize: '13px', color: '#666' }}>
                                  {typeof cost.amount === 'number' ? cost.amount.toFixed(2) : parseFloat(String(cost.amount)).toFixed(2)} EUR
                                </div>
                              </div>
                              <div style={{ display: 'flex', gap: '6px' }}>
                                <button
                                  type="button"
                                  className="button button-secondary"
                                  onClick={() => {
                                    setEditingOtherCost({ description: cost.description, amount: String(cost.amount) });
                                    setEditingOtherCostIndex(index);
                                  }}
                                  style={{ padding: '4px 8px', fontSize: '12px' }}
                                >
                                  Redaguoti
                                </button>
                                <button
                                  type="button"
                                  className="button button-secondary"
                                onClick={() => {
                                  const newCosts = [...formData.other_costs];
                                  newCosts.splice(index, 1);
                                  setFormData({ ...formData, other_costs: newCosts });
                                  // Reset manual edit flag when other costs change, so my_price recalculates
                                  myPriceManuallyEdited.current = false;
                                  // Iškarto apskaičiuoti "mano kainą" po kitos išlaidos ištrynimo
                                  setTimeout(() => calculateMyPrice(true), 50);
                                }}
                                  style={{ padding: '4px 8px', fontSize: '12px', backgroundColor: '#dc3545', color: 'white', border: 'none' }}
                                >
                                  Trinti
                                </button>
                              </div>
                            </div>
                          ))}
                        </div>
                      )}

                      {/* Bendras kitų išlaidų suma */}
                      {formData.other_costs.length > 0 && (
                        <div style={{ textAlign: 'right', fontSize: '14px', fontWeight: '500', color: '#666', marginTop: '8px' }}>
                          Iš viso kitų išlaidų: {formData.other_costs.reduce((sum, c) => sum + (typeof c.amount === 'number' ? c.amount : parseFloat(String(c.amount)) || 0), 0).toFixed(2)} EUR
                        </div>
                      )}
                  </div>
                </div>

                {/* Pastabos */}
                <div style={{ marginBottom: '12px' }}>
                  <div className="form-group" style={{ marginBottom: '0' }}>
                    <label style={{ fontSize: '12px', marginBottom: '4px' }}>Pastabos</label>
                    <AutocompleteTextarea
                      fieldType="order_notes"
                      value={formData.notes}
                      onChange={(value) => setFormData({ ...formData, notes: value })}
                      rows={showEditForm ? 3 : 4}
                      style={{ width: '100%', resize: 'vertical' }}
                    />
                  </div>
                </div>

                <div style={{ display: 'flex', gap: '8px', justifyContent: 'flex-end', marginTop: '12px', paddingTop: '12px', borderTop: '1px solid #dee2e6' }}>
                  <button
                    type="button"
                    className="button button-secondary"
                    onClick={() => { setShowCreateForm(false); setShowEditForm(false); resetForm(); }}
                    style={{ padding: '8px 16px', fontSize: '13px' }}
                  >
                    Atšaukti
                  </button>
                  <button type="submit" className="button" style={{ padding: '8px 16px', fontSize: '13px' }}>
                    {showEditForm ? 'Išsaugoti' : 'Sukurti'}
                  </button>
                </div>
              </form>
              </div>
            </div>
          </div>
        )}

        {/* Carrier/Warehouse Form Modal */}
        {showCarrierForm && (
          <div className="modal-overlay" onClick={() => { setShowCarrierForm(false); setEditingCarrier(null); setCarrierPartnerSearch(''); }}>
            <div className="modal-content" style={{ maxWidth: '600px' }} onClick={(e) => e.stopPropagation()}>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                <h3 style={{ margin: 0 }}>
                  {editingCarrier?.id ? 'Redaguoti' : 'Pridėti'} {carrierFormType === 'carrier' ? 'vežėją' : 'sandėlį'}
                </h3>
                <button
                  onClick={() => { setShowCarrierForm(false); setEditingCarrier(null); setEditingCarrierIndex(null); setCarrierPartnerSearch(''); setSelectedCarrierPartnerName(''); }}
                  style={{
                    background: 'none',
                    border: 'none',
                    fontSize: '24px',
                    color: '#999',
                    cursor: 'pointer'
                  }}
                >
                  ×
                </button>
              </div>

              <div className="form-group">
                <label>Partneris *</label>
                <div style={{ position: 'relative' }}>
                  <input
                    type="text"
                    placeholder="Ieškoti partnerio (įveskite bent 2 simbolius)..."
                    value={carrierPartnerSearch}
                    onChange={(e) => setCarrierPartnerSearch(e.target.value)}
                    required
                  />
                  {carrierPartners.length > 0 && (
                    <div className="client-dropdown">
                      {carrierPartners.map((partner) => (
                        <div
                          key={partner.id}
                          className="client-dropdown-item"
                          onClick={() => handleCarrierPartnerSelect(partner)}
                        >
                          {partner.name} ({partner.code})
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </div>

              {editingCarrier && (
                <>
                  <div className="form-group">
                    <label>Kaina be PVM</label>
                    <input
                      type="number"
                      step="0.01"
                      value={editingCarrier.price_net ? (typeof editingCarrier.price_net === 'string' ? editingCarrier.price_net : String(editingCarrier.price_net)) : ''}
                      onChange={(e) => {
                        const value = e.target.value;
                        setEditingCarrier({
                          ...editingCarrier,
                          price_net: value === '' ? null : value
                        });
                        // Reset manual edit flag when carrier price changes, so my_price recalculates
                        myPriceManuallyEdited.current = false;
                        // Iškarto apskaičiuoti "mano kainą" kai keičiama vežėjo kaina modalyje
                        setTimeout(() => calculateMyPrice(true), 50);
                      }}
                    />
                  </div>

                  <div className="form-row">
                    <div className="form-group">
                      <label>Maršrutas iš</label>
                      <div style={{ position: 'relative' }}>
                        <input
                          type="text"
                          value={editingCarrier.route_from || ''}
                          onChange={(e) => {
                            setEditingCarrier({
                              ...editingCarrier,
                              route_from: e.target.value
                            });
                            setShowCarrierRouteFromSuggestions(e.target.value.length > 0);
                          }}
                          onFocus={() => setShowCarrierRouteFromSuggestions((editingCarrier.route_from || '').length > 0)}
                          onBlur={() => setTimeout(() => setShowCarrierRouteFromSuggestions(false), 200)}
                        />
                        {showCarrierRouteFromSuggestions && routeFromSuggestions.length > 0 && (
                          <div className="client-dropdown" style={{ maxHeight: '200px', overflowY: 'auto' }}>
                            {routeFromSuggestions
                              .filter(route => route.toLowerCase().includes((editingCarrier.route_from || '').toLowerCase()))
                              .slice(0, 10)
                              .map((route, index) => (
                                <div
                                  key={index}
                                  className="client-dropdown-item"
                                  onClick={() => {
                                    setEditingCarrier({
                                      ...editingCarrier,
                                      route_from: route
                                    });
                                    setShowCarrierRouteFromSuggestions(false);
                                  }}
                                >
                                  {route}
                                </div>
                              ))}
                          </div>
                        )}
                      </div>
                    </div>
                    <div className="form-group">
                      <label>Maršrutas į</label>
                      <div style={{ position: 'relative' }}>
                        <input
                          type="text"
                          value={editingCarrier.route_to || ''}
                          onChange={async (e) => {
                            const value = e.target.value;
                            setEditingCarrier({
                              ...editingCarrier,
                              route_to: value
                            });
                            setShowCarrierRouteToSuggestions(value.length > 0);
                            await fetchRouteSuggestions();
                          }}
                          onFocus={async () => {
                            await fetchRouteSuggestions();
                            setShowCarrierRouteToSuggestions((editingCarrier.route_to || '').length > 0);
                          }}
                          onBlur={async () => {
                            if (editingCarrier?.route_to) {
                              await ensureCityExists(editingCarrier.route_to);
                              await fetchRouteSuggestions();
                            }
                            setTimeout(() => setShowCarrierRouteToSuggestions(false), 200);
                          }}
                        />
                        {showCarrierRouteToSuggestions && routeToSuggestions.length > 0 && (
                          <div className="client-dropdown" style={{ maxHeight: '200px', overflowY: 'auto' }}>
                            {routeToSuggestions
                              .filter(route => route.toLowerCase().includes((editingCarrier.route_to || '').toLowerCase()))
                              .slice(0, 10)
                              .map((route, index) => (
                                <div
                                  key={index}
                                  className="client-dropdown-item"
                                  onClick={() => {
                                    setEditingCarrier({
                                      ...editingCarrier,
                                      route_to: route
                                    });
                                    setShowCarrierRouteToSuggestions(false);
                                  }}
                                >
                                  {route}
                                </div>
                              ))}
                          </div>
                        )}
                      </div>
                    </div>
                  </div>

                  <div className="form-row">
                    <div className="form-group">
                      <label>Pakrovimo data</label>
                      <input
                        type="date"
                        value={editingCarrier.loading_date ? editingCarrier.loading_date.split('T')[0] : ''}
                        onChange={(e) => setEditingCarrier({
                          ...editingCarrier,
                          loading_date: e.target.value ? `${e.target.value}T00:00` : null
                        })}
                      />
                    </div>
                    <div className="form-group">
                      <label>Iškrovimo data</label>
                      <input
                        type="date"
                        value={editingCarrier.unloading_date ? editingCarrier.unloading_date.split('T')[0] : ''}
                        onChange={(e) => setEditingCarrier({
                          ...editingCarrier,
                          unloading_date: e.target.value ? `${e.target.value}T00:00` : null
                        })}
                      />
                    </div>
                  </div>

                  <div className="form-row">
                    <div className="form-group">
                      <label>Vežimo/sandėlio būklė</label>
                      <select
                        value={editingCarrier.status}
                        onChange={(e) => setEditingCarrier({
                          ...editingCarrier,
                          status: e.target.value as 'new' | 'in_progress' | 'completed' | 'cancelled',
                          status_display: e.target.value === 'new' ? 'Naujas' : 
                            e.target.value === 'in_progress' ? 'Vykdomas' :
                            e.target.value === 'completed' ? 'Baigtas' : 'Atšauktas'
                        })}
                      >
                        <option value="new">Naujas</option>
                        <option value="in_progress">Vykdomas</option>
                        <option value="completed">Baigtas</option>
                        <option value="cancelled">Atšauktas</option>
                      </select>
                    </div>
                    <div className="form-group">
                      <label>Mokėjimo būklė</label>
                      <select
                        value={editingCarrier.payment_status}
                        onChange={(e) => setEditingCarrier({
                          ...editingCarrier,
                          payment_status: e.target.value as 'not_paid' | 'partially_paid' | 'paid',
                          payment_status_display: e.target.value === 'not_paid' ? 'Neapmokėta' :
                            e.target.value === 'partially_paid' ? 'Dalinai apmokėta' : 'Apmokėta'
                        })}
                      >
                        <option value="not_paid">Neapmokėta</option>
                        <option value="partially_paid">Dalinai apmokėta</option>
                        <option value="paid">Apmokėta</option>
                      </select>
                    </div>
                  </div>

                  <div className="form-row">
                    <div className="form-group">
                      <label>Dokumentų statusas</label>
                      <select
                        value={editingCarrier.documents_status || 'not_received'}
                        onChange={(e) => setEditingCarrier({
                          ...editingCarrier,
                          documents_status: e.target.value as 'not_received' | 'waiting' | 'received',
                          documents_status_display: e.target.value === 'received' ? 'Gauta' : 
                            e.target.value === 'waiting' ? 'Laukiama' : 'Negauta'
                        })}
                      >
                        <option value="not_received">Negauta</option>
                        <option value="waiting">Laukiama</option>
                        <option value="received">Gauta</option>
                      </select>
                    </div>
                  </div>

                  <div style={{ marginTop: '20px', borderTop: '1px solid #ddd', paddingTop: '15px' }}>
                    <h4 style={{ marginBottom: '15px', fontSize: '14px' }}>Sąskaitų statusas</h4>
                    <div className="form-row">
                      <div className="form-group">
                        <label style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                          <input
                            type="checkbox"
                            checked={editingCarrier.invoice_issued}
                            onChange={(e) => setEditingCarrier({
                              ...editingCarrier,
                              invoice_issued: e.target.checked
                            })}
                          />
                          <span>Išrašyta sąskaita</span>
                        </label>
                      </div>
                      <div className="form-group">
                        <label style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                          <input
                            type="checkbox"
                            checked={editingCarrier.invoice_received}
                            onChange={(e) => setEditingCarrier({
                              ...editingCarrier,
                              invoice_received: e.target.checked
                            })}
                          />
                          <span>Gauta sąskaita</span>
                        </label>
                      </div>
                    </div>
                  </div>

                  <div style={{ marginTop: '20px', borderTop: '1px solid #ddd', paddingTop: '15px' }}>
                    <h4 style={{ marginBottom: '15px', fontSize: '14px' }}>Sąskaitos apmokėjimo informacija</h4>
                    <div className="form-row">
                      <div className="form-group">
                        <label>Kada gauta sąskaita</label>
                        <input
                          type="date"
                          value={editingCarrier.invoice_received_date ? editingCarrier.invoice_received_date.substring(0, 10) : ''}
                          onChange={(e) => {
                            const receivedDate = e.target.value || null;
                            const paymentDays = editingCarrier.payment_days || null;
                            let calculatedDueDate = null;
                            
                            // Apskaičiuojame due_date jei yra abu: received_date ir payment_days
                            if (receivedDate && paymentDays) {
                              const date = new Date(receivedDate);
                              date.setDate(date.getDate() + paymentDays);
                              calculatedDueDate = date.toISOString().split('T')[0];
                            }
                            
                            setEditingCarrier({
                              ...editingCarrier,
                              invoice_received_date: receivedDate,
                              due_date: calculatedDueDate || editingCarrier.due_date || null
                            });
                          }}
                        />
                      </div>
                      <div className="form-group">
                        <label>Mokėjimo terminas (dienos)</label>
                        <input
                          type="number"
                          min="0"
                          placeholder="pvz. 30"
                          value={editingCarrier.payment_days || ''}
                          onChange={(e) => {
                            const days = e.target.value ? parseInt(e.target.value) : null;
                            const receivedDate = editingCarrier.invoice_received_date;
                            let calculatedDueDate = null;
                            
                            // Apskaičiuojame due_date jei yra abu: received_date ir payment_days
                            if (receivedDate && days !== null && days > 0) {
                              const date = new Date(receivedDate);
                              date.setDate(date.getDate() + days);
                              calculatedDueDate = date.toISOString().split('T')[0];
                            }
                            
                            setEditingCarrier({
                              ...editingCarrier,
                              payment_days: days,
                              due_date: calculatedDueDate || editingCarrier.due_date || null
                            });
                          }}
                        />
                      </div>
                    </div>
                    <div className="form-row">
                      <div className="form-group">
                        <label>Apmokėti iki</label>
                        <input
                          type="date"
                          value={editingCarrier.due_date ? editingCarrier.due_date.substring(0, 10) : ''}
                          onChange={(e) => setEditingCarrier({
                            ...editingCarrier,
                            due_date: e.target.value || null
                          })}
                        />
                        <small style={{ fontSize: '11px', color: '#666', marginTop: '4px', display: 'block' }}>
                          (galima pasirinkti tiesiogiai arba bus apskaičiuota pagal gavimo datą + dienų skaičių)
                        </small>
                      </div>
                      <div className="form-group">
                        <label>Apmokėjimo data</label>
                        <input
                          type="date"
                          value={editingCarrier.payment_date ? editingCarrier.payment_date.substring(0, 10) : ''}
                          onChange={(e) => setEditingCarrier({
                            ...editingCarrier,
                            payment_date: e.target.value || null
                          })}
                        />
                        <small style={{ fontSize: '11px', color: '#666', marginTop: '4px', display: 'block' }}>
                          (data, kai tikrai apmokėjome sąskaitą)
                        </small>
                      </div>
                    </div>
                  </div>

                  <div className="form-group">
                    <label>Pastabos</label>
                    <AutocompleteTextarea
                      fieldType="carrier_notes"
                      value={editingCarrier.notes || ''}
                      onChange={(value) => setEditingCarrier({
                        ...editingCarrier,
                        notes: value
                      })}
                      rows={3}
                    />
                  </div>
                </>
              )}

              <div style={{ display: 'flex', gap: '10px', marginTop: '20px' }}>
                <button
                  type="button"
                  className="button"
                  onClick={handleSaveCarrier}
                  disabled={!editingCarrier || !editingCarrier.partner_id}
                >
                  Išsaugoti
                </button>
                <button
                  type="button"
                  className="button button-secondary"
                  onClick={() => { setShowCarrierForm(false); setEditingCarrier(null); setEditingCarrierIndex(null); setCarrierPartnerSearch(''); setSelectedCarrierPartnerName(''); }}
                >
                  Atšaukti
                </button>
              </div>
            </div>
          </div>
        )}

        {/* CargoItem Form Modal */}
        {showCargoItemForm && editingCargoItem && (
          <div className="modal-overlay" onClick={() => { setShowCargoItemForm(false); setEditingCargoItem(null); setEditingCargoItemIndex(null); }}>
            <div className="modal-content" style={{ maxWidth: '900px', maxHeight: '95vh', overflowY: 'auto' }} onClick={(e) => e.stopPropagation()}>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                <h3 style={{ margin: 0 }}>
                  {editingCargoItemIndex !== null ? 'Redaguoti' : 'Pridėti'} krovinio aprašymą
                </h3>
                <button
                  onClick={() => { setShowCargoItemForm(false); setEditingCargoItem(null); setEditingCargoItemIndex(null); }}
                  style={{
                    background: 'none',
                    border: 'none',
                    fontSize: '24px',
                    color: '#999',
                    cursor: 'pointer'
                  }}
                >
                  ×
                </button>
              </div>

              <div className="form-group">
                <AutocompleteField
                  fieldType="cargo_description"
                  value={editingCargoItem.description || ''}
                  onChange={(value) => setEditingCargoItem({ ...editingCargoItem, description: value })}
                  label="Aprašymas"
                  placeholder="Trumpas krovinių aprašymas"
                />
              </div>

              <div className="form-group">
                <AutocompleteField
                  fieldType="vehicle_type"
                  value={editingCargoItem.vehicle_type || ''}
                  onChange={(value) => setEditingCargoItem({ ...editingCargoItem, vehicle_type: value })}
                  label="Mašinos tipas"
                  placeholder="Pvz: Sunkvežimis, Furgonas..."
                />
              </div>

              <div className="form-row-4">
                <div className="form-group">
                  <label>Svoris (kg)</label>
                  <input
                    type="number"
                    step="0.01"
                    value={editingCargoItem.weight_kg || ''}
                    onChange={(e) => setEditingCargoItem({ ...editingCargoItem, weight_kg: e.target.value ? parseFloat(e.target.value) : null })}
                    placeholder="0.00"
                  />
                </div>
                <div className="form-group">
                  <label>LDM</label>
                  <input
                    type="number"
                    step="0.01"
                    value={editingCargoItem.ldm || ''}
                    onChange={(e) => setEditingCargoItem({ ...editingCargoItem, ldm: e.target.value ? parseFloat(e.target.value) : null })}
                    placeholder="0.00"
                  />
                </div>
                <div className="form-group">
                  <label>Ilgis (m)</label>
                  <input
                    type="number"
                    step="0.01"
                    value={editingCargoItem.length_m || ''}
                    onChange={(e) => setEditingCargoItem({ ...editingCargoItem, length_m: e.target.value ? parseFloat(e.target.value) : null })}
                    placeholder="0.00"
                  />
                </div>
                <div className="form-group">
                  <label>Plotis (m)</label>
                  <input
                    type="number"
                    step="0.01"
                    value={editingCargoItem.width_m || ''}
                    onChange={(e) => setEditingCargoItem({ ...editingCargoItem, width_m: e.target.value ? parseFloat(e.target.value) : null })}
                    placeholder="0.00"
                  />
                </div>
              </div>

              <div className="form-row-4" style={{ marginTop: '8px' }}>
                <div className="form-group">
                  <label>Aukštis (m)</label>
                  <input
                    type="number"
                    step="0.01"
                    value={editingCargoItem.height_m || ''}
                    onChange={(e) => setEditingCargoItem({ ...editingCargoItem, height_m: e.target.value ? parseFloat(e.target.value) : null })}
                    placeholder="0.00"
                  />
                </div>
                <div className="form-group"></div>
                <div className="form-group"></div>
                <div className="form-group"></div>
              </div>

              <div className="form-row-4" style={{ marginTop: '10px' }}>
                <div className="form-group">
                  <label style={{ display: 'flex', alignItems: 'center', gap: '8px', cursor: 'pointer' }}>
                    <input
                      type="checkbox"
                      checked={editingCargoItem.is_palletized || false}
                      onChange={(e) => setEditingCargoItem({ ...editingCargoItem, is_palletized: e.target.checked })}
                      style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                    />
                    <span>Paletemis</span>
                  </label>
                </div>
                <div className="form-group">
                  <label style={{ display: 'flex', alignItems: 'center', gap: '8px', cursor: 'pointer' }}>
                    <input
                      type="checkbox"
                      checked={editingCargoItem.is_stackable || false}
                      onChange={(e) => setEditingCargoItem({ ...editingCargoItem, is_stackable: e.target.checked })}
                      style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                    />
                    <span>Stabeliuojamas</span>
                  </label>
                </div>
                <div className="form-group">
                  <label style={{ display: 'flex', alignItems: 'center', gap: '8px', cursor: 'pointer' }}>
                    <input
                      type="checkbox"
                      checked={editingCargoItem.requires_forklift || false}
                      onChange={(e) => setEditingCargoItem({ ...editingCargoItem, requires_forklift: e.target.checked })}
                      style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                    />
                    <span>Reikalingas keltuvas</span>
                  </label>
                </div>
                <div className="form-group">
                  <label style={{ display: 'flex', alignItems: 'center', gap: '8px', cursor: 'pointer' }}>
                    <input
                      type="checkbox"
                      checked={editingCargoItem.requires_crane || false}
                      onChange={(e) => setEditingCargoItem({ ...editingCargoItem, requires_crane: e.target.checked })}
                      style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                    />
                    <span>Reikalingas kranas</span>
                  </label>
                </div>
              </div>

              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '8px', marginTop: '10px' }}>
                <label style={{ display: 'flex', alignItems: 'center', gap: '10px', padding: '8px', borderRadius: '4px', backgroundColor: editingCargoItem.requires_special_equipment ? '#e7f3ff' : '#f8f9fa', cursor: 'pointer', transition: 'background-color 0.2s' }}>
                  <input
                    type="checkbox"
                    checked={editingCargoItem.requires_special_equipment || false}
                    onChange={(e) => setEditingCargoItem({ ...editingCargoItem, requires_special_equipment: e.target.checked })}
                    style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                  />
                  <span style={{ fontSize: '14px' }}>Reikalinga speciali įranga</span>
                </label>
                <label style={{ display: 'flex', alignItems: 'center', gap: '10px', padding: '8px', borderRadius: '4px', backgroundColor: editingCargoItem.fragile ? '#f8d7da' : '#f8f9fa', cursor: 'pointer', transition: 'background-color 0.2s' }}>
                  <input
                    type="checkbox"
                    checked={editingCargoItem.fragile || false}
                    onChange={(e) => setEditingCargoItem({ ...editingCargoItem, fragile: e.target.checked })}
                    style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                  />
                  <span style={{ fontSize: '14px' }}>Trapus</span>
                </label>
                <label style={{ display: 'flex', alignItems: 'center', gap: '10px', padding: '8px', borderRadius: '4px', backgroundColor: editingCargoItem.hazardous ? '#f8d7da' : '#f8f9fa', cursor: 'pointer', transition: 'background-color 0.2s' }}>
                  <input
                    type="checkbox"
                    checked={editingCargoItem.hazardous || false}
                    onChange={(e) => setEditingCargoItem({ ...editingCargoItem, hazardous: e.target.checked })}
                    style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                  />
                  <span style={{ fontSize: '14px' }}>Pavojingas</span>
                </label>
                <label style={{ display: 'flex', alignItems: 'center', gap: '10px', padding: '8px', borderRadius: '4px', backgroundColor: editingCargoItem.temperature_controlled ? '#d1ecf1' : '#f8f9fa', cursor: 'pointer', transition: 'background-color 0.2s' }}>
                  <input
                    type="checkbox"
                    checked={editingCargoItem.temperature_controlled || false}
                    onChange={(e) => setEditingCargoItem({ ...editingCargoItem, temperature_controlled: e.target.checked })}
                    style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                  />
                  <span style={{ fontSize: '14px' }}>Temperatūros kontrolė</span>
                </label>
                <label style={{ display: 'flex', alignItems: 'center', gap: '10px', padding: '8px', borderRadius: '4px', backgroundColor: editingCargoItem.requires_permit ? '#fff3cd' : '#f8f9fa', cursor: 'pointer', transition: 'background-color 0.2s' }}>
                  <input
                    type="checkbox"
                    checked={editingCargoItem.requires_permit || false}
                    onChange={(e) => setEditingCargoItem({ ...editingCargoItem, requires_permit: e.target.checked })}
                    style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                  />
                  <span style={{ fontSize: '14px' }}>Reikalingas leidimas</span>
                </label>
              </div>

              <div style={{ display: 'flex', gap: '10px', marginTop: '20px' }}>
                <button type="button" className="button" onClick={handleSaveCargoItem}>
                  Išsaugoti
                </button>
                <button
                  type="button"
                  className="button button-secondary"
                  onClick={() => { setShowCargoItemForm(false); setEditingCargoItem(null); setEditingCargoItemIndex(null); }}
                >
                  Atšaukti
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Other Costs Modal */}
        {editingOtherCost !== null && (
          <div className="modal-overlay" onClick={() => { setEditingOtherCost(null); setEditingOtherCostIndex(null); }}>
            <div className="modal-content" style={{ maxWidth: '500px' }} onClick={(e) => e.stopPropagation()}>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                <h3 style={{ margin: 0 }}>
                  {editingOtherCostIndex !== null ? 'Redaguoti' : 'Pridėti'} išlaidą
                </h3>
                <button
                  onClick={() => { setEditingOtherCost(null); setEditingOtherCostIndex(null); }}
                  style={{
                    background: 'none',
                    border: 'none',
                    fontSize: '24px',
                    cursor: 'pointer',
                    color: '#666',
                    padding: '0',
                    width: '30px',
                    height: '30px',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center'
                  }}
                >
                  ×
                </button>
              </div>

              <div className="form-group">
                <label>Aprašymas:</label>
                <input
                  type="text"
                  value={editingOtherCost.description}
                  onChange={(e) => setEditingOtherCost({ ...editingOtherCost, description: e.target.value })}
                  placeholder="Pvz: Draudimas, Degalai, etc."
                />
              </div>

              <div className="form-group">
                <label>Suma (EUR):</label>
                  <input
                    type="number"
                    step="0.01"
                    value={editingOtherCost.amount}
                    onChange={(e) => {
                      setEditingOtherCost({ ...editingOtherCost, amount: e.target.value });
                      // Iškarto apskaičiuoti "mano kainą" kai keičiama kitos išlaidos suma modalyje
                      setTimeout(() => {
                        // Laikinai atnaujinti formData su nauja kita išlaida dėl apskaičiavimo
                        if (editingOtherCostIndex !== null) {
                          const newCosts = [...formData.other_costs];
                          newCosts[editingOtherCostIndex] = {
                            description: editingOtherCost.description,
                            amount: parseFloat(e.target.value) || 0
                          };
                          setFormData(prev => ({ ...prev, other_costs: newCosts }));
                          // Reset manual edit flag when other costs change, so my_price recalculates
                          myPriceManuallyEdited.current = false;
                          // Iškarto apskaičiuoti "mano kainą"
                          setTimeout(() => calculateMyPrice(true), 50);
                        }
                      }, 100);
                    }}
                    placeholder="0.00"
                  />
              </div>

              <div style={{ display: 'flex', justifyContent: 'flex-end', gap: '10px', marginTop: '20px' }}>
                <button
                  type="button"
                  className="button"
                  onClick={() => {
                    if (!editingOtherCost.description.trim() || !editingOtherCost.amount) {
                      showToast('info', 'Užpildykite visus laukus');
                      return;
                    }
                    
                    const newCost: OtherCost = {
                      description: editingOtherCost.description.trim(),
                      amount: parseFloat(editingOtherCost.amount) || 0
                    };
                    
                    let newCosts: OtherCost[];
                    if (editingOtherCostIndex !== null) {
                      // Atnaujinti esamą
                      newCosts = [...formData.other_costs];
                      newCosts[editingOtherCostIndex] = newCost;
                    } else {
                      // Pridėti naują
                      newCosts = [...formData.other_costs, newCost];
                    }
                    
                    setEditingOtherCost(null);
                    setEditingOtherCostIndex(null);
                    
                    // Reset manual edit flag when other costs change, so my_price recalculates
                    myPriceManuallyEdited.current = false;
                    
                    // Perskaičiuoti mano kainą naudojant naują other_costs array ir atnaujinti formData vienu kartu
                    const clientPrice = formData.client_price_net ? parseFloat(formData.client_price_net) : 0;
                    if (clientPrice > 0) {
                      const transportCost = orderCarriers.reduce((sum, c) => sum + (c.price_net ? parseFloat(String(c.price_net)) : 0), 0);
                      const otherCostsSum = newCosts.reduce((sum, c) => sum + (typeof c.amount === 'number' ? c.amount : parseFloat(String(c.amount)) || 0), 0);
                      const calculatedMyPrice = clientPrice - transportCost - otherCostsSum;
                      setFormData(prev => ({ ...prev, my_price_net: calculatedMyPrice.toFixed(2), other_costs: newCosts }));
                    } else {
                      // Jei nėra kliento kainos, tik atnaujinti other_costs
                      setFormData(prev => ({ ...prev, other_costs: newCosts }));
                    }
                    
                    // Taip pat iškviesti calculateMyPrice po timeout, kad būtų užtikrintas teisingas skaičiavimas
                    setTimeout(() => calculateMyPrice(true), 100);
                  }}
                >
                  Išsaugoti
                </button>
                <button
                  type="button"
                  className="button button-secondary"
                  onClick={() => { setEditingOtherCost(null); setEditingOtherCostIndex(null); }}
                >
                  Atšaukti
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Order Details Modal */}
        {showOrderDetails && selectedOrder && (
          <div className="modal-overlay" onClick={() => { setShowOrderDetails(false); setSelectedOrder(null); }}>
            <div className="modal-content modal-large" onClick={(e) => e.stopPropagation()} style={{ maxWidth: '1200px', maxHeight: '95vh', display: 'flex', flexDirection: 'column' }}>
              <div className="modal-header" style={{ padding: '12px 20px', borderBottom: '1px solid #dee2e6', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                <div>
                  <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600' }}>
                    {selectedOrder.order_number || `Užsakymas #${selectedOrder.id}`}
                  </h2>
                  <div style={{ marginTop: '3px', fontSize: '12px', color: '#666' }}>
                    Sukurta: {new Date(selectedOrder.created_at).toLocaleString('lt-LT')}
                  </div>
                </div>
                <div style={{ display: 'flex', gap: '8px' }}>
                  <button
                    className="button button-secondary"
                    style={{ padding: '6px 12px', fontSize: '13px' }}
                    onClick={async (e) => {
                      e.stopPropagation();
                      try {
                        const token = localStorage.getItem('token');
                        const baseUrl = process.env.REACT_APP_API_URL?.replace('/api', '') || '';
                        const url = `${baseUrl}/api/orders/orders/${selectedOrder.id}/preview/`;
                        
                        // Naudoti fetch, kad gautume HTML kaip tekstą
                        const response = await fetch(url, {
                          headers: {
                            'Authorization': `Bearer ${token}`,
                            'Accept': 'text/html',
                          },
                        });
                        
                        if (!response.ok) {
                          const errorText = await response.text();
                          throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 200)}`);
                        }
                        
                        const htmlContent = await response.text();
                        
                        if (!htmlContent || htmlContent.trim().length === 0) {
                          throw new Error('Gautas tuščias atsakymas');
                        }
                        
                        // Sukurti naują tab'ą su HTML turiniu
                        const newWindow = window.open('', '_blank');
                        if (newWindow) {
                          newWindow.document.write(htmlContent);
                          newWindow.document.close();
                        } else {
                          throw new Error('Nepavyko atidaryti naujo lango');
                        }
                      } catch (error: any) {
                        const errorMsg = error.message || error.toString() || 'Nežinoma klaida';
                        showToast('error', `Nepavyko atidaryti peržiūros: ${errorMsg}`);
                      }
                    }}
                  >
                    👁️ Peržiūrėti sutartį
                  </button>
                  <button
                    className="button button-secondary"
                    style={{ padding: '6px 12px', fontSize: '13px', backgroundColor: '#28a745', color: 'white', border: 'none' }}
                    onClick={async (e) => {
                      e.stopPropagation();
                      try {
                        // Atsisiųsti PDF naudojant api instance
                        const response = await api.get(`/orders/orders/${selectedOrder.id}/pdf/`, {
                          responseType: 'blob',
                        });
                        
                        // Sukurti blob URL ir atsisiųsti
                        const blob = new Blob([response.data], { type: 'application/pdf' });
                        const blobUrl = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = blobUrl;
                        link.download = `uzsakymas-${selectedOrder.order_number || selectedOrder.id}.pdf`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(blobUrl);
                        showToast('success', 'PDF sėkmingai atsisiųstas');
                      } catch (error: any) {
                        showToast('error', 'Nepavyko atsisiųsti PDF');
                      }
                    }}
                  >
                    📄 PDF
                  </button>
                  <button 
                    className="button button-secondary" 
                    onClick={handleEditFromDetails}
                    style={{ padding: '6px 12px', fontSize: '13px' }}
                  >
                    ✏️ Redaguoti
                  </button>
                  <button
                    className="button button-secondary"
                    onClick={() => { setShowOrderDetails(false); setSelectedOrder(null); }}
                    style={{ padding: '6px 12px', fontSize: '13px' }}
                  >
                    ✕ Uždaryti
                  </button>
                </div>
              </div>
              
              <div style={{ padding: '15px 20px', overflowY: 'auto', flex: 1 }}>

              {/* Kompaktiškas grid layout - Klientas ir pagrindinė info */}
              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', marginBottom: '12px' }}>
                {/* Klientas - kompaktiškai */}
                <div style={{ 
                  border: '1px solid #dee2e6', 
                  borderRadius: '4px', 
                  padding: '10px', 
                  backgroundColor: '#f8f9fa'
                }}>
                  <h4 style={{ margin: '0 0 8px 0', fontSize: '14px', fontWeight: 'bold', color: '#495057' }}>👤 Klientas</h4>
                  <div style={{ fontSize: '13px', lineHeight: '1.6' }}>
                    <div><strong>{selectedOrder.client.name}</strong></div>
                    <div style={{ fontSize: '12px', color: '#6c757d' }}>Kodas: {selectedOrder.client.code}</div>
                  </div>
                  
                  <div style={{ marginTop: '10px', paddingTop: '10px', borderTop: '1px solid #dee2e6' }}>
                    <div style={{ fontSize: '12px', marginBottom: '4px' }}>
                      <strong>Kaina be PVM:</strong> <span style={{ color: '#28a745', fontWeight: '600' }}>
                        {(() => {
                          const price = selectedOrder.client_price_net || selectedOrder.calculated_client_price_net;
                          if (price) {
                            return `${parseFloat(String(price)).toFixed(2)} €`;
                          }
                          const transportCost = (selectedOrder.carriers || []).reduce((sum: number, c: OrderCarrier) => 
                            sum + (c.price_net ? parseFloat(String(c.price_net)) : 0), 0);
                          const myPrice = selectedOrder.my_price_net ? parseFloat(String(selectedOrder.my_price_net)) : 0;
                          const otherCosts = (selectedOrder.other_costs || []).reduce((sum: number, c: OtherCost) => 
                            sum + (typeof c.amount === 'number' ? c.amount : parseFloat(String(c.amount)) || 0), 0);
                          const total = transportCost + myPrice + otherCosts;
                          return total > 0 ? `${total.toFixed(2)} €` : <span style={{ color: '#999' }}>Nenustatyta</span>;
                        })()}
                      </span>
                    </div>
                    {(() => {
                      const priceNet = selectedOrder.client_price_net || selectedOrder.calculated_client_price_net || 
                        (() => {
                          const transportCost = (selectedOrder.carriers || []).reduce((sum: number, c: OrderCarrier) => 
                            sum + (c.price_net ? parseFloat(String(c.price_net)) : 0), 0);
                          const myPrice = selectedOrder.my_price_net ? parseFloat(String(selectedOrder.my_price_net)) : 0;
                          const otherCosts = (selectedOrder.other_costs || []).reduce((sum: number, c: OtherCost) => 
                            sum + (typeof c.amount === 'number' ? c.amount : parseFloat(String(c.amount)) || 0), 0);
                          return transportCost + myPrice + otherCosts;
                        })();
                      if (priceNet && parseFloat(String(priceNet)) > 0) {
                        const priceNetNum = parseFloat(String(priceNet));
                        const vatRate = parseFloat(selectedOrder.vat_rate || '21');
                        const vatAmount = priceNetNum * (vatRate / 100);
                        const priceWithVat = priceNetNum + vatAmount;
                        return (
                          <>
                            <div style={{ fontSize: '12px', marginBottom: '4px', color: '#6c757d' }}>
                              <strong>PVM ({vatRate}%):</strong> {vatAmount.toFixed(2)} €
                            </div>
                            <div style={{ fontSize: '12px' }}>
                              <strong style={{ fontSize: '13px' }}>Su PVM:</strong> <span style={{ color: '#007bff', fontWeight: '600', fontSize: '13px' }}>{priceWithVat.toFixed(2)} €</span>
                            </div>
                          </>
                        );
                      }
                      return null;
                    })()}
                  </div>

                  <div style={{ marginTop: '10px', paddingTop: '10px', borderTop: '1px solid #dee2e6' }}>
                    <div style={{ fontSize: '12px', fontWeight: '600', marginBottom: '8px', color: '#495057' }}>Statusas:</div>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '6px', fontSize: '12px' }}>
                      {/* Sąskaita */}
                      <div>
                        <div style={{ fontWeight: '600', marginBottom: '2px', color: '#6c757d', fontSize: '11px' }}>Sąskaita:</div>
                        <div style={{ 
                          padding: '6px 8px', 
                          borderRadius: '4px', 
                          backgroundColor: ((selectedOrder.payment_status_info?.invoice_issued ?? selectedOrder.client_invoice_issued) || !!selectedOrder.first_sales_invoice) ? '#d4edda' : '#f8f9fa',
                          color: ((selectedOrder.payment_status_info?.invoice_issued ?? selectedOrder.client_invoice_issued) || !!selectedOrder.first_sales_invoice) ? '#155724' : '#6c757d',
                          fontWeight: ((selectedOrder.payment_status_info?.invoice_issued ?? selectedOrder.client_invoice_issued) || !!selectedOrder.first_sales_invoice) ? '600' : 'normal'
                        }}>
                          {((selectedOrder.payment_status_info?.invoice_issued ?? selectedOrder.client_invoice_issued) || !!selectedOrder.first_sales_invoice) ? 'Išrašyta' : 'Neišrašyta'}
                        </div>
                      </div>
                      
                      {/* Užsakymas */}
                      <div>
                        <div style={{ fontWeight: '600', marginBottom: '2px', color: '#6c757d', fontSize: '11px' }}>Užsakymas:</div>
                        {(() => {
                          const statusInfo = selectedOrder.payment_status_info;
                          const status = statusInfo?.status || selectedOrder.client_payment_status || 'not_paid';
                          const message = statusInfo?.message || selectedOrder.client_payment_status_display || 'Neapmokėta';
                          
                          // Nustatyti spalvą pagal statusą
                          let bgColor = '#f8f9fa';
                          let textColor = '#6c757d';
                          
                          if (status === 'paid') {
                            bgColor = '#d4edda';
                            textColor = '#155724';
                          } else if (status === 'overdue') {
                            bgColor = '#f8d7da';
                            textColor = '#721c24';
                          } else if (status === 'partially_paid') {
                            bgColor = '#fff3cd';
                            textColor = '#856404';
                          } else {
                            bgColor = '#f8f9fa';
                            textColor = '#6c757d';
                          }
                          
                          return (
                            <div style={{ 
                              padding: '6px 8px', 
                              borderRadius: '4px', 
                              backgroundColor: bgColor,
                              color: textColor,
                              fontWeight: '600'
                            }}>
                              {message}
                            </div>
                          );
                        })()}
                      </div>
                    </div>
                  </div>
                  
                  <div style={{ marginTop: '10px', paddingTop: '10px', borderTop: '1px solid #dee2e6' }}>
                    {selectedOrderInvoices && selectedOrderInvoices.length > 0 && (
                      <div style={{ display: 'flex', flexDirection: 'column', gap: '4px', marginBottom: '8px' }}>
                        {selectedOrderInvoices.map((inv) => (
                          <button
                            key={inv.id}
                            onClick={(e) => {
                              e.stopPropagation();
                              window.location.href = `/invoices?sales_id=${inv.id}`;
                            }}
                            style={{
                              padding: '6px 8px',
                              backgroundColor: '#28a745',
                              color: 'white',
                              border: 'none',
                              borderRadius: '4px',
                              cursor: 'pointer',
                              fontSize: '11px',
                              fontWeight: 600,
                              display: 'flex',
                              justifyContent: 'space-between'
                            }}
                          >
                            <span>📄 {inv.invoice_number}</span>
                            <span style={{ opacity: 0.9 }}>{parseFloat(inv.amount_total).toFixed(2)} €</span>
                          </button>
                        ))}
                      </div>
                    )}
                    {!selectedOrder.first_sales_invoice && (
                      <button
                        onClick={async (e) => {
                          e.stopPropagation();
                          setConfirmState({ open:true, title:'Patvirtinkite', message:'Sukurti pardavimo sąskaitą klientui iš šio užsakymo?', onConfirm: async () => {
                            try {
                              const response = await api.post('/invoices/sales/generate_from_order/', {
                                order_id: selectedOrder.id,
                                invoice_type: 'final'
                              });
                              
                              showToast('success', `Pardavimo sąskaita sukurta: ${response.data.invoice_number}`);
                              
                              const orderResponse = await api.get(`/orders/orders/${selectedOrder.id}/`);
                              setSelectedOrder(orderResponse.data);
                              
                              window.location.href = '/invoices';
                            } catch (error: any) {
                              const details = error.response?.data;
                              showToast('error', 'Klaida kuriant pardavimo sąskaitą: ' + (details?.error || details ? JSON.stringify(details) : error.message));
                            } finally { setConfirmState({ open:false }); }
                          }});
                        }}
                        style={{
                          padding: '6px 10px',
                          backgroundColor: '#007bff',
                          color: 'white',
                          border: 'none',
                          borderRadius: '4px',
                          cursor: 'pointer',
                          fontSize: '11px',
                          fontWeight: '600',
                          width: '100%'
                        }}
                      >
                        📄 Sukurti sąskaitą
                      </button>
                    )}
                  </div>
                </div>
                
                {/* Pagrindinė informacija - kompaktiškai */}
                <div style={{ 
                  border: '1px solid #dee2e6', 
                  borderRadius: '4px', 
                  padding: '10px', 
                  backgroundColor: '#fff'
                }}>
                  <h4 style={{ margin: '0 0 8px 0', fontSize: '14px', fontWeight: 'bold', color: '#495057' }}>ℹ️ Informacija</h4>
                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '6px', fontSize: '12px' }}>
                    <div><strong>Tipas:</strong> {selectedOrder.order_type_display}</div>
                    <div><strong>Būsena:</strong> <span className={`badge ${getStatusColor(selectedOrder.status)}`} style={{ fontSize: '11px', padding: '2px 6px' }}>{selectedOrder.status_display}</span></div>
                    <div><strong>Vadybininkas:</strong> {selectedOrder.manager ? selectedOrder.manager.username : '-'}</div>
                    <div><strong>PVM:</strong> {selectedOrder.vat_rate}%</div>
                    {(selectedOrder.route_from_country || selectedOrder.route_from) && (
                      <div style={{ gridColumn: '1 / -1', fontSize: '11px', color: '#6c757d' }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px' }}>
                          <strong>Maršrutas iš:</strong>
                          {selectedOrder.route_from_country && (
                            <span>
                              {[
                                selectedOrder.route_from_country,
                                selectedOrder.route_from_postal_code,
                                selectedOrder.route_from_city,
                                selectedOrder.route_from_address
                              ].filter(Boolean).join(', ')}
                            </span>
                          )}
                          {!selectedOrder.route_from_country && selectedOrder.route_from && (
                            <span>{selectedOrder.route_from}</span>
                          )}
                        </div>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                          <strong>Maršrutas į:</strong>
                          {selectedOrder.route_to_country && (
                            <span>
                              {[
                                selectedOrder.route_to_country,
                                selectedOrder.route_to_postal_code,
                                selectedOrder.route_to_city,
                                selectedOrder.route_to_address
                              ].filter(Boolean).join(', ')}
                            </span>
                          )}
                          {!selectedOrder.route_to_country && selectedOrder.route_to && (
                            <span>{selectedOrder.route_to}</span>
                          )}
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              setShowRouteMap(true);
                            }}
                            style={{
                              padding: '4px 8px',
                              fontSize: '11px',
                              backgroundColor: '#007bff',
                              color: 'white',
                              border: 'none',
                              borderRadius: '4px',
                              cursor: 'pointer',
                              display: 'inline-flex',
                              alignItems: 'center',
                              gap: '4px',
                              marginLeft: '8px'
                            }}
                            title="Atidaryti žemėlapį su maršrutu"
                          >
                            🗺️ Žemėlapis
                          </button>
                        </div>
                      </div>
                    )}
                    {(selectedOrder.loading_date || selectedOrder.unloading_date) && (
                      <div style={{ gridColumn: '1 / -1', fontSize: '11px', color: '#6c757d' }}>
                        {selectedOrder.loading_date && <span>Pakrovimas: {new Date(selectedOrder.loading_date).toLocaleDateString('lt-LT')}</span>}
                        {selectedOrder.loading_date && selectedOrder.unloading_date && <span> • </span>}
                        {selectedOrder.unloading_date && <span>Iškrovimas: {new Date(selectedOrder.unloading_date).toLocaleDateString('lt-LT')}</span>}
                      </div>
                    )}
                    {selectedOrder.price_net && (
                      <div style={{ gridColumn: '1 / -1', fontSize: '12px', marginTop: '4px' }}>
                        <strong>Bazinė kaina be PVM:</strong> {parseFloat(selectedOrder.price_net).toFixed(2)} €
                      </div>
                    )}
                  </div>
                </div>
              </div>

              {/* Vežėjų/Sandėlių ir Krovinių aprašymų sekcija - du stulpeliai */}
              <div style={{ marginTop: '12px', marginBottom: '12px', display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', alignItems: 'start' }}>
                {/* Kairė pusė - Krovinių aprašymai */}
                <div>
                  <h4 style={{ margin: '0 0 8px 0', fontSize: '14px', fontWeight: 'bold', color: '#495057' }}>📦 Krovinių aprašymai</h4>
                  {selectedOrder.cargo_items && selectedOrder.cargo_items.length > 0 ? (
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                      {selectedOrder.cargo_items.map((item: CargoItem, index: number) => (
                      <div
                        key={item.id || index}
                        style={{
                          border: '1px solid #e9ecef',
                          borderRadius: '4px',
                          padding: '8px',
                          backgroundColor: '#f8f9fa'
                        }}
                      >
                        <div style={{ fontWeight: '600', fontSize: '12px', marginBottom: '4px', color: '#495057' }}>
                          {item.sequence_order !== undefined ? `${item.sequence_order + 1}. ` : ''}{item.description || 'Krovinys'}
                        </div>
                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(120px, 1fr))', gap: '6px', fontSize: '11px', color: '#6c757d' }}>
                          {item.weight_kg && <div><strong>Svoris:</strong> {item.weight_kg} kg</div>}
                          {item.ldm && <div><strong>LDM:</strong> {item.ldm}</div>}
                          {(item.length_m || item.width_m || item.height_m) && (
                            <div><strong>Matmenys:</strong> {[item.length_m, item.width_m, item.height_m].filter(Boolean).join(' × ')} m</div>
                          )}
                          {item.vehicle_type && <div><strong>Mašinos tipas:</strong> {item.vehicle_type}</div>}
                        </div>
                        {(item.is_palletized || item.is_stackable || item.requires_forklift || item.requires_crane || item.fragile || item.hazardous || item.temperature_controlled || item.requires_permit) && (
                          <div style={{ marginTop: '4px', fontSize: '11px', display: 'flex', flexWrap: 'wrap', gap: '4px' }}>
                            {item.is_palletized && <span style={{ padding: '2px 6px', backgroundColor: '#d1ecf1', borderRadius: '3px', fontSize: '10px' }}>Paletizuotas</span>}
                            {item.is_stackable && <span style={{ padding: '2px 6px', backgroundColor: '#d1ecf1', borderRadius: '3px', fontSize: '10px' }}>Kraunamas</span>}
                            {item.requires_forklift && <span style={{ padding: '2px 6px', backgroundColor: '#fff3cd', borderRadius: '3px', fontSize: '10px' }}>🔧 Keltuvas</span>}
                            {item.requires_crane && <span style={{ padding: '2px 6px', backgroundColor: '#fff3cd', borderRadius: '3px', fontSize: '10px' }}>🏗️ Kranas</span>}
                            {item.fragile && <span style={{ padding: '2px 6px', backgroundColor: '#f8d7da', borderRadius: '3px', fontSize: '10px' }}>⚠️ Trapus</span>}
                            {item.hazardous && <span style={{ padding: '2px 6px', backgroundColor: '#f8d7da', borderRadius: '3px', fontSize: '10px' }}>☠️ Pavojingas</span>}
                            {item.temperature_controlled && <span style={{ padding: '2px 6px', backgroundColor: '#d1ecf1', borderRadius: '3px', fontSize: '10px' }}>🌡️ Temperatūra</span>}
                            {item.requires_permit && <span style={{ padding: '2px 6px', backgroundColor: '#fff3cd', borderRadius: '3px', fontSize: '10px' }}>📋 Leidimas</span>}
                          </div>
                        )}
                      </div>
                    ))}
                    </div>
                  ) : (
                    <div style={{ padding: '12px', textAlign: 'center', color: '#999', backgroundColor: '#fafafa', borderRadius: '4px', fontSize: '12px' }}>
                      Nėra pridėtų krovinių aprašymų
                    </div>
                  )}
                </div>

                {/* Dešinė pusė - Vežėjai ir sandėliai */}
                <div>
                  <h4 style={{ margin: '0 0 8px 0', fontSize: '14px', fontWeight: 'bold', color: '#495057' }}>🚚 Vežėjai ir sandėliai</h4>
                  {selectedOrder.carriers && selectedOrder.carriers.length > 0 ? (
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                      {selectedOrder.carriers.map((carrier, index) => (
                      <div 
                        key={carrier.id || index}
                        style={{ 
                          border: '1px solid #dee2e6',
                          borderRadius: '4px',
                          padding: '10px',
                          backgroundColor: '#fff',
                          maxWidth: '100%',
                          width: '100%'
                        }}
                      >
                        <div style={{ marginBottom: '8px' }}>
                          <div style={{ fontWeight: '600', fontSize: '13px', marginBottom: '4px', color: carrier.carrier_type === 'carrier' ? '#007bff' : '#ffc107' }}>
                            {carrier.sequence_order + 1}. {carrier.carrier_type_display}: {carrier.partner.name}
                          </div>
                          <div style={{ fontSize: '11px', color: '#6c757d' }}>
                            {carrier.partner.code}
                          </div>
                        </div>

                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '6px', fontSize: '11px', marginBottom: '8px' }}>
                          {carrier.route_from && carrier.route_to && (
                            <div style={{ gridColumn: '1 / -1', color: '#6c757d' }}>
                              <strong>Maršrutas:</strong> {carrier.route_from} → {carrier.route_to}
                            </div>
                          )}
                          {carrier.loading_date && (
                            <div style={{ color: '#6c757d' }}>
                              <strong>Pakrovimas:</strong> {new Date(carrier.loading_date).toLocaleDateString('lt-LT')}
                            </div>
                          )}
                          {carrier.unloading_date && (
                            <div style={{ color: '#6c757d' }}>
                              <strong>Iškrovimas:</strong> {new Date(carrier.unloading_date).toLocaleDateString('lt-LT')}
                            </div>
                          )}
                          {carrier.status_display && (
                            <div>
                              <strong>Būklė:</strong> <span style={{ 
                                padding: '2px 6px',
                                borderRadius: '3px',
                                fontSize: '10px',
                                backgroundColor: carrier.status === 'completed' ? '#d4edda' :
                                  carrier.status === 'in_progress' ? '#d1ecf1' :
                                  carrier.status === 'cancelled' ? '#f8d7da' : '#e2e3e5',
                                color: carrier.status === 'completed' ? '#155724' :
                                  carrier.status === 'in_progress' ? '#0c5460' :
                                  carrier.status === 'cancelled' ? '#721c24' : '#383d41'
                              }}>
                                {carrier.status_display}
                              </span>
                            </div>
                          )}
                          {carrier.price_net && (
                            <div style={{ gridColumn: '1 / -1', fontSize: '11px', marginTop: '4px' }}>
                              <strong>Kaina be PVM:</strong> <span style={{ color: '#28a745', fontWeight: '600' }}>
                                {parseFloat(carrier.price_net).toFixed(2)} €
                                {carrier.price_with_vat && (
                                  <span style={{ marginLeft: '8px', color: '#007bff' }}>
                                    (su PVM: {parseFloat(carrier.price_with_vat).toFixed(2)} €)
                                  </span>
                                )}
                              </span>
                            </div>
                          )}
                        </div>

                        {/* Statuso sekcija */}
                        <div style={{ marginTop: '8px', paddingTop: '8px', borderTop: '1px solid #dee2e6' }}>
                          <div style={{ fontSize: '11px', fontWeight: '600', marginBottom: '6px', color: '#495057' }}>Statusas:</div>
                          <div style={{ display: 'flex', flexDirection: 'column', gap: '6px', fontSize: '11px' }}>
                            {/* Sąskaita */}
                            <div>
                              <div style={{ fontWeight: '600', marginBottom: '2px', color: '#6c757d', fontSize: '10px' }}>Sąskaita:</div>
                              <div style={{ 
                                padding: '4px 6px', 
                                borderRadius: '4px', 
                                backgroundColor: carrier.invoice_received ? '#d4edda' : '#f8f9fa',
                                color: carrier.invoice_received ? '#155724' : '#6c757d',
                                fontWeight: carrier.invoice_received ? '600' : 'normal',
                                display: 'inline-block',
                                marginRight: '8px'
                              }}>
                                {carrier.invoice_received ? 'Gauta' : 'Negauta'}
                              </div>
                              {/* Apmokėjimo statusas */}
                              {(() => {
                                const statusInfo = carrier.payment_status_info;
                                const status = statusInfo?.status || carrier.payment_status || 'not_paid';
                                const message = statusInfo?.message || carrier.payment_status_display || 'Neapmokėtas';
                                
                                let bgColor = '#f8f9fa';
                                let textColor = '#6c757d';
                                
                                if (status === 'paid') {
                                  bgColor = '#d4edda';
                                  textColor = '#155724';
                                } else if (status === 'partially_paid') {
                                  bgColor = '#fff3cd';
                                  textColor = '#856404';
                                } else {
                                  bgColor = '#f8f9fa';
                                  textColor = '#6c757d';
                                }
                                
                                return (
                                  <div style={{ 
                                    padding: '4px 6px', 
                                    borderRadius: '4px', 
                                    backgroundColor: bgColor,
                                    color: textColor,
                                    fontWeight: '600',
                                    display: 'inline-block'
                                  }}>
                                    {message}
                                  </div>
                                );
                              })()}
                              {/* Jei dokumentai ir sąskaita gauta, rodomas mygtukas apmokėjimui */}
                              {carrier.invoice_received && carrier.documents_status === 'received' && carrier.payment_status !== 'paid' && (
                                <button
                                  onClick={async (e) => {
                                    e.stopPropagation();
                                    setConfirmState({
                                      open: true,
                                      title: 'Patvirtinkite',
                                      message: 'Pažymėti, kad sąskaita apmokėta?',
                                      onConfirm: async () => {
                                        try {
                                          const today = new Date().toISOString().split('T')[0];
                                          await api.patch(`/orders/carriers/${carrier.id}/`, {
                                            payment_status: 'paid',
                                            payment_date: today
                                          });
                                          showToast('success', 'Apmokėjimas pažymėtas');
                                          // Atnaujinti užsakymą
                                          const orderResponse = await api.get(`/orders/orders/${selectedOrder.id}/`);
                                          setSelectedOrder(orderResponse.data);
                                        } catch (error: any) {
                                          showToast('error', error.response?.data?.error || 'Klaida atnaujinant apmokėjimo statusą');
                                        } finally {
                                          setConfirmState({ open: false });
                                        }
                                      }
                                    });
                                  }}
                                  style={{
                                    marginLeft: '8px',
                                    padding: '4px 8px',
                                    backgroundColor: '#28a745',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '4px',
                                    cursor: 'pointer',
                                    fontSize: '10px',
                                    fontWeight: '600'
                                  }}
                                >
                                  Pažymėti apmokėta
                                </button>
                              )}
                            </div>
                            
                            {/* Dokumentai */}
                            <div>
                              <div style={{ fontWeight: '600', marginBottom: '2px', color: '#6c757d', fontSize: '10px' }}>Dokumentai:</div>
                              <select
                                value={carrier.documents_status || 'not_received'}
                                onChange={async (e) => {
                                  try {
                                    await api.patch(`/orders/carriers/${carrier.id}/`, {
                                      documents_status: e.target.value
                                    });
                                    showToast('success', 'Dokumentų statusas atnaujintas');
                                    // Atnaujinti užsakymą
                                    const orderResponse = await api.get(`/orders/orders/${selectedOrder.id}/`);
                                    setSelectedOrder(orderResponse.data);
                                  } catch (error: any) {
                                    showToast('error', error.response?.data?.error || 'Klaida atnaujinant dokumentų statusą');
                                  }
                                }}
                                onClick={(e) => e.stopPropagation()}
                                style={{
                                  padding: '4px 6px',
                                  borderRadius: '4px',
                                  border: '1px solid #dee2e6',
                                  fontSize: '11px',
                                  fontWeight: '600',
                                  backgroundColor: 
                                    carrier.documents_status === 'received' ? '#d4edda' : 
                                    carrier.documents_status === 'waiting' ? '#fff3cd' : '#f8f9fa',
                                  color: 
                                    carrier.documents_status === 'received' ? '#155724' : 
                                    carrier.documents_status === 'waiting' ? '#856404' : '#6c757d',
                                  cursor: 'pointer',
                                  minWidth: '100px'
                                }}
                              >
                                <option value="not_received">Negauta</option>
                                <option value="waiting">Laukiama</option>
                                <option value="received">Gauta</option>
                              </select>
                            </div>
                          </div>
                        </div>
                        
                        {carrier.notes && (
                          <div style={{ marginTop: '8px', padding: '6px', backgroundColor: '#f8f9fa', borderRadius: '4px', fontSize: '11px', color: '#495057' }}>
                            <strong>Pastabos:</strong> {carrier.notes}
                          </div>
                        )}
                        
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '4px', marginTop: '8px' }}>
                          {carrier.invoice_received && carrier.id && carrierPurchaseInvoices[carrier.id] && carrierPurchaseInvoices[carrier.id].length > 0 && (
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '4px', marginBottom: '4px' }}>
                              {carrierPurchaseInvoices[carrier.id].map((inv) => (
                                <button
                                  key={inv.id}
                                  onClick={async (e) => {
                                    e.stopPropagation();
                                    try {
                                      const response = await api.get(`/invoices/purchase/${inv.id}/`);
                                      setSelectedPurchaseInvoice(response.data);
                                      setShowPurchaseInvoiceDetails(true);
                                    } catch (error: any) {
                                      showToast('error', 'Klaida užkraunant sąskaitą: ' + (error.response?.data?.detail || error.message));
                                    }
                                  }}
                                  style={{
                                    padding: '4px 8px',
                                    backgroundColor: '#007bff',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '4px',
                                    cursor: 'pointer',
                                    fontSize: '11px',
                                    fontWeight: 600,
                                    display: 'flex',
                                    justifyContent: 'space-between'
                                  }}
                                >
                                  <span>📄 {inv.received_invoice_number || inv.invoice_number || `ID: ${inv.id}`}</span>
                                  <span style={{ opacity: 0.9 }}>{parseFloat(inv.amount_total).toFixed(2)} €</span>
                                </button>
                              ))}
                            </div>
                          )}
                          {!carrier.invoice_received && (
                            <button
                              onClick={(e) => {
                                e.stopPropagation();
                                window.location.href = `/invoices?create_purchase=true&order_carrier_id=${carrier.id}&order_id=${selectedOrder.id}&partner_id=${carrier.partner.id}&amount_net=${carrier.price_net || 0}`;
                              }}
                              style={{
                                padding: '4px 8px',
                                backgroundColor: '#28a745',
                                color: 'white',
                                border: 'none',
                                borderRadius: '4px',
                                cursor: 'pointer',
                                fontSize: '11px',
                                fontWeight: '600'
                              }}
                            >
                              📄 Sukurti pirkimo sąskaitą
                            </button>
                          )}
                        </div>
                      </div>
                    ))}
                    </div>
                  ) : (
                    <div style={{ padding: '12px', textAlign: 'center', color: '#999', backgroundColor: '#fafafa', borderRadius: '4px', fontSize: '12px' }}>
                      Nėra pridėtų vežėjų arba sandėlių
                    </div>
                  )}
                </div>
              </div>

              {/* Pastabos */}
              {selectedOrder.notes && (
                <div style={{ marginTop: '12px', border: '1px solid #dee2e6', borderRadius: '4px', padding: '10px', backgroundColor: '#fff' }}>
                  <h4 style={{ margin: '0 0 8px 0', fontSize: '14px', fontWeight: 'bold', color: '#495057' }}>Pastabos</h4>
                  <p style={{ margin: 0, fontSize: '13px', whiteSpace: 'pre-wrap', lineHeight: '1.5' }}>{selectedOrder.notes}</p>
                </div>
              )}

              {/* Statuso istorija */}
              <div style={{ marginTop: '20px', paddingTop: '15px', borderTop: '1px solid #dee2e6' }}>
                <h4 style={{ margin: '0 0 10px 0', fontSize: '14px', fontWeight: 'bold', color: '#495057' }}>📋 Statuso istorija</h4>
                {statusHistory.length > 0 ? (
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                    {statusHistory.map((history, index) => (
                      <div 
                        key={index}
                        style={{
                          border: '1px solid #dee2e6',
                          borderRadius: '4px',
                          padding: '10px',
                          backgroundColor: '#f8f9fa'
                        }}
                      >
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '4px' }}>
                          <span style={{ fontWeight: '600', fontSize: '12px', color: '#495057' }}>
                            {history.new_status_display || history.new_status}
                          </span>
                          <span style={{ fontSize: '11px', color: '#6c757d' }}>
                            {new Date(history.created_at).toLocaleString('lt-LT')}
                          </span>
                        </div>
                        {history.notes && (
                          <div style={{ fontSize: '11px', color: '#6c757d', marginTop: '4px' }}>
                            {history.notes}
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                ) : (
                  <div style={{ padding: '12px', textAlign: 'center', color: '#999', backgroundColor: '#fafafa', borderRadius: '4px', fontSize: '12px' }}>
                    Nėra statuso istorijos
                  </div>
                )}
              </div>
              </div>
            </div>
          </div>
        )}

        {/* Orders List */}
        {loading ? (
          <div>Kraunama...</div>
        ) : (
          <div style={{ overflowX: 'auto' }}>
            <table className="table">
              <thead>
                <tr>
                  <th>Sukūrimo data</th>
                  <th>Numeris</th>
                  <th>Klientas</th>
                  <th>Kliento kaina (be PVM)</th>
                  <th>Maršrutas</th>
                  <th>Vežėjas</th>
                  <th>Vežėjo kaina (be PVM)</th>
                  <th>Pelnas</th>
                  <th>Veiksmai</th>
                </tr>
              </thead>
              <tbody>
                {orders.length === 0 ? (
                  <tr>
                    <td colSpan={9} style={{ textAlign: 'center', padding: '20px' }}>
                      Užsakymų nerasta
                    </td>
                  </tr>
                ) : (
                  orders.map((order, index) => {
                    // Patikrinti ar klientui išrašyta sąskaita
                    const clientInvoiceIssued = (order.payment_status_info?.invoice_issued ?? order.client_invoice_issued) || !!order.first_sales_invoice;
                    
                    // Patikrinti ar vežėjui gauta sąskaita
                    // 0 = negauta, 1 = daliai gauta, 2 = visiems gauta
                    let carrierInvoiceStatus: 0 | 1 | 2 = 0;
                    let hasCarrierOverdue = false;
                    let maxCarrierOverdueDays = 0;
                    if (order.carriers && Array.isArray(order.carriers) && order.carriers.length > 0) {
                      const validCarriers = order.carriers.filter((c: any) => c && c.partner);
                      if (validCarriers.length > 0) {
                        const receivedCount = validCarriers.filter((c: any) => {
                          return c.invoice_received === true || c.invoice_received === 'true' || c.invoice_received === 1;
                        }).length;
                        
                        if (receivedCount === validCarriers.length) {
                          // Visiems gauta
                          carrierInvoiceStatus = 2;
                        } else if (receivedCount > 0) {
                          // Daliai gauta
                          carrierInvoiceStatus = 1;
                        } else {
                          // Nei vienam negauta
                          carrierInvoiceStatus = 0;
                        }
                        
                        // Patikrinti ar yra vėluojančių vežėjų sąskaitų
                        // Tikriname ir pagal payment_status_info, ir pagal due_date tiesiogiai
                        validCarriers.forEach((c: any) => {
                          let isOverdue = false;
                          let overdueDays = 0;
                          
                          // Pirma tikrinti payment_status_info (backend apskaičiuotas)
                          if (c.payment_status_info) {
                            if (c.payment_status_info.status === 'overdue' || (c.payment_status_info.overdue_days && c.payment_status_info.overdue_days > 0)) {
                              isOverdue = true;
                              overdueDays = c.payment_status_info.overdue_days || 0;
                            }
                          }
                          
                          // Jei payment_status_info nerodo overdue, bet yra due_date, patikrinti tiesiogiai
                          if (!isOverdue && c.due_date) {
                            const today = new Date();
                            today.setHours(0, 0, 0, 0);
                            const dueDate = new Date(c.due_date);
                            dueDate.setHours(0, 0, 0, 0);
                            
                            if (dueDate < today) {
                              isOverdue = true;
                              overdueDays = Math.floor((today.getTime() - dueDate.getTime()) / (1000 * 60 * 60 * 24));
                            }
                          }
                          
                          if (isOverdue) {
                            hasCarrierOverdue = true;
                            if (overdueDays > maxCarrierOverdueDays) {
                              maxCarrierOverdueDays = overdueDays;
                            }
                          }
                        });
                      }
                    }
                    
                    // Kliento kaina (be PVM)
                    const clientPriceNet = order.client_price_net || order.calculated_client_price_net || 0;
                    
                    // Vežėjo kaina (be PVM) - suma visų carriers kainų
                    const carrierPriceNet = order.carriers && Array.isArray(order.carriers) 
                      ? order.carriers.reduce((sum: number, c: any) => sum + (c.price_net ? parseFloat(String(c.price_net)) : 0), 0)
                      : 0;
                    
                    // Kitos išlaidos
                    const otherCosts = order.other_costs && Array.isArray(order.other_costs)
                      ? order.other_costs.reduce((sum: number, c: any) => {
                          const amount = typeof c === 'object' && c !== null && 'amount' in c 
                            ? (typeof c.amount === 'number' ? c.amount : parseFloat(String(c.amount)) || 0)
                            : 0;
                          return sum + amount;
                        }, 0)
                      : 0;
                    
                    // Pelnas: visada apskaičiuoti pagal formulę, kad būtų teisingas
                    // client_price - carrier_costs - other_costs
                    const profit = parseFloat(String(clientPriceNet)) - carrierPriceNet - otherCosts;
                    
                    // Maršrutas formatavimas
                    let routeDisplay = '';
                    if (order.route_from_country || order.route_from) {
                      const fromParts = [
                        order.route_from_country,
                        order.route_from_postal_code,
                        order.route_from_city,
                        order.route_from_address
                      ].filter(Boolean);
                      const toParts = [
                        order.route_to_country,
                        order.route_to_postal_code,
                        order.route_to_city,
                        order.route_to_address
                      ].filter(Boolean);
                      
                      if (fromParts.length > 0 || toParts.length > 0) {
                        routeDisplay = `${fromParts.join(', ') || order.route_from} → ${toParts.join(', ') || order.route_to}`;
                      } else {
                        routeDisplay = `${order.route_from || ''} → ${order.route_to || ''}`;
                      }
                    } else {
                      routeDisplay = `${order.route_from || ''} → ${order.route_to || ''}`;
                    }
                    
                    // Vežėjas
                    let carrierDisplay = '-';
                    if (order.carriers && Array.isArray(order.carriers) && order.carriers.length > 0) {
                      const validCarriers = order.carriers.filter((c: any) => c && c.partner);
                      if (validCarriers.length === 1) {
                        carrierDisplay = validCarriers[0].partner.name;
                      } else if (validCarriers.length > 1) {
                        carrierDisplay = `Keli vežėjai (${validCarriers.length})`;
                      }
                    } else if (order.carrier && order.carrier.name) {
                      carrierDisplay = order.carrier.name;
                    }
                    
                    // Mėnesių spalvų paletė (12 skirtingų spalvų)
                    const monthColors = [
                      '#3498db', // Sausis - mėlyna
                      '#e74c3c', // Vasaris - raudona
                      '#2ecc71', // Kovas - žalia
                      '#f39c12', // Balandis - oranžinė
                      '#9b59b6', // Gegužė - violetinė
                      '#1abc9c', // Birželis - turkiz
                      '#e67e22', // Liepa - tamsi oranžinė
                      '#34495e', // Rugpjūtis - pilka
                      '#16a085', // Rugsėjis - tamsi turkiz
                      '#c0392b', // Spalis - tamsi raudona
                      '#8e44ad', // Lapkritis - tamsi violetinė
                      '#2980b9'  // Gruodis - tamsi mėlyna
                    ];
                    
                    // Nustatyti mėnesio spalvą pagal užsakymo datą
                    const currentDate = new Date(order.created_at);
                    const currentMonth = currentDate.getMonth(); // 0-11
                    const monthColor = monthColors[currentMonth];
                    
                    return (
                      <tr 
                        key={order.id}
                        onClick={() => handleViewOrder(order)}
                        style={{ 
                          cursor: 'pointer',
                          borderLeft: `4px solid ${monthColor}`
                        }}
                      >
                        <td>{new Date(order.created_at).toLocaleDateString('lt-LT')}</td>
                        <td>{order.order_number ? order.order_number : `#${order.id}`}</td>
                        <td>
                          <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                            <span>{order.client?.name || '-'}</span>
                            <span style={{ 
                              fontSize: '14px',
                              color: clientInvoiceIssued ? '#28a745' : '#dc3545'
                            }}>
                              {clientInvoiceIssued ? '✓' : '✗'}
                            </span>
                            {clientInvoiceIssued && (order.payment_status_info?.status === 'overdue' || (order.payment_status_info?.overdue_days && order.payment_status_info.overdue_days > 0) || order.has_overdue_invoices) && (
                              <span 
                                style={{ 
                                  fontSize: '14px',
                                  color: '#ffc107',
                                  cursor: 'help'
                                }}
                                title={`Sąskaita vėluojama apmokėti${order.payment_status_info?.overdue_days ? ` (${order.payment_status_info.overdue_days} d.)` : ''}`}
                              >
                                🕐
                              </span>
                            )}
                          </div>
                        </td>
                        <td>
                          <div style={{ display: 'flex', flexDirection: 'column' }}>
                            <div>{clientPriceNet ? parseFloat(String(clientPriceNet)).toFixed(2) : '0.00'} EUR</div>
                            {otherCosts > 0 && (
                              <div style={{ 
                                fontSize: '11px', 
                                color: '#666', 
                                marginTop: '2px' 
                              }}>
                                (+{otherCosts.toFixed(2)} EUR papild. išl.)
                              </div>
                            )}
                          </div>
                        </td>
                        <td style={{ fontSize: '12px' }}>{routeDisplay || '-'}</td>
                        <td>
                          <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                            <span>{carrierDisplay}</span>
                            <span style={{ 
                              fontSize: '14px',
                              color: carrierInvoiceStatus === 2 ? '#28a745' : carrierInvoiceStatus === 1 ? '#ffc107' : '#dc3545'
                            }}>
                              {carrierInvoiceStatus === 2 ? '✓' : carrierInvoiceStatus === 1 ? '⚠' : '✗'}
                            </span>
                            {hasCarrierOverdue && (
                              <span 
                                style={{ 
                                  fontSize: '14px',
                                  color: '#ffc107',
                                  cursor: 'help'
                                }}
                                title={`Sąskaita vėluojama apmokėti${maxCarrierOverdueDays > 0 ? ` (${maxCarrierOverdueDays} d.)` : ''}`}
                              >
                                🕐
                              </span>
                            )}
                          </div>
                        </td>
                        <td>{carrierPriceNet > 0 ? carrierPriceNet.toFixed(2) : '0.00'} EUR</td>
                        <td style={{ fontWeight: '500', color: profit >= 0 ? '#28a745' : '#dc3545' }}>
                          {profit.toFixed(2)} EUR
                        </td>
                        <td onClick={(e) => e.stopPropagation()} style={{ width: '200px', minWidth: '200px' }}>
                          <div style={{ 
                            display: 'flex', 
                            flexDirection: 'column',
                            gap: '3px'
                          }}>
                            {/* Pirma eilutė: Redaguoti + Statusas */}
                            <div style={{ 
                              display: 'flex', 
                              gap: '3px',
                              width: '100%'
                            }}>
                              <button
                                className="button button-secondary"
                                onClick={(e) => {
                                  e.stopPropagation();
                                  handleEditOrder(order);
                                }}
                                style={{ 
                                  padding: '4px 8px', 
                                  fontSize: '10px', 
                                  whiteSpace: 'nowrap',
                                  flex: '1',
                                  fontWeight: '500',
                                  borderRadius: '3px',
                                  border: '1px solid #ccc',
                                  backgroundColor: '#f8f9fa',
                                  color: '#333',
                                  cursor: 'pointer',
                                  transition: 'all 0.2s ease',
                                  boxSizing: 'border-box'
                                }}
                                onMouseEnter={(e) => {
                                  e.currentTarget.style.backgroundColor = '#e9ecef';
                                  e.currentTarget.style.borderColor = '#999';
                                }}
                                onMouseLeave={(e) => {
                                  e.currentTarget.style.backgroundColor = '#f8f9fa';
                                  e.currentTarget.style.borderColor = '#ccc';
                                }}
                                title="Redaguoti užsakymą"
                              >
                                ✏️ Red.
                              </button>
                              <select
                                value={order.status}
                                onChange={(e) => handleChangeStatus(order.id, e.target.value)}
                                onClick={(e) => e.stopPropagation()}
                                style={{ 
                                  fontSize: '10px', 
                                  padding: '4px 6px', 
                                  border: '1px solid #ccc', 
                                  borderRadius: '3px',
                                  cursor: 'pointer',
                                  flex: '1',
                                  backgroundColor: '#fff',
                                  fontWeight: '500',
                                  transition: 'all 0.2s ease',
                                  boxSizing: 'border-box'
                                }}
                                onMouseEnter={(e) => {
                                  e.currentTarget.style.borderColor = '#999';
                                }}
                                onMouseLeave={(e) => {
                                  e.currentTarget.style.borderColor = '#ccc';
                                }}
                              >
                                <option value="new">Naujas</option>
                                <option value="assigned">Priskirtas</option>
                                <option value="executing">Vykdomas</option>
                                <option value="waiting_for_docs">Laukiama Dokumentų</option>
                                <option value="finished">Baigtas</option>
                                <option value="canceled">Atšauktas</option>
                              </select>
                            </div>
                            {/* Antra eilutė: Peržiūrėti, PDF, Trinti */}
                            <div style={{ 
                              display: 'flex', 
                              gap: '3px',
                              width: '100%'
                            }}>
                              <button
                                className="button button-secondary"
                                onClick={async (e) => {
                                  e.stopPropagation();
                                  try {
                                    const response = await api.get(`/orders/orders/${order.id}/preview/`, {
                                      responseType: 'text',
                                    });
                                    const newWindow = window.open('', '_blank');
                                    if (newWindow) {
                                      newWindow.document.write(response.data);
                                      newWindow.document.close();
                                    }
                                  } catch (error: any) {
                                    showToast('error', 'Nepavyko atidaryti peržiūros');
                                  }
                                }}
                                style={{ 
                                  padding: '4px 8px', 
                                  fontSize: '10px', 
                                  whiteSpace: 'nowrap',
                                  flex: '1',
                                  fontWeight: '500',
                                  borderRadius: '3px',
                                  border: '1px solid #17a2b8',
                                  backgroundColor: '#17a2b8',
                                  color: 'white',
                                  cursor: 'pointer',
                                  transition: 'all 0.2s ease',
                                  boxSizing: 'border-box'
                                }}
                                onMouseEnter={(e) => {
                                  e.currentTarget.style.backgroundColor = '#138496';
                                  e.currentTarget.style.borderColor = '#117a8b';
                                }}
                                onMouseLeave={(e) => {
                                  e.currentTarget.style.backgroundColor = '#17a2b8';
                                  e.currentTarget.style.borderColor = '#17a2b8';
                                }}
                                title="Peržiūrėti sutartį"
                              >
                                👁️
                              </button>
                              <button
                                className="button button-secondary"
                                onClick={async (e) => {
                                  e.stopPropagation();
                                  try {
                                    const response = await api.get(`/orders/orders/${order.id}/pdf/`, {
                                      responseType: 'blob',
                                    });
                                    const blob = new Blob([response.data], { type: 'application/pdf' });
                                    const blobUrl = URL.createObjectURL(blob);
                                    const link = document.createElement('a');
                                    link.href = blobUrl;
                                    link.download = `uzsakymas-${order.order_number || order.id}.pdf`;
                                    document.body.appendChild(link);
                                    link.click();
                                    document.body.removeChild(link);
                                    URL.revokeObjectURL(blobUrl);
                                    showToast('success', 'PDF sėkmingai atsisiųstas');
                                  } catch (error: any) {
                                    showToast('error', 'Nepavyko atsisiųsti PDF');
                                  }
                                }}
                                style={{ 
                                  padding: '4px 8px', 
                                  fontSize: '10px', 
                                  backgroundColor: '#28a745', 
                                  color: 'white', 
                                  border: '1px solid #28a745',
                                  whiteSpace: 'nowrap',
                                  flex: '1',
                                  fontWeight: '500',
                                  borderRadius: '3px',
                                  cursor: 'pointer',
                                  transition: 'all 0.2s ease',
                                  boxSizing: 'border-box'
                                }}
                                onMouseEnter={(e) => {
                                  e.currentTarget.style.backgroundColor = '#218838';
                                  e.currentTarget.style.borderColor = '#1e7e34';
                                }}
                                onMouseLeave={(e) => {
                                  e.currentTarget.style.backgroundColor = '#28a745';
                                  e.currentTarget.style.borderColor = '#28a745';
                                }}
                                title="Atsisiųsti PDF"
                              >
                                📄
                              </button>
                              <button
                                className="button button-secondary"
                                onClick={(e) => {
                                  e.stopPropagation();
                                  handleDeleteOrder(order.id);
                                }}
                                style={{
                                  padding: '4px 8px',
                                  fontSize: '10px',
                                  backgroundColor: '#dc3545',
                                  color: 'white',
                                  border: '1px solid #dc3545',
                                  whiteSpace: 'nowrap',
                                  flex: '1',
                                  fontWeight: '500',
                                  borderRadius: '3px',
                                  cursor: 'pointer',
                                  transition: 'all 0.2s ease',
                                  boxSizing: 'border-box'
                                }}
                                onMouseEnter={(e) => {
                                  e.currentTarget.style.backgroundColor = '#c82333';
                                  e.currentTarget.style.borderColor = '#bd2130';
                                }}
                                onMouseLeave={(e) => {
                                  e.currentTarget.style.backgroundColor = '#dc3545';
                                  e.currentTarget.style.borderColor = '#dc3545';
                                }}
                                title="Ištrinti užsakymą"
                              >
                                🗑️
                              </button>
                            </div>
                          </div>
                        </td>
                      </tr>
                    );
                  })
                )}
              </tbody>
            </table>
            
            {/* Puslapiavimas */}
            {totalPages > 1 && (
              <div style={{
                display: 'flex',
                justifyContent: 'center',
                alignItems: 'center',
                gap: '10px',
                marginTop: '20px',
                padding: '15px',
                backgroundColor: '#f8f9fa',
                borderRadius: '8px'
              }}>
                <button
                  className="button"
                  onClick={() => setCurrentPage(prev => Math.max(1, prev - 1))}
                  disabled={currentPage === 1}
                  style={{
                    padding: '8px 16px',
                    fontSize: '14px',
                    opacity: currentPage === 1 ? 0.5 : 1,
                    cursor: currentPage === 1 ? 'not-allowed' : 'pointer'
                  }}
                >
                  ← Ankstesnis
                </button>
                
                <div style={{ display: 'flex', gap: '5px', alignItems: 'center' }}>
                  <span style={{ fontSize: '14px', color: '#666', marginRight: '5px' }}>
                    Puslapis:
                  </span>
                  {Array.from({ length: Math.min(10, totalPages) }, (_, i) => {
                    let pageNum: number;
                    if (totalPages <= 10) {
                      pageNum = i + 1;
                    } else if (currentPage <= 5) {
                      pageNum = i + 1;
                    } else if (currentPage >= totalPages - 4) {
                      pageNum = totalPages - 9 + i;
                    } else {
                      pageNum = currentPage - 5 + i;
                    }
                    
                    return (
                      <button
                        key={pageNum}
                        onClick={() => setCurrentPage(pageNum)}
                        style={{
                          padding: '6px 12px',
                          fontSize: '14px',
                          border: '1px solid #dee2e6',
                          borderRadius: '4px',
                          backgroundColor: currentPage === pageNum ? '#007bff' : 'white',
                          color: currentPage === pageNum ? 'white' : '#333',
                          cursor: 'pointer',
                          minWidth: '40px'
                        }}
                      >
                        {pageNum}
                      </button>
                    );
                  })}
                  {totalPages > 10 && (
                    <span style={{ fontSize: '14px', color: '#666', marginLeft: '5px' }}>
                      ... {totalPages}
                    </span>
                  )}
                </div>
                
                <button
                  className="button"
                  onClick={() => setCurrentPage(prev => Math.min(totalPages, prev + 1))}
                  disabled={currentPage === totalPages}
                  style={{
                    padding: '8px 16px',
                    fontSize: '14px',
                    opacity: currentPage === totalPages ? 0.5 : 1,
                    cursor: currentPage === totalPages ? 'not-allowed' : 'pointer'
                  }}
                >
                  Kitas →
                </button>
              </div>
            )}
          </div>
        )}

        {/* Status History Modal */}
        {showStatusHistory && (
          <div className="modal-overlay" onClick={() => setShowStatusHistory(null)}>
            <div className="modal-content" onClick={(e) => e.stopPropagation()} style={{ maxWidth: '600px' }}>
              <h2>Užsakymo #{showStatusHistory} statuso istorija</h2>
              {statusHistory.length === 0 ? (
                <p>Istorijos nėra</p>
              ) : (
                <table className="table">
                  <thead>
                    <tr>
                      <th>Data</th>
                      <th>Nuo</th>
                      <th>Į</th>
                      <th>Pakeitė</th>
                      <th>Pastabos</th>
                    </tr>
                  </thead>
                  <tbody>
                    {statusHistory.map((history) => (
                      <tr key={history.id}>
                        <td>{new Date(history.created_at).toLocaleString('lt-LT')}</td>
                        <td>
                          <span className={`badge ${getStatusColor(history.old_status)}`}>
                            {history.old_status}
                          </span>
                        </td>
                        <td>
                          <span className={`badge ${getStatusColor(history.new_status)}`}>
                            {history.new_status}
                          </span>
                        </td>
                        <td>{history.changed_by.username}</td>
                        <td>{history.notes || '-'}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              )}
              <button
                className="button button-secondary"
                onClick={() => setShowStatusHistory(null)}
                style={{ marginTop: '20px' }}
              >
                Uždaryti
              </button>
            </div>
          </div>
        )}

        {/* Route Map Modal */}
        {mapRouteData && (
          <div className="modal-overlay" onClick={() => setShowRouteMap(false)}>
            <div className="modal-content" onClick={(e) => e.stopPropagation()} style={{ maxWidth: '90vw', maxHeight: '90vh', width: '1200px', height: '800px', display: 'flex', flexDirection: 'column' }}>
              <div className="modal-header" style={{ padding: '12px 20px', borderBottom: '1px solid #dee2e6', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600' }}>
                  Maršrutas: {mapRouteData.fromDisplay} → {mapRouteData.toDisplay}
                </h2>
                <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                  <a
                    href={`https://www.google.com/maps/dir/${encodeURIComponent(mapRouteData.from)}/${encodeURIComponent(mapRouteData.to)}`}
                    target="_blank"
                    rel="noopener noreferrer"
                    style={{
                      padding: '6px 12px',
                      fontSize: '12px',
                      backgroundColor: '#28a745',
                      color: 'white',
                      textDecoration: 'none',
                      borderRadius: '4px',
                      display: 'inline-flex',
                      alignItems: 'center',
                      gap: '4px'
                    }}
                  >
                    🔗 Atidaryti Google Maps
                  </a>
                  <button
                    className="button button-secondary"
                    onClick={() => setShowRouteMap(false)}
                    style={{ padding: '6px 12px', fontSize: '13px' }}
                  >
                    ✕ Uždaryti
                  </button>
                </div>
              </div>
              <div style={{ flex: 1, overflow: 'hidden', position: 'relative', backgroundColor: '#f5f5f5', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                <iframe
                  title={`Maršrutas nuo ${mapRouteData.fromDisplay} iki ${mapRouteData.toDisplay}`}
                  width="100%"
                  height="100%"
                  style={{ border: 0 }}
                  loading="lazy"
                  allowFullScreen
                  referrerPolicy="no-referrer-when-downgrade"
                  src={`https://www.google.com/maps/embed/v1/directions?key=${process.env.REACT_APP_GOOGLE_MAPS_API_KEY || ''}&origin=${encodeURIComponent(mapRouteData.from)}&destination=${encodeURIComponent(mapRouteData.to)}&zoom=7`}
                  onError={() => {
                    // Jei embed neveikia (be API key), rodyti alternatyvų variantą
                  }}
                />
                {!process.env.REACT_APP_GOOGLE_MAPS_API_KEY && (
                  <div style={{ 
                    position: 'absolute', 
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    backgroundColor: 'rgba(255,255,255,0.95)',
                    flexDirection: 'column',
                    gap: '15px',
                    padding: '20px'
                  }}>
                    <p style={{ margin: 0, fontSize: '16px', textAlign: 'center' }}>
                      <strong>🗺️ Žemėlapio peržiūrai reikalingas Google Maps API raktas</strong>
                    </p>
                    <p style={{ margin: 0, fontSize: '14px', color: '#666', textAlign: 'center' }}>
                      Maršrutas: <strong>{mapRouteData.fromDisplay} → {mapRouteData.toDisplay}</strong>
                    </p>
                    <a
                      href={`https://www.google.com/maps/dir/${encodeURIComponent(mapRouteData.from)}/${encodeURIComponent(mapRouteData.to)}`}
                      target="_blank"
                      rel="noopener noreferrer"
                      style={{
                        padding: '12px 24px',
                        fontSize: '14px',
                        backgroundColor: '#007bff',
                        color: 'white',
                        textDecoration: 'none',
                        borderRadius: '4px',
                        display: 'inline-block',
                        fontWeight: 'bold'
                      }}
                    >
                      🔗 Atidaryti Google Maps su maršrutu naujame lange
                    </a>
                    <p style={{ margin: 0, fontSize: '12px', color: '#999', textAlign: 'center', marginTop: '10px' }}>
                      Arba pridėkite REACT_APP_GOOGLE_MAPS_API_KEY į .env failą žemėlapio peržiūrai modale
                    </p>
                  </div>
                )}
              </div>
            </div>
          </div>
        )}

        {/* Purchase Invoice Details Modal */}
        {showPurchaseInvoiceDetails && selectedPurchaseInvoice && (
          <div className="modal-overlay" onClick={() => setShowPurchaseInvoiceDetails(false)}>
            <div className="modal-content modal-large" onClick={(e) => e.stopPropagation()}>
              <div className="modal-header">
                <h2>Sąskaita #{selectedPurchaseInvoice.received_invoice_number}</h2>
                <button className="modal-close" onClick={() => setShowPurchaseInvoiceDetails(false)}>×</button>
              </div>
              <div className="invoice-details">
                <div className="details-section">
                  <h3>Pagrindinė informacija</h3>
                  <div className="details-grid">
                    <div><strong>Tiekėjo sąskaitos numeris:</strong> {selectedPurchaseInvoice.received_invoice_number}</div>
                    {selectedPurchaseInvoice.invoice_number && (
                      <div><strong>Sistemos sąskaitos numeris:</strong> {selectedPurchaseInvoice.invoice_number}</div>
                    )}
                    <div>
                      <strong>Mokėjimo statusas:</strong>
                      <select
                        value={selectedPurchaseInvoice.payment_status}
                        onChange={async (e) => {
                          try {
                            const updateData: any = { payment_status: e.target.value };
                            // Jei statusas keičiamas į 'paid', ir nėra payment_date, nustatyti šiandienos datą
                            if (e.target.value === 'paid' && !selectedPurchaseInvoice.payment_date) {
                              updateData.payment_date = new Date().toISOString().split('T')[0];
                            }
                            // Jei statusas keičiamas iš 'paid', išvalyti payment_date
                            if (e.target.value !== 'paid' && selectedPurchaseInvoice.payment_status === 'paid') {
                              updateData.payment_date = null;
                            }
                            await api.patch(`/invoices/purchase/${selectedPurchaseInvoice.id}/`, updateData);
                            showToast('success', 'Mokėjimo statusas atnaujintas');
                            // Atnaujinti sąskaitą
                            const response = await api.get(`/invoices/purchase/${selectedPurchaseInvoice.id}/`);
                            setSelectedPurchaseInvoice(response.data);
                            // Atnaujinti užsakymo duomenis, kad būtų atnaujinta sąskaitų būsena
                            if (selectedOrder) {
                              const orderResponse = await api.get(`/orders/orders/${selectedOrder.id}/`);
                              setSelectedOrder(orderResponse.data);
                            }
                          } catch (error: any) {
                            showToast('error', error.response?.data?.error || 'Klaida atnaujinant mokėjimo statusą');
                          }
                        }}
                        onClick={(e) => e.stopPropagation()}
                        style={{
                          marginLeft: '8px',
                          padding: '4px 8px',
                          borderRadius: '4px',
                          border: '1px solid #dee2e6',
                          fontSize: '13px',
                          cursor: 'pointer',
                          backgroundColor: selectedPurchaseInvoice.payment_status === 'paid' ? '#d4edda' : 
                            selectedPurchaseInvoice.payment_status === 'overdue' ? '#f8d7da' : 
                            selectedPurchaseInvoice.payment_status === 'partially_paid' ? '#fff3cd' : '#fff',
                          color: selectedPurchaseInvoice.payment_status === 'paid' ? '#155724' : 
                            selectedPurchaseInvoice.payment_status === 'overdue' ? '#721c24' : 
                            selectedPurchaseInvoice.payment_status === 'partially_paid' ? '#856404' : '#333'
                        }}
                      >
                        <option value="unpaid">Neapmokėta</option>
                        <option value="paid">Apmokėta</option>
                        <option value="overdue">Vėluoja</option>
                        <option value="partially_paid">Dalinis apmokėjimas</option>
                      </select>
                    </div>
                    <div><strong>Tiekėjas:</strong> {selectedPurchaseInvoice.partner.name}</div>
                    {selectedPurchaseInvoice.related_order && (
                      <div><strong>Susijęs užsakymas:</strong> {selectedPurchaseInvoice.related_order.order_number || `#${selectedPurchaseInvoice.related_order.id}`}</div>
                    )}
                    {selectedPurchaseInvoice.expense_category && (
                      <div><strong>Išlaidų kategorija:</strong> {selectedPurchaseInvoice.expense_category.name}</div>
                    )}
                  </div>
                </div>
                
                <div className="details-section">
                  <h3>Finansinė informacija</h3>
                  <div className="details-grid">
                    <div><strong>Suma be PVM:</strong> {parseFloat(selectedPurchaseInvoice.amount_net).toFixed(2)} €</div>
                    <div><strong>PVM ({selectedPurchaseInvoice.vat_rate}%):</strong> {(parseFloat(selectedPurchaseInvoice.amount_total) - parseFloat(selectedPurchaseInvoice.amount_net)).toFixed(2)} €</div>
                    <div><strong>Suma su PVM:</strong> {parseFloat(selectedPurchaseInvoice.amount_total).toFixed(2)} €</div>
                  </div>
                </div>
                
                <div className="details-section">
                  <h3>Datų informacija</h3>
                  <div className="details-grid">
                    <div><strong>Tiekėjo sąskaitos išrašymo data:</strong> {selectedPurchaseInvoice.issue_date}</div>
                    <div><strong>Gavimo data:</strong> {selectedPurchaseInvoice.received_date || '-'}</div>
                    <div><strong>Mokėjimo terminas:</strong> {selectedPurchaseInvoice.due_date}</div>
                    <div>
                      <strong>Mokėjimo data:</strong>
                      <input
                        type="date"
                        value={selectedPurchaseInvoice.payment_date || ''}
                        onChange={async (e) => {
                          try {
                            await api.patch(`/invoices/purchase/${selectedPurchaseInvoice.id}/`, {
                              payment_date: e.target.value || null,
                              // Jei nustatoma payment_date, automatiškai nustatyti payment_status į 'paid'
                              ...(e.target.value && selectedPurchaseInvoice.payment_status !== 'paid' ? { payment_status: 'paid' } : {})
                            });
                            showToast('success', 'Mokėjimo data atnaujinta');
                            // Atnaujinti sąskaitą
                            const response = await api.get(`/invoices/purchase/${selectedPurchaseInvoice.id}/`);
                            setSelectedPurchaseInvoice(response.data);
                            // Atnaujinti užsakymo duomenis
                            if (selectedOrder) {
                              const orderResponse = await api.get(`/orders/orders/${selectedOrder.id}/`);
                              setSelectedOrder(orderResponse.data);
                            }
                          } catch (error: any) {
                            showToast('error', error.response?.data?.error || 'Klaida atnaujinant mokėjimo datą');
                          }
                        }}
                        onClick={(e) => e.stopPropagation()}
                        style={{
                          marginLeft: '8px',
                          padding: '4px 8px',
                          borderRadius: '4px',
                          border: '1px solid #dee2e6',
                          fontSize: '13px',
                          cursor: 'pointer'
                        }}
                      />
                    </div>
                    {selectedPurchaseInvoice.overdue_days > 0 && (
                      <div><strong>Vėlavimo dienos:</strong> <span className="overdue-badge">{selectedPurchaseInvoice.overdue_days} dienos</span></div>
                    )}
                  </div>
                </div>
                
                {(selectedPurchaseInvoice.invoice_file_url || selectedPurchaseInvoice.invoice_file) && (
                  <div className="details-section">
                    <h3>Sąskaitos failas</h3>
                    <div>
                      <a 
                        href={selectedPurchaseInvoice.invoice_file_url || `${process.env.REACT_APP_API_URL?.replace('/api', '') || 'http://192.168.9.11:8000'}/${selectedPurchaseInvoice.invoice_file}`} 
                        target="_blank" 
                        rel="noopener noreferrer"
                        className="btn btn-secondary"
                      >
                        📄 Peržiūrėti PDF
                      </a>
                    </div>
                  </div>
                )}
                
                {selectedPurchaseInvoice.notes && (
                  <div className="details-section">
                    <h3>Pastabos</h3>
                    <p>{selectedPurchaseInvoice.notes}</p>
                  </div>
                )}
              </div>
              <div className="modal-footer">
                <button className="btn btn-secondary" onClick={() => setShowPurchaseInvoiceDetails(false)}>
                  Užverti
                </button>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default OrdersPage;
